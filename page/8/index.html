<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">


<link rel="stylesheet" href="/blog/lib/font-awesome/css/all.min.css">
<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.iflyresearch.com","root":"/blog/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="JadePeng的技术笔记本">
<meta property="og:type" content="website">
<meta property="og:title" content="JadePeng的技术笔记本">
<meta property="og:url" content="http://blog.iflyresearch.com/page/8/index.html">
<meta property="og:site_name" content="JadePeng的技术笔记本">
<meta property="og:description" content="JadePeng的技术笔记本">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="JadePeng">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://blog.iflyresearch.com/page/8/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>JadePeng的技术笔记本</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">JadePeng的技术笔记本</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">爱学习爱分享</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-博客">

    <a href="/blog/categories/%E5%8D%9A%E5%AE%A2/" rel="section"><i class="fa fa-th fa-fw"></i>博客</a>

  </li>
        <li class="menu-item menu-item-分类">

    <a href="/blog/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/blog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.iflyresearch.com/2018/06/06/jqpeng-Spring%20Security%20%E6%9E%B6%E6%9E%84%E4%B8%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="JadePeng">
      <meta itemprop="description" content="JadePeng的技术笔记本">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JadePeng的技术笔记本">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2018/06/06/jqpeng-Spring%20Security%20%E6%9E%B6%E6%9E%84%E4%B8%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">Spring Security 架构与源码分析</a>
        </h2>

        <div class="post-meta">

         
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-06-06 16:03:00" itemprop="dateCreated datePublished" datetime="2018-06-06T16:03:00+08:00">2018-06-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 17:44:20" itemprop="dateModified" datetime="2021-05-14T17:44:20+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%8D%9A%E5%AE%A2/" itemprop="url" rel="index"><span itemprop="name">博客</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%8D%9A%E5%AE%A2/jqpeng/" itemprop="url" rel="index"><span itemprop="name">jqpeng</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>18k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>17 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>文章作者:jqpeng<br>原文链接: <a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaoqi/p/spring-security.html">Spring Security 架构与源码分析</a></p>
<p>Spring Security 主要实现了Authentication（认证，解决who are you? ） 和 Access Control（访问控制，也就是what are you allowed to do？，也称为Authorization）。Spring Security在架构上将认证与授权分离，并提供了扩展点。</p>
<h2 id="核心对象"><a href="#核心对象" class="headerlink" title="核心对象"></a>核心对象</h2><p>主要代码在<code>spring-security-core</code>包下面。要了解Spring Security，需要先关注里面的核心对象。</p>
<h3 id="SecurityContextHolder-SecurityContext-和-Authentication"><a href="#SecurityContextHolder-SecurityContext-和-Authentication" class="headerlink" title="SecurityContextHolder, SecurityContext 和 Authentication"></a>SecurityContextHolder, SecurityContext 和 Authentication</h3><p>SecurityContextHolder 是 SecurityContext的存放容器，默认使用ThreadLocal 存储，意味SecurityContext在相同线程中的方法都可用。<br> SecurityContext主要是存储应用的principal信息，在Spring Security中用Authentication 来表示。</p>
<p>获取principal：</p>
<pre><code>Object principal = SecurityContextHolder.getContext().getAuthentication().getPrincipal();

if (principal instanceof UserDetails) &#123;
String username = ((UserDetails)principal).getUsername();
&#125; else &#123;
String username = principal.toString();
&#125;
</code></pre>
<p>在Spring Security中，可以看一下Authentication定义：</p>
<pre><code>public interface Authentication extends Principal, Serializable &#123;
Collection&lt;? extends GrantedAuthority&gt; getAuthorities();
/** * 通常是密码 */Object getCredentials();
/** * Stores additional details about the authentication request. These might be an IP * address, certificate serial number etc. */Object getDetails();
/** * 用来标识是否已认证，如果使用用户名和密码登录,通常是用户名  */Object getPrincipal();
/** * 是否已认证 */boolean isAuthenticated();
void setAuthenticated(boolean isAuthenticated) throws IllegalArgumentException;
&#125;
</code></pre>
<p>在实际应用中，通常使用<code>UsernamePasswordAuthenticationToken</code>：</p>
<pre><code>public abstract class AbstractAuthenticationToken implements Authentication,    CredentialsContainer &#123;    &#125;
public class UsernamePasswordAuthenticationToken extends AbstractAuthenticationToken &#123;
&#125;
</code></pre>
<p>一个常见的认证过程通常是这样的，创建一个UsernamePasswordAuthenticationToken，然后交给authenticationManager认证（后面详细说明），认证通过则通过SecurityContextHolder存放Authentication信息。</p>
<pre><code> UsernamePasswordAuthenticationToken authenticationToken =
            new UsernamePasswordAuthenticationToken(loginVM.getUsername(), loginVM.getPassword());

Authentication authentication = this.authenticationManager.authenticate(authenticationToken);
SecurityContextHolder.getContext().setAuthentication(authentication);
</code></pre>
<h3 id="UserDetails与UserDetailsService"><a href="#UserDetails与UserDetailsService" class="headerlink" title="UserDetails与UserDetailsService"></a>UserDetails与UserDetailsService</h3><p>UserDetails 是Spring Security里的一个关键接口，他用来表示一个principal。</p>
<pre><code>public interface UserDetails extends Serializable &#123;/** * 用户的授权信息，可以理解为角色 */Collection&lt;? extends GrantedAuthority&gt; getAuthorities();
/** * 用户密码 * * @return the password */String getPassword();
/** * 用户名  *     */String getUsername();
boolean isAccountNonExpired();
boolean isAccountNonLocked();
boolean isCredentialsNonExpired();
boolean isEnabled();
&#125;
</code></pre>
<p>UserDetails提供了认证所需的必要信息，在实际使用里，可以自己实现UserDetails，并增加额外的信息，比如email、mobile等信息。</p>
<p>在Authentication中的principal通常是用户名，我们可以通过UserDetailsService来通过principal获取UserDetails：</p>
<pre><code>public interface UserDetailsService &#123;UserDetails loadUserByUsername(String username) throws UsernameNotFoundException;
&#125;
</code></pre>
<h3 id="GrantedAuthority"><a href="#GrantedAuthority" class="headerlink" title="GrantedAuthority"></a>GrantedAuthority</h3><p>在UserDetails里说了，GrantedAuthority可以理解为角色，例如 <code>ROLE_ADMINISTRATOR</code> or <code>ROLE_HR_SUPERVISOR</code>。</p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><ul>
<li><code>SecurityContextHolder</code>, 用来访问 <code>SecurityContext</code>.</li>
<li><code>SecurityContext</code>, 用来存储<code>Authentication</code> .</li>
<li><code>Authentication</code>, 代表凭证.</li>
<li><code>GrantedAuthority</code>, 代表权限.</li>
<li><code>UserDetails</code>, 用户信息.</li>
<li><code>UserDetailsService</code>,获取用户信息.</li>
</ul>
<h2 id="Authentication认证"><a href="#Authentication认证" class="headerlink" title="Authentication认证"></a>Authentication认证</h2><h3 id="AuthenticationManager"><a href="#AuthenticationManager" class="headerlink" title="AuthenticationManager"></a>AuthenticationManager</h3><p>实现认证主要是通过AuthenticationManager接口，它只包含了一个方法：</p>
<pre><code>public interface AuthenticationManager &#123;
  Authentication authenticate(Authentication authentication)
    throws AuthenticationException;
&#125;
</code></pre>
<p>authenticate()方法主要做三件事：</p>
<ol>
<li>如果验证通过，返回Authentication（通常带上authenticated=true）。</li>
<li>认证失败抛出<code>AuthenticationException</code></li>
<li>如果无法确定，则返回null</li>
</ol>
<p><code>AuthenticationException</code>是运行时异常,它通常由应用程序按通用方式处理，用户代码通常不用特意被捕获和处理这个异常。</p>
<p><code>AuthenticationManager</code>的默认实现是<code>ProviderManager</code>，它委托一组<code>AuthenticationProvider</code>实例来实现认证。<br><code>AuthenticationProvider</code>和<code>AuthenticationManager</code>类似，都包含<code>authenticate</code>，但它有一个额外的方法<code>supports</code>，以允许查询调用方是否支持给定<code>Authentication</code>类型：</p>
<pre><code>public interface AuthenticationProvider &#123;
Authentication authenticate(Authentication authentication)        throws AuthenticationException;boolean supports(Class&lt;?&gt; authentication);
&#125;
</code></pre>
<p>ProviderManager包含一组<code>AuthenticationProvider</code>，执行authenticate时，遍历Providers，然后调用supports，如果支持，则执行遍历当前provider的authenticate方法，如果一个provider认证成功，则break。</p>
<pre><code>public Authentication authenticate(Authentication authentication)        throws AuthenticationException &#123;    Class&lt;? extends Authentication&gt; toTest = authentication.getClass();    AuthenticationException lastException = null;    Authentication result = null;    boolean debug = logger.isDebugEnabled();
    for (AuthenticationProvider provider : getProviders()) &#123;        if (!provider.supports(toTest)) &#123;            continue;        &#125;
        if (debug) &#123;            logger.debug(&quot;Authentication attempt using &quot;                    + provider.getClass().getName());        &#125;
        try &#123;            result = provider.authenticate(authentication);
            if (result != null) &#123;                copyDetails(authentication, result);                break;            &#125;        &#125;        catch (AccountStatusException e) &#123;            prepareException(e, authentication);            // SEC-546: Avoid polling additional providers if auth failure is due to            // invalid account status            throw e;        &#125;        catch (InternalAuthenticationServiceException e) &#123;            prepareException(e, authentication);            throw e;        &#125;        catch (AuthenticationException e) &#123;            lastException = e;        &#125;    &#125;
    if (result == null &amp;&amp; parent != null) &#123;        // Allow the parent to try.        try &#123;            result = parent.authenticate(authentication);        &#125;        catch (ProviderNotFoundException e) &#123;            // ignore as we will throw below if no other exception occurred prior to            // calling parent and the parent            // may throw ProviderNotFound even though a provider in the child already            // handled the request        &#125;        catch (AuthenticationException e) &#123;            lastException = e;        &#125;    &#125;
    if (result != null) &#123;        if (eraseCredentialsAfterAuthentication                &amp;&amp; (result instanceof CredentialsContainer)) &#123;            // Authentication is complete. Remove credentials and other secret data            // from authentication            ((CredentialsContainer) result).eraseCredentials();        &#125;
        eventPublisher.publishAuthenticationSuccess(result);        return result;    &#125;
    // Parent was null, or didn&#39;t authenticate (or throw an exception).
    if (lastException == null) &#123;        lastException = new ProviderNotFoundException(messages.getMessage(                &quot;ProviderManager.providerNotFound&quot;,                new Object[] &#123; toTest.getName() &#125;,                &quot;No AuthenticationProvider found for &#123;0&#125;&quot;));    &#125;
    prepareException(lastException, authentication);
    throw lastException;&#125;
</code></pre>
<p>从上面的代码可以看出， <code>ProviderManager</code>有一个可选parent，如果parent不为空，则调用<code>parent.authenticate(authentication)</code></p>
<h3 id="AuthenticationProvider"><a href="#AuthenticationProvider" class="headerlink" title="AuthenticationProvider"></a>AuthenticationProvider</h3><p><code>AuthenticationProvider</code>有多种实现，大家最关注的通常是<code>DaoAuthenticationProvider</code>，继承于<code>AbstractUserDetailsAuthenticationProvider</code>，核心是通过<code>UserDetails</code>来实现认证,<code>DaoAuthenticationProvider</code>默认会自动加载，不用手动配。</p>
<p>先来看<code>AbstractUserDetailsAuthenticationProvide</code>r，看最核心的<code>authenticate</code>：</p>
<pre><code>public Authentication authenticate(Authentication authentication)        throws AuthenticationException &#123;    // 必须是UsernamePasswordAuthenticationToken    Assert.isInstanceOf(UsernamePasswordAuthenticationToken.class, authentication,            messages.getMessage(                    &quot;AbstractUserDetailsAuthenticationProvider.onlySupports&quot;,                    &quot;Only UsernamePasswordAuthenticationToken is supported&quot;));
    //  获取用户名    String username = (authentication.getPrincipal() == null) ? &quot;NONE_PROVIDED&quot;            : authentication.getName();
    boolean cacheWasUsed = true;    // 从缓存获取    UserDetails user = this.userCache.getUserFromCache(username);
    if (user == null) &#123;        cacheWasUsed = false;
        try &#123;           // retrieveUser 抽象方法，获取用户            user = retrieveUser(username,                    (UsernamePasswordAuthenticationToken) authentication);        &#125;        catch (UsernameNotFoundException notFound) &#123;            logger.debug(&quot;User &#39;&quot; + username + &quot;&#39; not found&quot;);
            if (hideUserNotFoundExceptions) &#123;                throw new BadCredentialsException(messages.getMessage(                        &quot;AbstractUserDetailsAuthenticationProvider.badCredentials&quot;,                        &quot;Bad credentials&quot;));            &#125;            else &#123;                throw notFound;            &#125;        &#125;
          Assert.notNull(user,                &quot;retrieveUser returned null - a violation of the interface contract&quot;);    &#125;
    try &#123;        // 预先检查，DefaultPreAuthenticationChecks，检查用户是否被lock或者账号是否可用        preAuthenticationChecks.check(user);                // 抽象方法，自定义检验        additionalAuthenticationChecks(user,                (UsernamePasswordAuthenticationToken) authentication);    &#125;    catch (AuthenticationException exception) &#123;        if (cacheWasUsed) &#123;            // There was a problem, so try again after checking            // we&#39;re using latest data (i.e. not from the cache)            cacheWasUsed = false;            user = retrieveUser(username,                    (UsernamePasswordAuthenticationToken) authentication);            preAuthenticationChecks.check(user);            additionalAuthenticationChecks(user,                    (UsernamePasswordAuthenticationToken) authentication);        &#125;        else &#123;            throw exception;        &#125;    &#125;
          // 后置检查 DefaultPostAuthenticationChecks，检查isCredentialsNonExpired    postAuthenticationChecks.check(user);
    if (!cacheWasUsed) &#123;        this.userCache.putUserInCache(user);    &#125;
    Object principalToReturn = user;
    if (forcePrincipalAsString) &#123;        principalToReturn = user.getUsername();    &#125;
       return createSuccessAuthentication(principalToReturn, authentication, user);&#125;
</code></pre>
<p>上面的检验主要基于UserDetails实现，其中获取用户和检验逻辑由具体的类去实现，默认实现是DaoAuthenticationProvider，这个类的核心是让开发者提供UserDetailsService来获取UserDetails以及 PasswordEncoder来检验密码是否有效：</p>
<pre><code>private UserDetailsService userDetailsService;
private PasswordEncoder passwordEncoder;
</code></pre>
<p>看具体的实现，<code>retrieveUser</code>,直接调用userDetailsService获取用户：</p>
<pre><code>protected final UserDetails retrieveUser(String username,        UsernamePasswordAuthenticationToken authentication)        throws AuthenticationException &#123;    UserDetails loadedUser;
    try &#123;        loadedUser = this.getUserDetailsService().loadUserByUsername(username);    &#125;    catch (UsernameNotFoundException notFound) &#123;        if (authentication.getCredentials() != null) &#123;            String presentedPassword = authentication.getCredentials().toString();            passwordEncoder.isPasswordValid(userNotFoundEncodedPassword,                    presentedPassword, null);        &#125;        throw notFound;    &#125;    catch (Exception repositoryProblem) &#123;        throw new InternalAuthenticationServiceException(                repositoryProblem.getMessage(), repositoryProblem);    &#125;
    if (loadedUser == null) &#123;        throw new InternalAuthenticationServiceException(                &quot;UserDetailsService returned null, which is an interface contract violation&quot;);    &#125;    return loadedUser;&#125;
</code></pre>
<p>再来看验证：</p>
<pre><code>protected void additionalAuthenticationChecks(UserDetails userDetails,        UsernamePasswordAuthenticationToken authentication)        throws AuthenticationException &#123;    Object salt = null;
    if (this.saltSource != null) &#123;        salt = this.saltSource.getSalt(userDetails);    &#125;
    if (authentication.getCredentials() == null) &#123;        logger.debug(&quot;Authentication failed: no credentials provided&quot;);
        throw new BadCredentialsException(messages.getMessage(                &quot;AbstractUserDetailsAuthenticationProvider.badCredentials&quot;,                &quot;Bad credentials&quot;));    &#125;
        // 获取用户密码    String presentedPassword = authentication.getCredentials().toString();
        // 比较passwordEncoder后的密码是否和userdetails的密码一致    if (!passwordEncoder.isPasswordValid(userDetails.getPassword(),            presentedPassword, salt)) &#123;        logger.debug(&quot;Authentication failed: password does not match stored value&quot;);
        throw new BadCredentialsException(messages.getMessage(                &quot;AbstractUserDetailsAuthenticationProvider.badCredentials&quot;,                &quot;Bad credentials&quot;));    &#125;&#125;
</code></pre>
<p>小结：要自定义认证，使用DaoAuthenticationProvider，只需要为其提供PasswordEncoder和UserDetailsService就可以了。</p>
<h3 id="定制-Authentication-Managers"><a href="#定制-Authentication-Managers" class="headerlink" title="定制 Authentication Managers"></a>定制 Authentication Managers</h3><p>Spring Security提供了一个Builder类<code>AuthenticationManagerBuilder</code>，借助它可以快速实现自定义认证。</p>
<p>看官方源码说明：</p>
<blockquote>
<p>SecurityBuilder used to create an AuthenticationManager . Allows for easily building in memory authentication, LDAP authentication, JDBC based authentication, adding UserDetailsService , and adding AuthenticationProvider’s.</p>
</blockquote>
<p>AuthenticationManagerBuilder可以用来Build一个AuthenticationManager，可以创建基于内存的认证、LDAP认证、 JDBC认证，以及添加UserDetailsService和AuthenticationProvider。</p>
<p>简单使用：</p>
<pre><code>@Configuration
@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true)
public class ApplicationSecurity extends WebSecurityConfigurerAdapter &#123;


  public SecurityConfiguration(AuthenticationManagerBuilder authenticationManagerBuilder, UserDetailsService userDetailsService,TokenProvider tokenProvider,CorsFilter corsFilter, SecurityProblemSupport problemSupport) &#123;
        this.authenticationManagerBuilder = authenticationManagerBuilder;
        this.userDetailsService = userDetailsService;
        this.tokenProvider = tokenProvider;
        this.corsFilter = corsFilter;
        this.problemSupport = problemSupport;
    &#125;

    @PostConstruct
    public void init() &#123;
        try &#123;
            authenticationManagerBuilder
                .userDetailsService(userDetailsService)
                .passwordEncoder(passwordEncoder());
        &#125; catch (Exception e) &#123;
            throw new BeanInitializationException(&quot;Security configuration failed&quot;, e);
        &#125;
    &#125;

   @Override
    protected void configure(HttpSecurity http) throws Exception &#123;
        http
            .addFilterBefore(corsFilter, UsernamePasswordAuthenticationFilter.class)
            .exceptionHandling()
            .authenticationEntryPoint(problemSupport)
            .accessDeniedHandler(problemSupport)
        .and()
            .csrf()
            .disable()
            .headers()
            .frameOptions()
            .disable()
        .and()
            .sessionManagement()
            .sessionCreationPolicy(SessionCreationPolicy.STATELESS)
        .and()
            .authorizeRequests()
            .antMatchers(&quot;/api/register&quot;).permitAll()
            .antMatchers(&quot;/api/activate&quot;).permitAll()
            .antMatchers(&quot;/api/authenticate&quot;).permitAll()
            .antMatchers(&quot;/api/account/reset-password/init&quot;).permitAll()
            .antMatchers(&quot;/api/account/reset-password/finish&quot;).permitAll()
            .antMatchers(&quot;/api/profile-info&quot;).permitAll()
            .antMatchers(&quot;/api/**&quot;).authenticated()
            .antMatchers(&quot;/management/health&quot;).permitAll()
            .antMatchers(&quot;/management/**&quot;).hasAuthority(AuthoritiesConstants.ADMIN)
            .antMatchers(&quot;/v2/api-docs/**&quot;).permitAll()
            .antMatchers(&quot;/swagger-resources/configuration/ui&quot;).permitAll()
            .antMatchers(&quot;/swagger-ui/index.html&quot;).hasAuthority(AuthoritiesConstants.ADMIN)
        .and()
            .apply(securityConfigurerAdapter());

    &#125;
&#125;
</code></pre>
<h2 id="授权与访问控制"><a href="#授权与访问控制" class="headerlink" title="授权与访问控制"></a>授权与访问控制</h2><p>一旦认证成功，我们可以继续进行授权，授权是通过<code>AccessDecisionManager</code>来实现的。框架有三种实现，默认是AffirmativeBased，通过<code>AccessDecisionVoter</code>决策，有点像<code>ProviderManager</code>委托给<code>AuthenticationProviders</code>来认证。</p>
<pre><code>public void decide(Authentication authentication, Object object,        Collection&lt;ConfigAttribute&gt; configAttributes) throws AccessDeniedException &#123;    int deny = 0;
        // 遍历DecisionVoter     for (AccessDecisionVoter voter : getDecisionVoters()) &#123;        // 投票        int result = voter.vote(authentication, object, configAttributes);
        if (logger.isDebugEnabled()) &#123;            logger.debug(&quot;Voter: &quot; + voter + &quot;, returned: &quot; + result);        &#125;
        switch (result) &#123;        case AccessDecisionVoter.ACCESS_GRANTED:            return;
        case AccessDecisionVoter.ACCESS_DENIED:            deny++;
            break;
        default:            break;        &#125;    &#125;
           // 一票否决    if (deny &gt; 0) &#123;        throw new AccessDeniedException(messages.getMessage(                &quot;AbstractAccessDecisionManager.accessDenied&quot;, &quot;Access is denied&quot;));    &#125;
    // To get this far, every AccessDecisionVoter abstained    checkAllowIfAllAbstainDecisions();&#125;
</code></pre>
<p>来看AccessDecisionVoter：</p>
<pre><code>boolean supports(ConfigAttribute attribute);

boolean supports(Class&lt;?&gt; clazz);

int vote(Authentication authentication, S object,
        Collection&lt;ConfigAttribute&gt; attributes);
</code></pre>
<p>object是用户要访问的资源，ConfigAttribute则是访问object要满足的条件，通常payload是字符串，比如ROLE_ADMIN 。所以我们来看下RoleVoter的实现，其核心就是从authentication提取出GrantedAuthority，然后和ConfigAttribute比较是否满足条件。</p>
<pre><code>public boolean supports(ConfigAttribute attribute) &#123;    if ((attribute.getAttribute() != null)            &amp;&amp; attribute.getAttribute().startsWith(getRolePrefix())) &#123;        return true;    &#125;    else &#123;        return false;    &#125;&#125;
public boolean supports(Class&lt;?&gt; clazz) &#123;    return true;&#125;


public int vote(Authentication authentication, Object object,        Collection&lt;ConfigAttribute&gt; attributes) &#123;    if(authentication == null) &#123;        return ACCESS_DENIED;    &#125;    int result = ACCESS_ABSTAIN;        // 获取GrantedAuthority信息    Collection&lt;? extends GrantedAuthority&gt; authorities = extractAuthorities(authentication);
    for (ConfigAttribute attribute : attributes) &#123;        if (this.supports(attribute)) &#123;            // 默认拒绝访问            result = ACCESS_DENIED;
            // Attempt to find a matching granted authority            for (GrantedAuthority authority : authorities) &#123;                 // 判断是否有匹配的 authority                if (attribute.getAttribute().equals(authority.getAuthority())) &#123;                    // 可访问                    return ACCESS_GRANTED;                &#125;            &#125;        &#125;    &#125;
    return result;&#125;
</code></pre>
<p>这里要疑问，ConfigAttribute哪来的？其实就是上面ApplicationSecurity的configure里的。</p>
<h3 id="web-security-如何实现"><a href="#web-security-如何实现" class="headerlink" title="web security 如何实现"></a>web security 如何实现</h3><p>Web层中的Spring Security（用于UI和HTTP后端）基于Servlet <code>Filters</code>，下图显示了单个HTTP请求的处理程序的典型分层。</p>
<p><img src="https://github.com/spring-guides/top-spring-security-architecture/raw/master/images/filters.png" alt="过滤链委托给一个Servlet"></p>
<p>Spring Security通过<code>FilterChainProxy</code>作为单一的Filter注册到web层，Proxy内部的Filter。</p>
<p><img src="https://github.com/spring-guides/top-spring-security-architecture/raw/master/images/security-filters.png" alt="Spring安全筛选器"></p>
<p>FilterChainProxy相当于一个filter的容器，通过VirtualFilterChain来依次调用各个内部filter</p>
<pre><code>public void doFilter(ServletRequest request, ServletResponse response,        FilterChain chain) throws IOException, ServletException &#123;    boolean clearContext = request.getAttribute(FILTER_APPLIED) == null;    if (clearContext) &#123;        try &#123;            request.setAttribute(FILTER_APPLIED, Boolean.TRUE);            doFilterInternal(request, response, chain);        &#125;        finally &#123;            SecurityContextHolder.clearContext();            request.removeAttribute(FILTER_APPLIED);        &#125;    &#125;    else &#123;        doFilterInternal(request, response, chain);    &#125;&#125;
private void doFilterInternal(ServletRequest request, ServletResponse response,        FilterChain chain) throws IOException, ServletException &#123;
    FirewalledRequest fwRequest = firewall            .getFirewalledRequest((HttpServletRequest) request);    HttpServletResponse fwResponse = firewall            .getFirewalledResponse((HttpServletResponse) response);
    List&lt;Filter&gt; filters = getFilters(fwRequest);
    if (filters == null || filters.size() == 0) &#123;        if (logger.isDebugEnabled()) &#123;            logger.debug(UrlUtils.buildRequestUrl(fwRequest)                    + (filters == null ? &quot; has no matching filters&quot;                            : &quot; has an empty filter list&quot;));        &#125;
        fwRequest.reset();
        chain.doFilter(fwRequest, fwResponse);
        return;    &#125;
    VirtualFilterChain vfc = new VirtualFilterChain(fwRequest, chain, filters);    vfc.doFilter(fwRequest, fwResponse);&#125;private static class VirtualFilterChain implements FilterChain &#123;    private final FilterChain originalChain;    private final List&lt;Filter&gt; additionalFilters;    private final FirewalledRequest firewalledRequest;    private final int size;    private int currentPosition = 0;
    private VirtualFilterChain(FirewalledRequest firewalledRequest,            FilterChain chain, List&lt;Filter&gt; additionalFilters) &#123;        this.originalChain = chain;        this.additionalFilters = additionalFilters;        this.size = additionalFilters.size();        this.firewalledRequest = firewalledRequest;    &#125;
    public void doFilter(ServletRequest request, ServletResponse response)            throws IOException, ServletException &#123;        if (currentPosition == size) &#123;            if (logger.isDebugEnabled()) &#123;                logger.debug(UrlUtils.buildRequestUrl(firewalledRequest)                        + &quot; reached end of additional filter chain; proceeding with original chain&quot;);            &#125;
            // Deactivate path stripping as we exit the security filter chain            this.firewalledRequest.reset();
            originalChain.doFilter(request, response);        &#125;        else &#123;            currentPosition++;
            Filter nextFilter = additionalFilters.get(currentPosition - 1);
            if (logger.isDebugEnabled()) &#123;                logger.debug(UrlUtils.buildRequestUrl(firewalledRequest)                        + &quot; at position &quot; + currentPosition + &quot; of &quot; + size                        + &quot; in additional filter chain; firing Filter: &#39;&quot;                        + nextFilter.getClass().getSimpleName() + &quot;&#39;&quot;);            &#125;
            nextFilter.doFilter(request, response, this);        &#125;    &#125;&#125;
</code></pre>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://spring.io/guides/topicals/spring-security-architecture/">https://spring.io/guides/topicals/spring-security-architecture/</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-security/site/docs/5.0.5.RELEASE/reference/htmlsingle/#overall-architecture">https://docs.spring.io/spring-security/site/docs/5.0.5.RELEASE/reference/htmlsingle/#overall-architecture</a></li>
</ul>
<hr>
<blockquote>
<p>作者：Jadepeng<br> 出处：jqpeng的技术记事本–<a target="_blank" rel="noopener" href="http://www.cnblogs.com/xiaoqi">http://www.cnblogs.com/xiaoqi</a><br> 您的支持是对博主最大的鼓励，感谢您的认真阅读。<br> 本文版权归作者所有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文连接，否则保留追究法律责任的权利。</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.iflyresearch.com/2018/05/28/jqpeng-%E5%BC%80%E6%BA%90APM%E7%B3%BB%E7%BB%9Fskywalking%E4%BB%8B%E7%BB%8D%E4%B8%8E%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="JadePeng">
      <meta itemprop="description" content="JadePeng的技术笔记本">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JadePeng的技术笔记本">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2018/05/28/jqpeng-%E5%BC%80%E6%BA%90APM%E7%B3%BB%E7%BB%9Fskywalking%E4%BB%8B%E7%BB%8D%E4%B8%8E%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">开源APM系统skywalking介绍与使用</a>
        </h2>

        <div class="post-meta">

         
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-05-28 11:25:00" itemprop="dateCreated datePublished" datetime="2018-05-28T11:25:00+08:00">2018-05-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 17:44:20" itemprop="dateModified" datetime="2021-05-14T17:44:20+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%8D%9A%E5%AE%A2/" itemprop="url" rel="index"><span itemprop="name">博客</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%8D%9A%E5%AE%A2/jqpeng/" itemprop="url" rel="index"><span itemprop="name">jqpeng</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.5k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>文章作者:jqpeng<br>原文链接: <a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaoqi/p/skywalking-usage.html">开源APM系统skywalking介绍与使用</a></p>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p><strong>SkyWalking</strong> 创建与2015年，提供分布式追踪功能。从5.x开始，项目进化为一个完成功能的<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Application_performance_management">Application Performance Management</a>系统。<br> 他被用于追踪、监控和诊断分布式系统，特别是使用微服务架构，云原生或容积技术。提供以下主要功能：</p>
<ul>
<li>分布式追踪和上下文传输</li>
<li>应用、实例、服务性能指标分析</li>
<li>根源分析</li>
<li>应用拓扑分析</li>
<li>应用和服务依赖分析</li>
<li>慢服务检测</li>
<li>性能优化</li>
</ul>
<h3 id="主要特性"><a href="#主要特性" class="headerlink" title="主要特性"></a>主要特性</h3><ul>
<li>多语言探针或类库<ul>
<li>Java自动探针，追踪和监控程序时，不需要修改源码。</li>
<li>社区提供的其他多语言探针<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/OpenSkywalking/skywalking-netcore">.NET Core</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/OpenSkywalking/skywalking-nodejs">Node.js</a></li>
</ul>
</li>
</ul>
</li>
<li>多种后端存储： ElasticSearch， H2</li>
<li>支持<a target="_blank" rel="noopener" href="http://opentracing.io/">OpenTracing</a><ul>
<li>Java自动探针支持和OpenTracing API协同工作</li>
</ul>
</li>
<li>轻量级、完善功能的后端聚合和分析</li>
<li>现代化Web UI</li>
<li>日志集成</li>
<li>应用、实例和服务的告警</li>
</ul>
<h3 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h3><p><img src="https://skywalkingtest.github.io/page-resources/5.0/architecture.png"></p>
<h3 id="在线体验"><a href="#在线体验" class="headerlink" title="在线体验"></a>在线体验</h3><ul>
<li>北京服务器. <a target="_blank" rel="noopener" href="http://49.4.12.44:8080/">前往</a></li>
<li>香港服务器. <a target="_blank" rel="noopener" href="http://159.138.0.181:8080/">前往</a></li>
</ul>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h3 id="安装es"><a href="#安装es" class="headerlink" title="安装es"></a>安装es</h3><p>新版本的skywalking使用ES作为存储，所以先安装es，注意6.X版本不行，安装5.6.8：</p>
<pre><code>wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.6.8.tar.gz
tar zxvf elasticsearch-5.6.8.tar.gz
cd elasticsearch-5.6.8/
</code></pre>
<p>修改配置文件，主要修改cluster.name，并增加两行配置，<br> vim config/elasticsearch.yml：</p>
<pre><code>cluster.name: CollectorDBCluster

# ES监听的ip地址
network.host: 0.0.0.0
thread_pool.bulk.queue_size: 1000
</code></pre>
<p>保存，然后启动es：</p>
<pre><code>nohup bin/elasticsearch &amp;
</code></pre>
<h3 id="安装skywalking"><a href="#安装skywalking" class="headerlink" title="安装skywalking"></a>安装skywalking</h3><p>先下载编译好的版本并解压：</p>
<pre><code>wget http://mirrors.hust.edu.cn/apache/incubator/skywalking/5.0.0-beta/apache-skywalking-apm-incubating-5.0.0-beta.tar.gz
tar zxvf apache-skywalking-apm-incubating-5.0.0-beta.tar.gz 
cd apache-skywalking-apm-incubating/
</code></pre>
<p>然后部署，注意skywalking会使用(8080, 10800, 11800, 12800)端口，因此先排除端口占用情况。</p>
<p>然后运行bin/startup.sh，windows用户为.bat文件。</p>
<p>一切正常的话，访问localhost:8080就能看到页面了。</p>
<h4 id="安装过程问题解决"><a href="#安装过程问题解决" class="headerlink" title="安装过程问题解决"></a>安装过程问题解决</h4><ol>
<li>启动bin/startup.sh后，提示success，但是不能访问，ps 查看并无相关进程，经过检查发现是端口被占用</li>
<li>collector 不能正常启动，发现是es问题：<ul>
<li>es需要使用5.x版本</li>
<li>es的集群名称需要和collector的配置文件一致</li>
</ul>
</li>
</ol>
<h3 id="java程序使用skywalking探针"><a href="#java程序使用skywalking探针" class="headerlink" title="java程序使用skywalking探针"></a>java程序使用skywalking探针</h3><p>1.拷贝apache-skywalking-apm-incubating目录下的agent目录到应用程序位置，探针包含整个目录，请不要改变目录结构<br> 2.java程序启动时，增加JVM启动参数，-javaagent:/path/to/agent/skywalking-agent.jar。参数值为skywalking-agent.jar的绝对路径</p>
<p>在IDEA里调试程序怎么办？</p>
<p><img src="https://raw.githubusercontent.com/jadepeng/blogpic/master/pic/2018/1527477582714.jpg" alt="enter description here" title="IDEA 配置"></p>
<p>增加VM参数即可。</p>
<p>agent探针配置，简单修改下agent.application_code即可</p>
<pre><code># 当前的应用编码，最终会显示在webui上。
# 建议一个应用的多个实例，使用有相同的application_code。请使用英文
agent.application_code=Your_ApplicationName

# 每三秒采样的Trace数量
# 默认为负数，代表在保证不超过内存Buffer区的前提下，采集所有的Trace
# agent.sample_n_per_3_secs=-1

# 设置需要忽略的请求地址
# 默认配置如下
# agent.ignore_suffix=.jpg,.jpeg,.js,.css,.png,.bmp,.gif,.ico,.mp3,.mp4,.html,.svg

# 探针调试开关，如果设置为true，探针会将所有操作字节码的类输出到/debugging目录下
# skywalking团队可能在调试，需要此文件
# agent.is_open_debugging_class = true

# 对应Collector的config/application.yml配置文件中 agent_server/jetty/port 配置内容
# 例如：
# 单节点配置：SERVERS=&quot;127.0.0.1:8080&quot; 
# 集群配置：SERVERS=&quot;10.2.45.126:8080,10.2.45.127:7600&quot; 
collector.servers=127.0.0.1:10800

# 日志文件名称前缀
logging.file_name=skywalking-agent.log

# 日志文件最大大小
# 如果超过此大小，则会生成新文件。
# 默认为300M
logging.max_file_size=314572800

# 日志级别，默认为DEBUG。
logging.level=DEBUG
</code></pre>
<p>一切正常的话，稍后就可以在skywalking ui看到了。</p>
<p><img src="https://raw.githubusercontent.com/jadepeng/blogpic/master/pic/2018/1527477724637.jpg" alt="enter description here" title="SW UI"></p>
<p>可以看到累出了slow service等信息，更多的细节慢慢挖掘吧。</p>
<hr>
<blockquote>
<p>作者：Jadepeng<br> 出处：jqpeng的技术记事本–<a target="_blank" rel="noopener" href="http://www.cnblogs.com/xiaoqi">http://www.cnblogs.com/xiaoqi</a><br> 您的支持是对博主最大的鼓励，感谢您的认真阅读。<br> 本文版权归作者所有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文连接，否则保留追究法律责任的权利。</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.iflyresearch.com/2018/05/04/jqpeng-%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%881%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="JadePeng">
      <meta itemprop="description" content="JadePeng的技术笔记本">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JadePeng的技术笔记本">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2018/05/04/jqpeng-%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%881%EF%BC%89/" class="post-title-link" itemprop="url">知识图谱学习笔记（1）</a>
        </h2>

        <div class="post-meta">

         
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-05-04 17:25:00" itemprop="dateCreated datePublished" datetime="2018-05-04T17:25:00+08:00">2018-05-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 17:44:20" itemprop="dateModified" datetime="2021-05-14T17:44:20+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%8D%9A%E5%AE%A2/" itemprop="url" rel="index"><span itemprop="name">博客</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%8D%9A%E5%AE%A2/jqpeng/" itemprop="url" rel="index"><span itemprop="name">jqpeng</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>17k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>15 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>文章作者:jqpeng<br>原文链接: <a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaoqi/p/kg-study-part-1.html">知识图谱学习笔记（1）</a></p>
<p>知识图谱学习笔记第一部分，包含RDF介绍，以及Jena RDF API使用</p>
<h2 id="知识图谱的基石：RDF"><a href="#知识图谱的基石：RDF" class="headerlink" title="知识图谱的基石：RDF"></a>知识图谱的基石：RDF</h2><p>RDF(Resource Description Framework)，即资源描述框架，其本质是一个数据模型（Data Model）。它提供了一个统一的标准，用于描述实体/资源。简单来说，就是表示事物的一种方法和手段。<br><img src="https://pic2.zhimg.com/80/v2-e3478e02c36ead3875e598b0668830fd_hd.jpg" alt="enter description here"></p>
<h3 id="RDF序列化方法"><a href="#RDF序列化方法" class="headerlink" title="RDF序列化方法"></a>RDF序列化方法</h3><p>RDF序列化的方式主要有：RDF/XML，N-Triples，Turtle，RDFa，JSON-LD等几种。</p>
<ol>
<li>RDF/XML，顾名思义，就是用XML的格式来表示RDF数据</li>
<li>N-Triples，即用多个三元组来表示RDF数据集，是最直观的表示方法。在文件中，每一行表示一个三元组，方便机器解析和处理。开放领域知识图谱DBpedia通常是用这种格式来发布数据的。</li>
<li>Turtle, [‘tɝtl] 应该是使用得最多的一种RDF序列化方式了。它比RDF/XML紧凑，且可读性比N-Triples好。</li>
<li>RDFa,即“The Resource Description Framework in Attributes”，是HTML5的一个扩展，在不改变任何显示效果的情况下，让网站构建者能够在页面中标记实体，像人物、地点、时间、评论等等</li>
<li>JSON-LD，即“JSON for Linking Data”，用键值对的方式来存储RDF数据</li>
</ol>
<p>Example1 N-Triples:</p>
<pre><code>&lt;http://www.kg.com/person/1&gt; &lt;http://www.kg.com/ontology/chineseName&gt; &quot;罗纳尔多·路易斯·纳萨里奥·德·利马&quot;^^string.
&lt;http://www.kg.com/person/1&gt; &lt;http://www.kg.com/ontology/career&gt; &quot;足球运动员&quot;^^string.
&lt;http://www.kg.com/person/1&gt; &lt;http://www.kg.com/ontology/fullName&gt; &quot;Ronaldo Luís Nazário de Lima&quot;^^string.
&lt;http://www.kg.com/person/1&gt; &lt;http://www.kg.com/ontology/birthDate&gt; &quot;1976-09-18&quot;^^date.
&lt;http://www.kg.com/person/1&gt; &lt;http://www.kg.com/ontology/height&gt; &quot;180&quot;^^int.
&lt;http://www.kg.com/person/1&gt; &lt;http://www.kg.com/ontology/weight&gt; &quot;98&quot;^^int.
&lt;http://www.kg.com/person/1&gt; &lt;http://www.kg.com/ontology/nationality&gt; &quot;巴西&quot;^^string.
&lt;http://www.kg.com/person/1&gt; &lt;http://www.kg.com/ontology/hasBirthPlace&gt; &lt;http://www.kg.com/place/10086&gt;.
&lt;http://www.kg.com/place/10086&gt; &lt;http://www.kg.com/ontology/address&gt; &quot;里约热内卢&quot;^^string.
&lt;http://www.kg.com/place/10086&gt; &lt;http://www.kg.com/ontology/coordinate&gt; &quot;-22.908333, -43.196389&quot;^^string.
</code></pre>
<p>Example2 Turtle:</p>
<pre><code>@prefix person: &lt;http://www.kg.com/person/&gt; .
@prefix place: &lt;http://www.kg.com/place/&gt; .
@prefix : &lt;http://www.kg.com/ontology/&gt; .

person:1 :chineseName &quot;罗纳尔多·路易斯·纳萨里奥·德·利马&quot;^^string.
person:1 :career &quot;足球运动员&quot;^^string.
person:1 :fullName &quot;Ronaldo Luís Nazário de Lima&quot;^^string.
person:1 :birthDate &quot;1976-09-18&quot;^^date.
person:1 :height &quot;180&quot;^^int. 
person:1 :weight &quot;98&quot;^^int.
person:1 :nationality &quot;巴西&quot;^^string. 
person:1 :hasBirthPlace place:10086.
place:10086 :address &quot;里约热内卢&quot;^^string.
place:10086 :coordinate &quot;-22.908333, -43.196389&quot;^^string.
</code></pre>
<h3 id="RDF的表达能力"><a href="#RDF的表达能力" class="headerlink" title="RDF的表达能力"></a>RDF的表达能力</h3><p>RDF的表达能力有限，无法区分类和对象，也无法定义和描述类的关系/属性。RDF是对具体事物的描述，缺乏抽象能力，无法对同一个类别的事物进行定义和描述。就以罗纳尔多这个知识图为例，RDF能够表达罗纳尔多和里约热内卢这两个实体具有哪些属性，以及它们之间的关系。但如果我们想定义罗纳尔多是人，里约热内卢是地点，并且人具有哪些属性，地点具有哪些属性，人和地点之间存在哪些关系，这个时候RDF就表示无能为力了。</p>
<h2 id="RDFS-OWL"><a href="#RDFS-OWL" class="headerlink" title="RDFS/OWL"></a>RDFS/OWL</h2><p>RDFS/OWL本质上是一些预定义词汇（vocabulary）构成的集合，用于对RDF进行类似的类定义及其属性的定义。</p>
<blockquote>
<p>RDFS/OWL序列化方式和RDF没什么不同，其实在表现形式上，它们就是RDF。其常用的方式主要是RDF/XML，Turtle。另外，通常我们用小写开头的单词或词组来表示属性，大写开头的表示类。数据属性（data property，实体和literal字面量的关系）通常由名词组成，而对象数据（object property，实体和实体之间的关系）通常由动词（has，is之类的）加名词组成。剩下的部分符合驼峰命名法。</p>
</blockquote>
<h3 id="轻量级的模式语言——RDFS"><a href="#轻量级的模式语言——RDFS" class="headerlink" title="轻量级的模式语言——RDFS"></a>轻量级的模式语言——RDFS</h3><p>RDFS，即“Resource Description Framework Schema”，是最基础的模式语言。还是以罗纳尔多知识图为例，我们在概念、抽象层面对RDF数据进行定义。下面的RDFS定义了人和地点这两个类，及每个类包含的属性。</p>
<pre><code>@prefix rdfs: &lt;http://www.w3.org/2000/01/rdf-schema#&gt; .
@prefix rdf: &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#&gt; .
@prefix : &lt;http://www.kg.com/ontology/&gt; .

### 这里我们用词汇rdfs:Class定义了“人”和“地点”这两个类。
:Person rdf:type rdfs:Class.
:Place rdf:type rdfs:Class.

### rdfs当中不区分数据属性和对象属性，词汇rdf:Property定义了属性，即RDF的“边”。

:chineseName rdf:type rdf:Property;    rdfs:domain :Person;    rdfs:range xsd:string .

:career rdf:type rdf:Property;    rdfs:domain :Person;    rdfs:range xsd:string .

:fullName rdf:type rdf:Property;    rdfs:domain :Person;    rdfs:range xsd:string .

:birthDate rdf:type rdf:Property;    rdfs:domain :Person;    rdfs:range xsd:date .

:height rdf:type rdf:Property;    rdfs:domain :Person;    rdfs:range xsd:int .

:weight rdf:type rdf:Property;    rdfs:domain :Person;    rdfs:range xsd:int .

:nationality rdf:type rdf:Property;    rdfs:domain :Person;    rdfs:range xsd:string .

:hasBirthPlace rdf:type rdf:Property;    rdfs:domain :Person;    rdfs:range :Place .

:address rdf:type rdf:Property;    rdfs:domain :Place;    rdfs:range xsd:string .

:coordinate rdf:type rdf:Property;    rdfs:domain :Place;    rdfs:range xsd:string .
</code></pre>
<p>RDFS几个比较重要，常用的词汇：</p>
<ol>
<li>rdfs:Class. 用于定义类</li>
<li>rdfs:domain. 用于表示该属性属于哪个类别</li>
<li>rdfs:range. 用于描述该属性的取值类型</li>
<li>rdfs:subClassOf. 用于描述该类的父类</li>
<li>rdfs:subProperty. 用于描述该属性的父属性</li>
</ol>
<p><img src="https://pic3.zhimg.com/v2-9950314f9ab6e6c44a2300d03e022bb1_r.jpg" alt="enter description here"></p>
<p>Data层是我们用RDF对罗纳尔多知识图的具体描述，Vocabulary是我们自己定义的一些词汇（类别，属性），RDF(S)则是预定义词汇。从下到上是一个具体到抽象的过程。图中我们用红色圆角矩形表示类，绿色字体表示rdf:type，rdfs:domain，rdfs:range三种预定义词汇，虚线表示rdf:type这种所属关系。</p>
<h3 id="RDFS的扩展——OWL"><a href="#RDFS的扩展——OWL" class="headerlink" title="RDFS的扩展——OWL"></a>RDFS的扩展——OWL</h3><p>RDFS本质上是RDF词汇的一个扩展。后来人们发现RDFS的表达能力还是相当有限，因此提出了OWL。我们也可以把OWL当做是RDFS的一个扩展，其添加了额外的预定义词汇。</p>
<p>OWL，即“Web Ontology Language”，语义网技术栈的核心之一。OWL有两个主要的功能：</p>
<ol>
<li>提供快速、灵活的数据建模能力。</li>
<li>高效的自动推理。</li>
</ol>
<p>用OWL对罗纳尔多知识图进行语义层的描述：</p>
<pre><code>@prefix rdfs: &lt;http://www.w3.org/2000/01/rdf-schema#&gt; .
@prefix rdf: &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#&gt; .
@prefix : &lt;http://www.kg.com/ontology/&gt; .
@prefix owl: &lt;http://www.w3.org/2002/07/owl#&gt; .

### 这里我们用词汇owl:Class定义了“人”和“地点”这两个类。
:Person rdf:type owl:Class.
:Place rdf:type owl:Class.

### owl区分数据属性和对象属性（对象属性表示实体和实体之间的关系）。词汇owl:DatatypeProperty定义了数据属性，owl:ObjectProperty定义了对象属性。
:chineseName rdf:type owl:DatatypeProperty;    rdfs:domain :Person;    rdfs:range xsd:string .

:career rdf:type owl:DatatypeProperty;    rdfs:domain :Person;    rdfs:range xsd:string .

:fullName rdf:type owl:DatatypeProperty;    rdfs:domain :Person;    rdfs:range xsd:string .

:birthDate rdf:type owl:DatatypeProperty;    rdfs:domain :Person;    rdfs:range xsd:date .

:height rdf:type owl:DatatypeProperty;    rdfs:domain :Person;    rdfs:range xsd:int .

:weight rdf:type owl:DatatypeProperty;    rdfs:domain :Person;    rdfs:range xsd:int .

:nationality rdf:type owl:DatatypeProperty;    rdfs:domain :Person;    rdfs:range xsd:string .

:hasBirthPlace rdf:type owl:ObjectProperty;    rdfs:domain :Person;    rdfs:range :Place .

:address rdf:type owl:DatatypeProperty;    rdfs:domain :Place;    rdfs:range xsd:string .

:coordinate rdf:type owl:DatatypeProperty;    rdfs:domain :Place;    rdfs:range xsd:string .
</code></pre>
<p>schema层的描述语言换为OWL后，层次图表示为：<br><img src="https://pic2.zhimg.com/v2-ef0de6ba9620d27ca0f2d2f4b0f18f53_r.jpg" alt="enter description here"></p>
<p>owl区分数据属性和对象属性（对象属性表示实体和实体之间的关系）。词汇owl:DatatypeProperty定义了数据属性，owl:ObjectProperty定义了对象属性。</p>
<p>上图中，数据属性用青色表示，对象属性由蓝色表示。</p>
<p>描述属性特征的词汇</p>
<ol>
<li>owl:TransitiveProperty. 表示该属性具有传递性质。例如，我们定义“位于”是具有传递性的属性，若A位于B，B位于C，那么A肯定位于C。</li>
<li>owl:SymmetricProperty. 表示该属性具有对称性。例如，我们定义“认识”是具有对称性的属性，若A认识B，那么B肯定认识A。</li>
<li>owl:FunctionalProperty. 表示该属性取值的唯一性。 例如，我们定义“母亲”是具有唯一性的属性，若A的母亲是B，在其他地方我们得知A的母亲是C，那么B和C指的是同一个人。</li>
<li>owl:inverseOf. 定义某个属性的相反关系。例如，定义“父母”的相反关系是“子女”，若A是B的父母，那么B肯定是A的子女。</li>
</ol>
<p>本体映射词汇（Ontology Mapping）</p>
<ol>
<li>owl:equivalentClass. 表示某个类和另一个类是相同的。</li>
<li>owl:equivalentProperty. 表示某个属性和另一个属性是相同的。</li>
<li>owl:sameAs. 表示两个实体是同一个实体。</li>
</ol>
<h3 id="RDFS-OWL推理的推理机（reasoner）"><a href="#RDFS-OWL推理的推理机（reasoner）" class="headerlink" title="RDFS,OWL推理的推理机（reasoner）"></a>RDFS,OWL推理的推理机（reasoner）</h3><p>RDFS同样支持推理，由于缺乏丰富的表达能力，推理能力也不强。举个例子，我们用RDFS定义人和动物两个类，另外，定义人是动物的一个子类。此时推理机能够推断出一个实体若是人，那么它也是动物。OWL当然支持这种基本的推理，除此之外，凭借其强大的表达能力，我们能进行更有实际意义的推理。想象一个场景，我们有一个庞大数据库存储人物的亲属关系。里面很多关系都是单向的，比如，其只保存了A的父亲（母亲）是B，但B的子女字段里面没有A，可以推理得到B的子女A。</p>
<p>。<img src="https://pic4.zhimg.com/80/v2-b27db971f3fa1cefc83a47be5234dc18_hd.jpg" alt="enter description here"></p>
<h2 id="RDF查询语言SPARQL"><a href="#RDF查询语言SPARQL" class="headerlink" title="RDF查询语言SPARQL"></a>RDF查询语言SPARQL</h2><p>SPARQL即SPARQL Protocol and RDF Query Language的递归缩写，专门用于访问和操作RDF数据，是语义网的核心技术之一。W3C的RDF数据存取小组（RDF Data Access Working Group, RDAWG）对其进行了标准化。在2008年，SPARQL 1.0成为W3C官方所推荐的标准。2013年发布了SPARQL 1.1。相对第一个版本，其支持RDF图的更新，提供更强大的查询，比如：子查询、聚合操作（像我们常用的count）等等。</p>
<p>由两个部分组成：协议和查询语言。</p>
<ol>
<li>查询语言很好理解，就像SQL用于查询关系数据库中的数据，XQuery用于查询XML数据，SPARQL用于查询RDF数据。</li>
<li>协议是指我们可以通过HTTP协议在客户端和SPARQL服务器（SPARQL endpoint）之间传输查询和结果，这也是和其他查询语言最大的区别。</li>
</ol>
<p>一个SPARQL查询本质上是一个带有变量的RDF图，以我们之前提到的罗纳尔多RDF数据为例：</p>
<pre><code>&lt;http://www.kg.com/person/1&gt; &lt;http://www.kg.com/ontology/chineseName&gt; &quot;罗纳尔多·路易斯·纳萨里奥·德·利马&quot;^^string.
</code></pre>
<p>查询SPARQL</p>
<pre><code>&lt;http://www.kg.com/person/1&gt; &lt;http://www.kg.com/ontology/chineseName&gt; ?x.
</code></pre>
<p>SPARQL查询是基于图匹配的思想。我们把上述的查询与RDF图进行匹配，找到符合该匹配模式的所有子图，最后得到变量的值。就上面这个例子而言，在RDF图中找到匹配的子图后，将”罗纳尔多·路易斯·纳萨里奥·德·利马”和“?x”绑定，我们就得到最后的结果。简而言之，SPARQL查询分为三个步骤：</p>
<ol>
<li>构建查询图模式，表现形式就是带有变量的RDF。</li>
<li>匹配，匹配到符合指定图模式的子图。</li>
<li>绑定，将结果绑定到查询图模式对应的变量上。</li>
</ol>
<h3 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h3><p><strong>如何查询所有数据</strong></p>
<pre><code>PREFIX : &lt;http://www.kgdemo.com#&gt;
PREFIX rdf: &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#&gt;
PREFIX owl: &lt;http://www.w3.org/2002/07/owl#&gt;
PREFIX xsd: &lt;XML Schema&gt;
PREFIX vocab: &lt;http://localhost:2020/resource/vocab/&gt;
PREFIX rdfs: &lt;http://www.w3.org/2000/01/rdf-schema#&gt;
PREFIX map: &lt;http://localhost:2020/resource/#&gt;
PREFIX db: &lt;http://localhost:2020/resource/&gt;

SELECT * WHERE &#123;
  ?s ?p ?o
&#125;
</code></pre>
<p>SPARQL的部分关键词：</p>
<ol>
<li>SELECT， 指定我们要查询的变量。在这里我们查询所有的变量，用*代替。</li>
<li>WHERE，指定我们要查询的图模式。含义上和SQL的WHERE没有区别。</li>
<li>FROM，指定查询的RDF数据集。我们这里只有一个图，因此省去了FROM关键词。 PREFIX，用于IRI的缩写。</li>
</ol>
<p>“周星驰出演了哪些电影”：</p>
<pre><code>PREFIX : &lt;http://www.kgdemo.com#&gt;
PREFIX rdf: &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#&gt;
PREFIX owl: &lt;http://www.w3.org/2002/07/owl#&gt;
PREFIX xsd: &lt;XML Schema&gt;
PREFIX vocab: &lt;http://localhost:2020/resource/vocab/&gt;
PREFIX rdfs: &lt;http://www.w3.org/2000/01/rdf-schema#&gt;
PREFIX map: &lt;http://localhost:2020/resource/#&gt;
PREFIX db: &lt;http://localhost:2020/resource/&gt;

SELECT ?n WHERE &#123;
  ?s rdf:type :Person.
  ?s :personName &#39;周星驰&#39;.
  ?s :hasActedIn ?o.
  ?o :movieTitle ?n
&#125;
</code></pre>
<h2 id="使用Jena-构建知识图谱"><a href="#使用Jena-构建知识图谱" class="headerlink" title="使用Jena 构建知识图谱"></a>使用Jena 构建知识图谱</h2><p>Jena是Apache基金会旗下的开源Java框架，用于构建Semantic Web 和 Linked Data 应用。</p>
<p>下面简要的介绍下API，要使用jena，可以下载jar包或者使用maven（推荐），建议测试时下面的都加上：</p>
<pre><code>    &lt;dependency&gt;    &lt;groupId&gt;org.apache.jena&lt;/groupId&gt;    &lt;artifactId&gt;apache-jena-libs&lt;/artifactId&gt;    &lt;type&gt;pom&lt;/type&gt;    &lt;version&gt;3.7.0&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt;    &lt;groupId&gt;org.apache.jena&lt;/groupId&gt;    &lt;artifactId&gt;jena-sdb&lt;/artifactId&gt;    &lt;version&gt;3.7.0&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt;    &lt;groupId&gt;org.apache.jena&lt;/groupId&gt;    &lt;artifactId&gt;jena-base&lt;/artifactId&gt;    &lt;version&gt;3.7.0&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt;    &lt;groupId&gt;org.apache.jena&lt;/groupId&gt;    &lt;artifactId&gt;jena-fuseki-embedded&lt;/artifactId&gt;    &lt;version&gt;3.7.0&lt;/version&gt; &lt;!-- Set the version --&gt;&lt;/dependency&gt;
&lt;!-- https://mvnrepository.com/artifact/org.apache.jena/jena-arq --&gt;&lt;dependency&gt;    &lt;groupId&gt;org.apache.jena&lt;/groupId&gt;    &lt;artifactId&gt;jena-arq&lt;/artifactId&gt;    &lt;version&gt;3.7.0&lt;/version&gt;&lt;/dependency&gt;
</code></pre>
<h3 id="Jena-RDF-API"><a href="#Jena-RDF-API" class="headerlink" title="Jena RDF API"></a>Jena RDF API</h3><p>首先，三元组（triple）组成的图称之为Model，这个图里的Node可以是resources(实体）、literals（文本）或者blank nodes。</p>
<p>一个三元组，在jena里称之为Statement，一个 statement 包含三部分：:</p>
<ul>
<li>the subject ：实体</li>
<li>the predicate ：属性</li>
<li>the object ： 值</li>
</ul>
<h4 id="创建Model"><a href="#创建Model" class="headerlink" title="创建Model"></a>创建Model</h4><pre><code>// URI 定义
static String personURI    = &quot;http://somewhere/JohnSmith&quot;;
static String fullName     = &quot;John Smith&quot;;

// 创建一个空模型（KG)
Model model = ModelFactory.createDefaultModel();

// 创建一个resource（一个subject)
Resource johnSmith = model.createResource(personURI);

// 添加属性，这里的value是一个literals（文本）
 johnSmith.addProperty(VCARD.FN, fullName);
</code></pre>
<p>当然，你还可以使用链式API,为resource添加多个Property</p>
<pre><code>// create the resource
//   and add the properties cascading style
Resource johnSmith
  = model.createResource(personURI)     .addProperty(VCARD.FN, fullName)     .addProperty(VCARD.N,                  model.createResource()                       .addProperty(VCARD.Given, givenName)                       .addProperty(VCARD.Family, familyName));
</code></pre>
<h4 id="遍历Model"><a href="#遍历Model" class="headerlink" title="遍历Model"></a>遍历Model</h4><p>使用model.listStatements遍历statements，返回一个迭代器，使用hasNext判断是否还有数据，通过getSubject，getPredicate，getObject 获取三元组信息。</p>
<pre><code>// list the statements in the Model
StmtIterator iter = model.listStatements();

// print out the predicate, subject and object of each statement
while (iter.hasNext()) &#123;
    Statement stmt      = iter.nextStatement();  // get next statement
    Resource  subject   = stmt.getSubject();     // get the subject
    Property  predicate = stmt.getPredicate();   // get the predicate
    RDFNode   object    = stmt.getObject();      // get the object
    System.out.print(subject.toString());
    System.out.print(&quot; &quot; + predicate.toString() + &quot; &quot;);
    if (object instanceof Resource) &#123;
       System.out.print(object.toString());
    &#125; else &#123;
        // object is a literal
        System.out.print(&quot; \&quot;&quot; + object.toString() + &quot;\&quot;&quot;);
    &#125;
    System.out.println(&quot; .&quot;);
&#125; 
</code></pre>
<p>运行结果：</p>
<pre><code>http://somewhere/JohnSmith http://www.w3.org/2001/vcard-rdf/3.0#N 80aeb72e-ef9c-4879-807d-62daf3c13b72 .
http://somewhere/JohnSmith http://www.w3.org/2001/vcard-rdf/3.0#FN  &quot;John Smith&quot; .
80aeb72e-ef9c-4879-807d-62daf3c13b72 http://www.w3.org/2001/vcard-rdf/3.0#Family  &quot;Smith&quot; .
80aeb72e-ef9c-4879-807d-62daf3c13b72 http://www.w3.org/2001/vcard-rdf/3.0#Given  &quot;John&quot; .
</code></pre>
<h4 id="保存为-RDF文件"><a href="#保存为-RDF文件" class="headerlink" title="保存为 RDF文件"></a>保存为 RDF文件</h4><p>可以使用model.write方便的把Model保存为rdf文件，write默认保存为XML格式</p>
<pre><code>// now write the model in XML form to a file
model.write(System.out);



&lt;rdf:RDF
  xmlns:rdf=&#39;http://www.w3.org/1999/02/22-rdf-syntax-ns#&#39;
  xmlns:vcard=&#39;http://www.w3.org/2001/vcard-rdf/3.0#&#39;
 &gt;
  &lt;rdf:Description rdf:about=&#39;http://somewhere/JohnSmith&#39;&gt;
    &lt;vcard:FN&gt;John Smith&lt;/vcard:FN&gt;
    &lt;vcard:N rdf:nodeID=&quot;A0&quot;/&gt;
  &lt;/rdf:Description&gt;
  &lt;rdf:Description rdf:nodeID=&quot;A0&quot;&gt;
    &lt;vcard:Given&gt;John&lt;/vcard:Given&gt;
    &lt;vcard:Family&gt;Smith&lt;/vcard:Family&gt;
  &lt;/rdf:Description&gt;
&lt;/rdf:RDF&gt;
</code></pre>
<p>write还提供重载版本write( OutputStream out, String lang )，lang可以为”RDF/XML-ABBREV”, “N-TRIPLE”, “TURTLE”, (and “TTL”) and “N3”<br> 我们来保存为常见的TURTLE：</p>
<pre><code>model.write(System.out, &quot;TURTLE&quot;);
</code></pre>
<p>结果：</p>
<pre><code>&lt;http://somewhere/JohnSmith&gt;    &lt;http://www.w3.org/2001/vcard-rdf/3.0#FN&gt;            &quot;John Smith&quot; ;    &lt;http://www.w3.org/2001/vcard-rdf/3.0#N&gt;            [ &lt;http://www.w3.org/2001/vcard-rdf/3.0#Family&gt;                      &quot;Smith&quot; ;              &lt;http://www.w3.org/2001/vcard-rdf/3.0#Given&gt;                      &quot;John&quot;            ] .
</code></pre>
<p>jena还提供prefix功能，我们可以指定prefix来简化turtle,下面的代码将指定prefix，并保存到文件1.rdf里：</p>
<pre><code>    model.setNsPrefix( &quot;vCard&quot;, &quot;http://www.w3.org/2001/vcard-rdf/3.0#&quot; );    model.setNsPrefix( &quot;rdf&quot;, &quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot; );    try &#123;        model.write(new FileOutputStream(&quot;1.rdf&quot;),&quot;TURTLE&quot;);    &#125; catch (FileNotFoundException e) &#123;        e.printStackTrace();    &#125;
</code></pre>
<p>结果：</p>
<pre><code>@prefix rdf:   &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#&gt; .
@prefix vCard: &lt;http://www.w3.org/2001/vcard-rdf/3.0#&gt; .

&lt;http://somewhere/JohnSmith&gt;    vCard:FN  &quot;John Smith&quot; ;    vCard:N   [ vCard:Family  &quot;Smith&quot; ;                vCard:Given   &quot;John&quot;              ] .
</code></pre>
<h4 id="读取rdf"><a href="#读取rdf" class="headerlink" title="读取rdf"></a>读取rdf</h4><p>Mode的read(Reader reader, String base)方法，提供 读取RDF文件的功能：</p>
<pre><code>    static final String inputFileName  = &quot;1.rdf&quot;;
                              
    public static void main (String args[]) &#123;
        // create an empty model
        Model model = ModelFactory.createDefaultModel();

        InputStream in = FileManager.get().open( inputFileName );
        if (in == null) &#123;
            throw new IllegalArgumentException( &quot;File: &quot; + inputFileName + &quot; not found&quot;);
        &#125;
        
        // read the RDF/XML file
        model.read(in, &quot;&quot;,&quot;TURTLE&quot;);
                    
        // write it to standard out
        model.write(System.out);            
    &#125;
</code></pre>
<p>注意，read的时候，默认是读取XML，如果是其他格式，需要指定lang。</p>
<h4 id="从模型读取Resouce"><a href="#从模型读取Resouce" class="headerlink" title="从模型读取Resouce"></a>从模型读取Resouce</h4><p>一个resouce都有一个唯一的URI，我们可以通过URI来获取对应的Resouce：<br> 函数原型：</p>
<pre><code>    /**    Return a Resource instance with the given URI in this model. &lt;i&gt;This method    behaves identically to &lt;code&gt;createResource(String)&lt;/code&gt;&lt;/i&gt; and exists as    legacy: createResource is now capable of, and allowed to, reuse existing objects.&lt;p&gt;    Subsequent operations on the returned object may modify this model.   @return a resource instance   @param uri the URI of the resource*/Resource getResource(String uri) ;
</code></pre>
<p>获取到Resouce后，通过getRequiredProperty获取属性，如果一个属性包含多个值，可以使用listProperties获取。</p>
<pre><code> static final String inputFileName = &quot;1.rdf&quot;;
    static final String johnSmithURI = &quot;http://somewhere/JohnSmith&quot;;
    
    public static void main (String args[]) &#123;
        // create an empty model
        Model model = ModelFactory.createDefaultModel();
       
        // use the FileManager to find the input file
        InputStream in = FileManager.get().open(inputFileName);
        if (in == null) &#123;
            throw new IllegalArgumentException( &quot;File: &quot; + inputFileName + &quot; not found&quot;);
        &#125;
        
        // read the RDF/XML file
        model.read(new InputStreamReader(in), &quot;&quot;);
        
        // retrieve the Adam Smith vcard resource from the model
        Resource vcard = model.getResource(johnSmithURI);

        // retrieve the value of the N property
        Resource name = (Resource) vcard.getRequiredProperty(VCARD.N)
                                        .getObject();
        // retrieve the given name property
        String fullName = vcard.getRequiredProperty(VCARD.FN)
                               .getString();
        // add two nick name properties to vcard
        vcard.addProperty(VCARD.NICKNAME, &quot;Smithy&quot;)
             .addProperty(VCARD.NICKNAME, &quot;Adman&quot;);
        
        // set up the output
        System.out.println(&quot;The nicknames of \&quot;&quot; + fullName + &quot;\&quot; are:&quot;);
        // list the nicknames
        StmtIterator iter = vcard.listProperties(VCARD.NICKNAME);
        while (iter.hasNext()) &#123;
            System.out.println(&quot;    &quot; + iter.nextStatement().getObject()
                                            .toString());
        &#125;

        try &#123;
            model.write(new FileOutputStream(&quot;1.rdf&quot;));
        &#125; catch (FileNotFoundException e) &#123;
            e.printStackTrace();
        &#125;
    &#125;
</code></pre>
<h4 id="查询模型"><a href="#查询模型" class="headerlink" title="查询模型"></a>查询模型</h4><p>可以通过listResourcesWithProperty查询包含Property的数据：</p>
<pre><code>    ResIterator iter = model.listResourcesWithProperty(VCARD.FN);
        if (iter.hasNext()) &#123;
            System.out.println(&quot;The database contains vcards for:&quot;);
            while (iter.hasNext()) &#123;
                System.out.println(&quot;  &quot; + iter.nextResource()
                                              .getRequiredProperty(VCARD.FN)
                                              .getString() );
            &#125;
        &#125; else &#123;
            System.out.println(&quot;No vcards were found in the database&quot;);
        &#125;        
</code></pre>
<p>通过listStatements(SimpleSelector)查询Statement：</p>
<pre><code>        // select all the resources with a VCARD.FN property
        // whose value ends with &quot;Smith&quot;
        StmtIterator iter = model.listStatements(
            new 
                SimpleSelector(null, VCARD.FN, (RDFNode) null) &#123;
                    @Override
                    public boolean selects(Statement s) &#123;
                            return s.getString().endsWith(&quot;Smith&quot;);
                    &#125;
                &#125;);
        if (iter.hasNext()) &#123;
            System.out.println(&quot;The database contains vcards for:&quot;);
            while (iter.hasNext()) &#123;
                System.out.println(&quot;  &quot; + iter.nextStatement()
                                              .getString());
            &#125;
        &#125; else &#123;
            System.out.println(&quot;No Smith&#39;s were found in the database&quot;);
        &#125;     
</code></pre>
<h4 id="模型合并"><a href="#模型合并" class="headerlink" title="模型合并"></a>模型合并</h4><p>可以通过union合并两个模型：</p>
<p><img src="https://jena.apache.org/tutorials/figures/fig4.png" alt="enter description here"><br><img src="https://jena.apache.org/tutorials/figures/fig5.png" alt="enter description here"></p>
<p>合并后：<br><img src="http://oyqmmpkcm.bkt.clouddn.com/1524907704194.jpg" alt="enter description here" title="1524907704194"></p>
<h2 id="来源"><a href="#来源" class="headerlink" title="来源"></a>来源</h2><ul>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/32122644">知识图谱基础之RDF，RDFS与OWL</a></li>
<li></li>
</ul>
<hr>
<blockquote>
<p>作者：Jadepeng<br> 出处：jqpeng的技术记事本–<a target="_blank" rel="noopener" href="http://www.cnblogs.com/xiaoqi">http://www.cnblogs.com/xiaoqi</a><br> 您的支持是对博主最大的鼓励，感谢您的认真阅读。<br> 本文版权归作者所有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文连接，否则保留追究法律责任的权利。</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.iflyresearch.com/2018/04/16/jqpeng-%E6%96%B0%E5%9E%8B%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91%E5%B7%A5%E7%A8%8B%E5%B8%88%E7%9A%84%E4%B8%89%E4%B8%AA%E5%A2%83%E7%95%8C%20%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E5%B7%A5%E7%A8%8B%E5%B8%88%E5%A6%82%E4%BD%95%E5%BF%AB%E9%80%9F%E8%BD%AC%E5%89%8D%E7%AB%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="JadePeng">
      <meta itemprop="description" content="JadePeng的技术笔记本">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JadePeng的技术笔记本">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2018/04/16/jqpeng-%E6%96%B0%E5%9E%8B%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91%E5%B7%A5%E7%A8%8B%E5%B8%88%E7%9A%84%E4%B8%89%E4%B8%AA%E5%A2%83%E7%95%8C%20%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E5%B7%A5%E7%A8%8B%E5%B8%88%E5%A6%82%E4%BD%95%E5%BF%AB%E9%80%9F%E8%BD%AC%E5%89%8D%E7%AB%AF/" class="post-title-link" itemprop="url">新型前端开发工程师的三个境界 后端开发工程师如何快速转前端</a>
        </h2>

        <div class="post-meta">

         
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-04-16 19:14:00" itemprop="dateCreated datePublished" datetime="2018-04-16T19:14:00+08:00">2018-04-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 17:44:20" itemprop="dateModified" datetime="2021-05-14T17:44:20+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%8D%9A%E5%AE%A2/" itemprop="url" rel="index"><span itemprop="name">博客</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%8D%9A%E5%AE%A2/jqpeng/" itemprop="url" rel="index"><span itemprop="name">jqpeng</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>文章作者:jqpeng<br>原文链接: <a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaoqi/p/front-dev.html">新型前端开发工程师的三个境界 后端开发工程师如何快速转前端</a></p>
<p>初入软件开发这一行时，当时还没有前后端分离这个概念，所有的开发工程师既能写html，也能写后台服务，随着技术的发展，前后端分离成为趋势，目前团队不少人能熟悉的写java后台服务，却难以hold住前端页面的开发，前端页面开发成为瓶颈。针对这个情况，筹划了一个前端培训专题，让后端的同事可以通过学习快速掌握前端开发技能。</p>
<h2 id="愿景"><a href="#愿景" class="headerlink" title="愿景"></a>愿景</h2><ul>
<li>培养全栈工程师，前后端均可以Hold住</li>
</ul>
<h2 id="前端技能梳理"><a href="#前端技能梳理" class="headerlink" title="前端技能梳理"></a>前端技能梳理</h2><p>我们把前端同事做的事情简单的梳理下，大概可以分为：</p>
<h3 id="效果图-gt-HTML还原"><a href="#效果图-gt-HTML还原" class="headerlink" title="效果图 -&gt; HTML还原"></a>效果图 -&gt; HTML还原</h3><p>将UED设计的效果图还原为页面，这个也是以前狭义的UI完成的工作。梳理下这个工作需要的技能：</p>
<ul>
<li>熟悉HTML\CSS、熟悉常见布局，div+css</li>
<li>熟悉浏览器兼容</li>
<li>熟悉PS切图</li>
</ul>
<p>随着前端UI框架的发展，当你使用bootstrap、elements、iview这类框架时，80%的功能开发可以不需要这一步，因此一个小团队有1个这样的工程师就OK了。</p>
<h3 id="HTML-gt-应用"><a href="#HTML-gt-应用" class="headerlink" title="HTML-&gt;应用"></a>HTML-&gt;应用</h3><p>单独的HTML是缺乏灵魂的，还需要绑定数据，这样才是一个完整的页面。在前后端未分离的时代，通常是后端基于前端还原的html来进行开发，通过模板技术绑定数据。而随着ajax的兴起，前端 MVVM框架的流行，前后端分离，数据绑定工作前移到前端，因此前端的职责之一就是调用后端的服务，并显示到页面上。</p>
<p>同样的，梳理下这个工作需要的技能：</p>
<ul>
<li>了解或者熟悉html</li>
<li>熟悉HTTP</li>
<li>基本的javascript应用</li>
<li>熟悉一个js框架的应用，比如jq、vue.js</li>
</ul>
<p>一个合格的后端，在熟悉javascript的情况下，可以很快掌握。</p>
<h3 id="复杂的单页应用"><a href="#复杂的单页应用" class="headerlink" title="复杂的单页应用"></a>复杂的单页应用</h3><p>现在流行一个词“大前端”，前端更大的挑战就是构建复杂的单页应用，比如易企秀的H5编辑器，单个页面里包含了非常多的功能和逻辑，这类页面有个特点：</p>
<ul>
<li>包含复杂的业务逻辑</li>
<li>通常需要上千行的javascript代码</li>
<li>需要良好的设计模式来组织和维护代码，MVC\MVVM等概念在前端运用</li>
</ul>
<p>而随着技术的发展，javascript可以用来开发手机端app（react-native、weex），本质上来说还是开发复杂的单页应用。特别是使用vuex这类状态管理库时，如果懂的后端的数据库概念，可以事半功倍的理解其原理。</p>
<p>总结一下，开发复杂的单页应用，需要具备的技能：</p>
<ul>
<li>熟悉数据结构和算法</li>
<li>熟悉常用的设计模式</li>
<li>OOP思维</li>
<li>模块化开发</li>
<li>db思维</li>
<li>熟悉javascript，熟悉es2015\es2017</li>
</ul>
<p>一句话总结起来，<strong>复杂的前端应用开发所需要的技能，恰恰是后端开发所擅长的</strong>，只是编程语言从java、c#变成了javascript，仅此而已。</p>
<h2 id="新型前后端一体化工程师的三个境界"><a href="#新型前后端一体化工程师的三个境界" class="headerlink" title="新型前后端一体化工程师的三个境界"></a>新型前后端一体化工程师的三个境界</h2><p>怎么来评价一个人的前端能力，简单起见，划分为三个境界：</p>
<ul>
<li><p>第一层（必须具备）</p>
<ul>
<li>依葫芦画瓢</li>
<li>可以根据还原的HTML或者UI框架，实现简单页面的开发和数据绑定</li>
<li>熟悉HTML常见标签、CSS盒子模型、CSS优先级，常见布局</li>
<li>会使用Vue.js/jquery，Iview、Element等工具库</li>
</ul>
</li>
<li><p>第二层（努力可以达到）</p>
<ul>
<li>可以熟练的开发单页应用</li>
<li>javascript了然于心，es2015\2016信手拈来</li>
<li>熟悉Vue、React、angular、知道各自的优缺点，根据需要选择合理的方案</li>
<li>跟踪前端发展趋势、不盲从、独立思考</li>
</ul>
</li>
<li><p>第三层（尽量追求，需要时间和积累）</p>
<ul>
<li>融会贯通，可以改造轮子、造新的轮子提升效率</li>
<li>在公司、业界前端形成影响力</li>
</ul>
</li>
</ul>
<h2 id="培训规划"><a href="#培训规划" class="headerlink" title="培训规划"></a>培训规划</h2><p>最后来定一下培训的规划。</p>
<h3 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h3><ul>
<li>所有人达到第一层境界</li>
<li>骨干需要达到第二层</li>
</ul>
<h3 id="培训内容"><a href="#培训内容" class="headerlink" title="培训内容"></a>培训内容</h3><h4 id="课时1：HTTP-HTML-CSS基础-常见布局-HTML5-CSS3"><a href="#课时1：HTTP-HTML-CSS基础-常见布局-HTML5-CSS3" class="headerlink" title="课时1：HTTP+HTML+CSS基础+常见布局+HTML5+CSS3"></a>课时1：HTTP+HTML+CSS基础+常见布局+HTML5+CSS3</h4><ul>
<li>HTTP<ul>
<li>HTTP get/post/put/delete</li>
<li>HTTP响应码</li>
<li>chrome F12 network使用</li>
</ul>
</li>
<li>html块元素、内联元素、表单</li>
<li>CSS 与盒子模型</li>
<li>响应式布局</li>
<li>H5语义标签，audio，canvas</li>
<li>CSS3动画</li>
</ul>
<h4 id="课时2：javascript-基础"><a href="#课时2：javascript-基础" class="headerlink" title="课时2：javascript 基础"></a>课时2：javascript 基础</h4><ul>
<li>数据类型，数组、对象，表达式、条件、循环等</li>
<li>javascript常用对象</li>
<li>DOM编程</li>
<li>AJAX、jsonp</li>
<li>正则、表单验证</li>
</ul>
<h4 id="课时3：javascript进阶"><a href="#课时3：javascript进阶" class="headerlink" title="课时3：javascript进阶"></a>课时3：javascript进阶</h4><ul>
<li>深入js<ul>
<li>模块化、AMD，require.js</li>
<li>作用域链</li>
<li>原型链与继承</li>
<li>闭包</li>
<li>OOP</li>
</ul>
</li>
<li>es2015/2017<ul>
<li>箭头函数等新语法糖</li>
</ul>
</li>
<li>TypeScript</li>
</ul>
<h4 id="课时4：项目框架应用-Vue-js-IView使用培训"><a href="#课时4：项目框架应用-Vue-js-IView使用培训" class="headerlink" title="课时4：项目框架应用 Vue.js +IView使用培训"></a>课时4：项目框架应用 Vue.js +IView使用培训</h4><ul>
<li>Vue.js 渐进式理解</li>
<li>Vue.js 模板绑定</li>
<li>Vue.js 组件</li>
<li>Vue.js 单页应用</li>
<li>Vuex 状态管理</li>
<li>Vue Router</li>
<li>IView 组件库介绍</li>
<li>项目案例讲解</li>
</ul>
<h4 id="课时5：基于Nodejs的前端新生态"><a href="#课时5：基于Nodejs的前端新生态" class="headerlink" title="课时5：基于Nodejs的前端新生态"></a>课时5：基于Nodejs的前端新生态</h4><ul>
<li>NodeJs原理、历史、发展</li>
<li>webpack</li>
<li>less</li>
<li>代码质量eslint</li>
</ul>
<h4 id="课时6：-vue-js与手机app、微信小程序开发"><a href="#课时6：-vue-js与手机app、微信小程序开发" class="headerlink" title="课时6： vue.js与手机app、微信小程序开发"></a>课时6： vue.js与手机app、微信小程序开发</h4><ul>
<li>使用vue.js+weex开发手机app</li>
<li>微信小程序开发</li>
</ul>
<p>最后，欢迎大家拍砖和提出建议。</p>
<hr>
<blockquote>
<p>作者：Jadepeng<br> 出处：jqpeng的技术记事本–<a target="_blank" rel="noopener" href="http://www.cnblogs.com/xiaoqi">http://www.cnblogs.com/xiaoqi</a><br> 您的支持是对博主最大的鼓励，感谢您的认真阅读。<br> 本文版权归作者所有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文连接，否则保留追究法律责任的权利。</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.iflyresearch.com/2018/04/14/jqpeng-axios%E4%BB%8B%E7%BB%8D%E4%B8%8E%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E%20axios%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="JadePeng">
      <meta itemprop="description" content="JadePeng的技术笔记本">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JadePeng的技术笔记本">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2018/04/14/jqpeng-axios%E4%BB%8B%E7%BB%8D%E4%B8%8E%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E%20axios%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/" class="post-title-link" itemprop="url">axios介绍与使用说明 axios中文文档</a>
        </h2>

        <div class="post-meta">

         
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-04-14 12:00:00" itemprop="dateCreated datePublished" datetime="2018-04-14T12:00:00+08:00">2018-04-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 17:44:20" itemprop="dateModified" datetime="2021-05-14T17:44:20+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%8D%9A%E5%AE%A2/" itemprop="url" rel="index"><span itemprop="name">博客</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%8D%9A%E5%AE%A2/jqpeng/" itemprop="url" rel="index"><span itemprop="name">jqpeng</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>11k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>10 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>文章作者:jqpeng<br>原文链接: <a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaoqi/p/axios.html">axios介绍与使用说明 axios中文文档</a></p>
<p>本周在做一个使用vuejs的前端项目，访问后端服务使用axios库，这里对照官方文档，简单记录下，也方便大家参考。</p>
<p>Axios 是一个基于  <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">Promise</a> 的 HTTP 库，可以用在浏览器和 node.js 中。github开源地址<a target="_blank" rel="noopener" href="https://github.com/axios/axios">https://github.com/axios/axios</a></p>
<h2 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h2><ul>
<li>在浏览器中创建 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest">XMLHttpRequests</a></li>
<li>在 node.js 则创建 <a target="_blank" rel="noopener" href="http://nodejs.org/api/http.html">http</a> 请求</li>
<li>支持 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">Promise</a> API</li>
<li>支持拦截请求和响应</li>
<li>转换请求和响应数据</li>
<li>取消请求</li>
<li>自动转换 JSON 数据</li>
<li>客户端支持防御 <a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/Cross-site_request_forgery">XSRF</a></li>
</ul>
<h2 id="浏览器支持"><a href="#浏览器支持" class="headerlink" title="浏览器支持"></a>浏览器支持</h2><p>支持Chrome、火狐、Edge、IE8+等浏览器</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>使用 npm安装:</p>
<pre><code>$ npm install axios
</code></pre>
<p>使用 bower:</p>
<pre><code>$ bower install axios
</code></pre>
<p>或者直接使用 cdn:</p>
<pre><code>&lt;script src=&quot;https://unpkg.com/axios/dist/axios.min.js&quot;&gt;&lt;/script&gt;
</code></pre>
<h2 id="使用举例"><a href="#使用举例" class="headerlink" title="使用举例"></a>使用举例</h2><p>执行 <code>GET</code> 请求</p>
<pre><code>// 为给定 ID 的 user 创建请求
axios.get(&#39;/user?ID=12345&#39;)
  .then(function (response) &#123;
    console.log(response);
  &#125;)
  .catch(function (error) &#123;
    console.log(error);
  &#125;);

// GET 参数可以放到params里（推荐）
axios.get(&#39;/user&#39;, &#123;
    params: &#123;
      ID: 12345
    &#125;
  &#125;)
  .then(function (response) &#123;
    console.log(response);
  &#125;)
  .catch(function (error) &#123;
    console.log(error);
  &#125;);

// 还可以使用ECMAScript 2017里的async/await，添加 `async` keyword to your outer function/method.
async function getUser() &#123;
  try &#123;
    const response = await axios.get(&#39;/user?ID=12345&#39;);
    console.log(response);
  &#125; catch (error) &#123;
    console.error(error);
  &#125;
&#125;
</code></pre>
<blockquote>
<p>async/await 是 ECMAScript 2017新提供的功能 ，Internet Explorer 和一些旧的浏览器并不支持</p>
</blockquote>
<p>执行 <code>POST</code> 请求</p>
<pre><code>axios.post(&#39;/user&#39;, &#123;
    firstName: &#39;Fred&#39;,
    lastName: &#39;Flintstone&#39;
  &#125;)
  .then(function (response) &#123;
    console.log(response);
  &#125;)
  .catch(function (error) &#123;
    console.log(error);
  &#125;);
</code></pre>
<p>执行多个并发请求</p>
<pre><code>function getUserAccount() &#123;
  return axios.get(&#39;/user/12345&#39;);
&#125;

function getUserPermissions() &#123;
  return axios.get(&#39;/user/12345/permissions&#39;);
&#125;
axios.all([getUserAccount(), getUserPermissions()])
  .then(axios.spread(function (acct, perms) &#123;
    // 两个请求现在都执行完成
  &#125;));
</code></pre>
<h2 id="axios-API"><a href="#axios-API" class="headerlink" title="axios API"></a>axios API</h2><p>可以通过向 <code>axios</code> 传递相关配置来创建请求</p>
<h5 id="axios-config"><a href="#axios-config" class="headerlink" title="axios(config)"></a>axios(config)</h5><pre><code>// 发送 POST 请求
axios(&#123;
  method: &#39;post&#39;,
  url: &#39;/user/12345&#39;,
  data: &#123;
    firstName: &#39;Fred&#39;,
    lastName: &#39;Flintstone&#39;
  &#125;
&#125;);
//  GET 请求远程图片
axios(&#123;
  method:&#39;get&#39;,
  url:&#39;http://bit.ly/2mTM3nY&#39;,
  responseType:&#39;stream&#39;
&#125;)
  .then(function(response) &#123;
  response.data.pipe(fs.createWriteStream(&#39;ada_lovelace.jpg&#39;))
&#125;);
</code></pre>
<h5 id="axios-url-config"><a href="#axios-url-config" class="headerlink" title="axios(url[, config])"></a>axios(url[, config])</h5><pre><code>// 发送 GET 请求（默认的方法）
axios(&#39;/user/12345&#39;);
</code></pre>
<h3 id="请求方法的别名"><a href="#请求方法的别名" class="headerlink" title="请求方法的别名"></a>请求方法的别名</h3><p>为方便使用，官方为所有支持的请求方法提供了别名，可以直接使用别名来发起请求：</p>
<h5 id="axios-request-config"><a href="#axios-request-config" class="headerlink" title="axios.request(config)"></a>axios.request(config)</h5><h5 id="axios-get-url-config"><a href="#axios-get-url-config" class="headerlink" title="axios.get(url[, config])"></a>axios.get(url[, config])</h5><h5 id="axios-delete-url-config"><a href="#axios-delete-url-config" class="headerlink" title="axios.delete(url[, config])"></a>axios.delete(url[, config])</h5><h5 id="axios-head-url-config"><a href="#axios-head-url-config" class="headerlink" title="axios.head(url[, config])"></a>axios.head(url[, config])</h5><h5 id="axios-post-url-data-config"><a href="#axios-post-url-data-config" class="headerlink" title="axios.post(url[, data[, config]])"></a>axios.post(url[, data[, config]])</h5><h5 id="axios-put-url-data-config"><a href="#axios-put-url-data-config" class="headerlink" title="axios.put(url[, data[, config]])"></a>axios.put(url[, data[, config]])</h5><h5 id="axios-patch-url-data-config"><a href="#axios-patch-url-data-config" class="headerlink" title="axios.patch(url[, data[, config]])"></a>axios.patch(url[, data[, config]])</h5><h6 id="NOTE"><a href="#NOTE" class="headerlink" title="NOTE"></a>NOTE</h6><p>在使用别名方法时， <code>url</code>、<code>method</code>、<code>data</code> 这些属性都不必在配置中指定。</p>
<h3 id="并发"><a href="#并发" class="headerlink" title="并发"></a>并发</h3><p>处理并发请求的助手函数</p>
<h5 id="axios-all-iterable"><a href="#axios-all-iterable" class="headerlink" title="axios.all(iterable)"></a>axios.all(iterable)</h5><h5 id="axios-spread-callback"><a href="#axios-spread-callback" class="headerlink" title="axios.spread(callback)"></a>axios.spread(callback)</h5><h3 id="创建实例"><a href="#创建实例" class="headerlink" title="创建实例"></a>创建实例</h3><p>可以使用自定义配置新建一个 axios 实例</p>
<h5 id="axios-create-config"><a href="#axios-create-config" class="headerlink" title="axios.create([config])"></a>axios.create([config])</h5><pre><code>const instance = axios.create(&#123;
  baseURL: &#39;https://some-domain.com/api/&#39;,
  timeout: 1000,
  headers: &#123;&#39;X-Custom-Header&#39;: &#39;foobar&#39;&#125;
&#125;);
</code></pre>
<h3 id="实例方法"><a href="#实例方法" class="headerlink" title="实例方法"></a>实例方法</h3><p>以下是可用的实例方法。指定的配置将与实例的配置合并</p>
<h5 id="axios-request-config-1"><a href="#axios-request-config-1" class="headerlink" title="axios#request(config)"></a>axios#request(config)</h5><h5 id="axios-get-url-config-1"><a href="#axios-get-url-config-1" class="headerlink" title="axios#get(url[, config])"></a>axios#get(url[, config])</h5><h5 id="axios-delete-url-config-1"><a href="#axios-delete-url-config-1" class="headerlink" title="axios#delete(url[, config])"></a>axios#delete(url[, config])</h5><h5 id="axios-head-url-config-1"><a href="#axios-head-url-config-1" class="headerlink" title="axios#head(url[, config])"></a>axios#head(url[, config])</h5><h5 id="axios-post-url-data-config-1"><a href="#axios-post-url-data-config-1" class="headerlink" title="axios#post(url[, data[, config]])"></a>axios#post(url[, data[, config]])</h5><h5 id="axios-put-url-data-config-1"><a href="#axios-put-url-data-config-1" class="headerlink" title="axios#put(url[, data[, config]])"></a>axios#put(url[, data[, config]])</h5><h5 id="axios-patch-url-data-config-1"><a href="#axios-patch-url-data-config-1" class="headerlink" title="axios#patch(url[, data[, config]])"></a>axios#patch(url[, data[, config]])</h5><h2 id="请求配置项"><a href="#请求配置项" class="headerlink" title="请求配置项"></a>请求配置项</h2><p>下面是创建请求时可用的配置选项，注意只有 <code>url</code> 是必需的。如果没有指定 <code>method</code>，请求将默认使用 <code>get</code> 方法。</p>
<pre><code>&#123;
  // `url` 是用于请求的服务器 URL
  url: &quot;/user&quot;,

  // `method` 是创建请求时使用的方法
  method: &quot;get&quot;, // 默认是 get

  // `baseURL` 将自动加在 `url` 前面，除非 `url` 是一个绝对 URL。
  // 它可以通过设置一个 `baseURL` 便于为 axios 实例的方法传递相对 URL
  baseURL: &quot;https://some-domain.com/api/&quot;,

  // `transformRequest` 允许在向服务器发送前，修改请求数据
  // 只能用在 &quot;PUT&quot;, &quot;POST&quot; 和 &quot;PATCH&quot; 这几个请求方法
  // 后面数组中的函数必须返回一个字符串，或 ArrayBuffer，或 Stream
  transformRequest: [function (data) &#123;
    // 对 data 进行任意转换处理

    return data;
  &#125;],

  // `transformResponse` 在传递给 then/catch 前，允许修改响应数据
  transformResponse: [function (data) &#123;
    // 对 data 进行任意转换处理

    return data;
  &#125;],

  // `headers` 是即将被发送的自定义请求头
  headers: &#123;&quot;X-Requested-With&quot;: &quot;XMLHttpRequest&quot;&#125;,

  // `params` 是即将与请求一起发送的 URL 参数
  // 必须是一个无格式对象(plain object)或 URLSearchParams 对象
  params: &#123;
    ID: 12345
  &#125;,

  // `paramsSerializer` 是一个负责 `params` 序列化的函数
  // (e.g. https://www.npmjs.com/package/qs, http://api.jquery.com/jquery.param/)
  paramsSerializer: function(params) &#123;
    return Qs.stringify(params, &#123;arrayFormat: &quot;brackets&quot;&#125;)
  &#125;,

  // `data` 是作为请求主体被发送的数据
  // 只适用于这些请求方法 &quot;PUT&quot;, &quot;POST&quot;, 和 &quot;PATCH&quot;
  // 在没有设置 `transformRequest` 时，必须是以下类型之一：
  // - string, plain object, ArrayBuffer, ArrayBufferView, URLSearchParams
  // - 浏览器专属：FormData, File, Blob
  // - Node 专属： Stream
  data: &#123;
    firstName: &quot;Fred&quot;
  &#125;,

  // `timeout` 指定请求超时的毫秒数(0 表示无超时时间)
  // 如果请求话费了超过 `timeout` 的时间，请求将被中断
  timeout: 1000,

  // `withCredentials` 表示跨域请求时是否需要使用凭证
  withCredentials: false, // 默认的

  // `adapter` 允许自定义处理请求，以使测试更轻松
  // 返回一个 promise 并应用一个有效的响应 (查阅 [response docs](#response-api)).
  adapter: function (config) &#123;
    /* ... */
  &#125;,

  // `auth` 表示应该使用 HTTP 基础验证，并提供凭据
  // 这将设置一个 `Authorization` 头，覆写掉现有的任意使用 `headers` 设置的自定义 `Authorization`头
  auth: &#123;
    username: &quot;janedoe&quot;,
    password: &quot;s00pers3cret&quot;
  &#125;,

  // `responseType` 表示服务器响应的数据类型，可以是 &quot;arraybuffer&quot;, &quot;blob&quot;, &quot;document&quot;, &quot;json&quot;, &quot;text&quot;, &quot;stream&quot;
  responseType: &quot;json&quot;, // 默认的

  // `xsrfCookieName` 是用作 xsrf token 的值的cookie的名称
  xsrfCookieName: &quot;XSRF-TOKEN&quot;, // default

  // `xsrfHeaderName` 是承载 xsrf token 的值的 HTTP 头的名称
  xsrfHeaderName: &quot;X-XSRF-TOKEN&quot;, // 默认的

  // `onUploadProgress` 允许为上传处理进度事件
  onUploadProgress: function (progressEvent) &#123;
    // 对原生进度事件的处理
  &#125;,

  // `onDownloadProgress` 允许为下载处理进度事件
  onDownloadProgress: function (progressEvent) &#123;
    // 对原生进度事件的处理
  &#125;,

  // `maxContentLength` 定义允许的响应内容的最大尺寸
  maxContentLength: 2000,

  // `validateStatus` 定义对于给定的HTTP 响应状态码是 resolve 或 reject  promise 。如果 `validateStatus` 返回 `true` (或者设置为 `null` 或 `undefined`)，promise 将被 resolve; 否则，promise 将被 rejecte
  validateStatus: function (status) &#123;
    return status &amp;gt;= 200 &amp;amp;&amp;amp; status &amp;lt; 300; // 默认的
  &#125;,

  // `maxRedirects` 定义在 node.js 中 follow 的最大重定向数目
  // 如果设置为0，将不会 follow 任何重定向
  maxRedirects: 5, // 默认的

  // `httpAgent` 和 `httpsAgent` 分别在 node.js 中用于定义在执行 http 和 https 时使用的自定义代理。允许像这样配置选项：
  // `keepAlive` 默认没有启用
  httpAgent: new http.Agent(&#123; keepAlive: true &#125;),
  httpsAgent: new https.Agent(&#123; keepAlive: true &#125;),

  // &quot;proxy&quot; 定义代理服务器的主机名称和端口
  // `auth` 表示 HTTP 基础验证应当用于连接代理，并提供凭据
  // 这将会设置一个 `Proxy-Authorization` 头，覆写掉已有的通过使用 `header` 设置的自定义 `Proxy-Authorization` 头。
  proxy: &#123;
    host: &quot;127.0.0.1&quot;,
    port: 9000,
    auth: : &#123;
      username: &quot;mikeymike&quot;,
      password: &quot;rapunz3l&quot;
    &#125;
  &#125;,

  // `cancelToken` 指定用于取消请求的 cancel token
  // （查看后面的 Cancellation 这节了解更多）
  cancelToken: new CancelToken(function (cancel) &#123;
  &#125;)
&#125;
</code></pre>
<h2 id="响应结构"><a href="#响应结构" class="headerlink" title="响应结构"></a>响应结构</h2><p>axios请求的响应包含以下信息：</p>
<pre><code>&#123;
  // `data` 由服务器提供的响应
  data: &#123;&#125;,

  // `status`  HTTP 状态码
  status: 200,

  // `statusText` 来自服务器响应的 HTTP 状态信息
  statusText: &quot;OK&quot;,

  // `headers` 服务器响应的头
  headers: &#123;&#125;,

  // `config` 是为请求提供的配置信息
  config: &#123;&#125;
&#125;
</code></pre>
<p>使用 <code>then</code> 时，会接收下面这样的响应：</p>
<pre><code>axios.get(&quot;/user/12345&quot;)
  .then(function(response) &#123;
    console.log(response.data);
    console.log(response.status);
    console.log(response.statusText);
    console.log(response.headers);
    console.log(response.config);
  &#125;);
</code></pre>
<p>在使用 <code>catch</code> 时，或传递 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/then">rejection callback</a> 作为 <code>then</code> 的第二个参数时，响应可以通过 <code>error</code> 对象可被使用，正如在错误处理这一节所讲。</p>
<h2 id="配置的默认值-defaults"><a href="#配置的默认值-defaults" class="headerlink" title="配置的默认值/defaults"></a>配置的默认值/defaults</h2><p>你可以指定将被用在各个请求的配置默认值</p>
<h3 id="全局的-axios-默认值"><a href="#全局的-axios-默认值" class="headerlink" title="全局的 axios 默认值"></a>全局的 axios 默认值</h3><pre><code>axios.defaults.baseURL = &quot;https://api.example.com&quot;;
axios.defaults.headers.common[&quot;Authorization&quot;] = AUTH_TOKEN;
axios.defaults.headers.post[&quot;Content-Type&quot;] = &quot;application/x-www-form-urlencoded&quot;;
</code></pre>
<h3 id="自定义实例默认值"><a href="#自定义实例默认值" class="headerlink" title="自定义实例默认值"></a>自定义实例默认值</h3><pre><code>// 创建实例时设置配置的默认值
var instance = axios.create(&#123;
  baseURL: &quot;https://api.example.com&quot;
&#125;);

// 在实例已创建后修改默认值
instance.defaults.headers.common[&quot;Authorization&quot;] = AUTH_TOKEN;
</code></pre>
<h3 id="配置的优先级"><a href="#配置的优先级" class="headerlink" title="配置的优先级"></a>配置的优先级</h3><p>配置会以一个优先顺序进行合并。</p>
<p>请求的config &gt; 实例的 <code>defaults</code> 属性 &gt; 库默认值：</p>
<pre><code>// 使用由库提供的配置的默认值来创建实例
// 此时超时配置的默认值是 `0`
var instance = axios.create();

// 覆写库的超时默认值
// 现在，在超时前，所有请求都会等待 2.5 秒
instance.defaults.timeout = 2500;

// 为已知需要花费很长时间的请求覆写超时设置
instance.get(&quot;/longRequest&quot;, &#123;
  timeout: 5000
&#125;);
</code></pre>
<h2 id="拦截器"><a href="#拦截器" class="headerlink" title="拦截器"></a>拦截器</h2><p>可以自定义拦截器，在在请求或响应被 <code>then</code> 或 <code>catch</code> 处理前拦截它们。</p>
<pre><code>// 添加请求拦截器
axios.interceptors.request.use(function (config) &#123;
    // 在发送请求之前做些什么
    return config;
  &#125;, function (error) &#123;
    // 对请求错误做些什么
    return Promise.reject(error);
  &#125;);

// 添加响应拦截器
axios.interceptors.response.use(function (response) &#123;
    // 对响应数据做点什么
    return response;
  &#125;, function (error) &#123;
    // 对响应错误做点什么
    return Promise.reject(error);
  &#125;);
</code></pre>
<p>如果你想在稍后移除拦截器，可以这样：</p>
<pre><code>var myInterceptor = axios.interceptors.request.use(function () &#123;/*...*/&#125;);
axios.interceptors.request.eject(myInterceptor);
</code></pre>
<p>可以为自定义 axios 实例添加拦截器</p>
<pre><code>var instance = axios.create();
instance.interceptors.request.use(function () &#123;/*...*/&#125;);
</code></pre>
<h2 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h2><pre><code>axios.get(&quot;/user/12345&quot;)
  .catch(function (error) &#123;
    if (error.response) &#123;
      // 请求已发出，但服务器响应的状态码不在 2xx 范围内
      console.log(error.response.data);
      console.log(error.response.status);
      console.log(error.response.headers);
    &#125; else &#123;
      // Something happened in setting up the request that triggered an Error
      console.log(&quot;Error&quot;, error.message);
    &#125;
    console.log(error.config);
  &#125;);
</code></pre>
<p>可以使用 <code>validateStatus</code> 配置选项定义一个自定义 HTTP 状态码的错误范围。</p>
<pre><code>axios.get(&quot;/user/12345&quot;, &#123;
  validateStatus: function (status) &#123;
    return status &lt; 500; // 状态码在大于或等于500时才会 reject
  &#125;
&#125;)
</code></pre>
<h2 id="取消请求"><a href="#取消请求" class="headerlink" title="取消请求"></a>取消请求</h2><p>使用 <em>cancel token</em> 取消请求</p>
<blockquote>
<p>Axios 的 cancel token API 基于<a target="_blank" rel="noopener" href="https://github.com/tc39/proposal-cancelable-promises">cancelable promises proposal</a></p>
</blockquote>
<p>可以使用 <code>CancelToken.source</code> 工厂方法创建 cancel token，像这样：</p>
<pre><code>const CancelToken = axios.CancelToken;
const source = CancelToken.source();

axios.get(&#39;/user/12345&#39;, &#123;
  cancelToken: source.token
&#125;).catch(function(thrown) &#123;
  if (axios.isCancel(thrown)) &#123;
    console.log(&#39;Request canceled&#39;, thrown.message);
  &#125; else &#123;
    // handle error
  &#125;
&#125;);

axios.post(&#39;/user/12345&#39;, &#123;
  name: &#39;new name&#39;
&#125;, &#123;
  cancelToken: source.token
&#125;)

// cancel the request (the message parameter is optional)
source.cancel(&#39;Operation canceled by the user.&#39;);
</code></pre>
<p>还可以通过传递一个 executor 函数到 <code>CancelToken</code> 的构造函数来创建 cancel token：</p>
<pre><code>var CancelToken = axios.CancelToken;
var cancel;

axios.get(&quot;/user/12345&quot;, &#123;
  cancelToken: new CancelToken(function executor(c) &#123;
    // executor 函数接收一个 cancel 函数作为参数
    cancel = c;
  &#125;)
&#125;);

// 取消请求
cancel();
</code></pre>
<p>Note : 可以使用同一个 cancel token 取消多个请求</p>
<h2 id="请求时使用-application-x-www-form-urlencoded"><a href="#请求时使用-application-x-www-form-urlencoded" class="headerlink" title="请求时使用 application/x-www-form-urlencoded"></a>请求时使用 application/x-www-form-urlencoded</h2><p>axios会默认序列化  JavaScript 对象为 JSON. 如果想使用 application/x-www-form-urlencoded 格式，你可以使用下面的配置.</p>
<h3 id="浏览器"><a href="#浏览器" class="headerlink" title="浏览器"></a>浏览器</h3><p>在浏览器环境，你可以使用  URLSearchParams API ：:</p>
<pre><code>const params = new URLSearchParams();
params.append(&#39;param1&#39;, &#39;value1&#39;);
params.append(&#39;param2&#39;, &#39;value2&#39;);
axios.post(&#39;/foo&#39;, params);
</code></pre>
<blockquote>
<p>URLSearchParams不是所有的浏览器均支持</p>
</blockquote>
<p>除此之外，你可以使用qs库来编码数据:</p>
<pre><code>const qs = require(&#39;qs&#39;);
axios.post(&#39;/foo&#39;, qs.stringify(&#123; &#39;bar&#39;: 123 &#125;));

// Or in another way (ES6),

import qs from &#39;qs&#39;;
const data = &#123; &#39;bar&#39;: 123 &#125;;
const options = &#123;
  method: &#39;POST&#39;,
  headers: &#123; &#39;content-type&#39;: &#39;application/x-www-form-urlencoded&#39; &#125;,
  data: qs.stringify(data),
  url,
&#125;;
axios(options);
</code></pre>
<h3 id="Node-js环境"><a href="#Node-js环境" class="headerlink" title="Node.js环境"></a>Node.js环境</h3><p>在 node.js里, 可以使用 querystring module:</p>
<pre><code>const querystring = require(&#39;querystring&#39;);
axios.post(&#39;http://something.com/&#39;, querystring.stringify(&#123; foo: &#39;bar&#39; &#125;));
</code></pre>
<p>当然，同浏览器一样，你还可以使用 qs library.</p>
<h2 id="Promises"><a href="#Promises" class="headerlink" title="Promises"></a>Promises</h2><p>axios 依赖原生的 ES6 Promise 实现而<a target="_blank" rel="noopener" href="http://caniuse.com/promises">被支持</a>.<br> 如果你的环境不支持 ES6 Promise，你可以使用 <a target="_blank" rel="noopener" href="https://github.com/jakearchibald/es6-promise">polyfill</a>.</p>
<h2 id="TypeScript支持"><a href="#TypeScript支持" class="headerlink" title="TypeScript支持"></a>TypeScript支持</h2><p>axios 包含 <a target="_blank" rel="noopener" href="http://typescriptlang.org/">TypeScript</a> definitions.</p>
<pre><code>import axios from &quot;axios&quot;;
axios.get(&quot;/user?ID=12345&quot;);
</code></pre>
<h2 id="相关资源"><a href="#相关资源" class="headerlink" title="相关资源"></a>相关资源</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/mzabriskie/axios/blob/master/CHANGELOG.md">变更记录</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/mzabriskie/axios/blob/master/UPGRADE_GUIDE.md">升级指南</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/mzabriskie/axios/blob/master/ECOSYSTEM.md">生态</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/mzabriskie/axios/blob/master/CONTRIBUTING.md">贡献引导</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/mzabriskie/axios/blob/master/CODE_OF_CONDUCT.md">Code of Conduct</a></li>
</ul>
<h2 id="Credits"><a href="#Credits" class="headerlink" title="Credits"></a>Credits</h2><p>axios 受<a target="_blank" rel="noopener" href="https://angularjs.org/">Angular</a>.提供的<a target="_blank" rel="noopener" href="https://docs.angularjs.org/api/ng/service/$http">$http service</a> 启发而创建， 致力于以提供一个脱离于ng的 <code>$http</code>模块。</p>
<h2 id="开源协议"><a href="#开源协议" class="headerlink" title="开源协议"></a>开源协议</h2><p>采用MIT</p>
<hr>
<blockquote>
<p>作者：Jadepeng<br> 出处：jqpeng的技术记事本–<a target="_blank" rel="noopener" href="http://www.cnblogs.com/xiaoqi">http://www.cnblogs.com/xiaoqi</a><br> 您的支持是对博主最大的鼓励，感谢您的认真阅读。<br> 本文版权归作者所有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文连接，否则保留追究法律责任的权利。</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.iflyresearch.com/2018/04/04/jqpeng-Spring%20boot%20web%E7%A8%8B%E5%BA%8Fstatic%E8%B5%84%E6%BA%90%E6%94%BE%E5%9C%A8jar%E5%A4%96%E9%83%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="JadePeng">
      <meta itemprop="description" content="JadePeng的技术笔记本">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JadePeng的技术笔记本">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2018/04/04/jqpeng-Spring%20boot%20web%E7%A8%8B%E5%BA%8Fstatic%E8%B5%84%E6%BA%90%E6%94%BE%E5%9C%A8jar%E5%A4%96%E9%83%A8/" class="post-title-link" itemprop="url">Spring boot web程序static资源放在jar外部</a>
        </h2>

        <div class="post-meta">

         
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-04-04 10:27:00" itemprop="dateCreated datePublished" datetime="2018-04-04T10:27:00+08:00">2018-04-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 17:44:20" itemprop="dateModified" datetime="2021-05-14T17:44:20+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%8D%9A%E5%AE%A2/" itemprop="url" rel="index"><span itemprop="name">博客</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%8D%9A%E5%AE%A2/jqpeng/" itemprop="url" rel="index"><span itemprop="name">jqpeng</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>731</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>文章作者:jqpeng<br>原文链接: <a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaoqi/p/8715860.html">Spring boot web程序static资源放在jar外部</a></p>
<p>spring boot程序的static目录默认在resources/static目录， 打包为jar的时候，会把static目录打包进去，这样会存在一些问题：</p>
<ul>
<li>static文件过多，造成jar包体积过大</li>
<li>临时修改不方便</li>
</ul>
<p>查看官方文档，可以发现，static其实是可以外置的。</p>
<h2 id="方法1-直接修改配置文件"><a href="#方法1-直接修改配置文件" class="headerlink" title="方法1 直接修改配置文件"></a>方法1 直接修改配置文件</h2><pre><code>spring.resources.static-locations=file:///E://resources/static
</code></pre>
<h2 id="自定义Configuration方法"><a href="#自定义Configuration方法" class="headerlink" title="自定义Configuration方法"></a>自定义Configuration方法</h2><pre><code>@Configuration
public class StaticResourceConfiguration extends WebMvcConfigurerAdapter &#123;
    @Override
    public void addResourceHandlers(ResourceHandlerRegistry registry) &#123;
        registry.addResourceHandler(&quot;/**&quot;).addResourceLocations(&quot;file:/path/to/my/dropbox/&quot;);
    &#125;
&#125;
</code></pre>
<p>推荐使用方法1，安全无害</p>
<p>相关阅读：<a target="_blank" rel="noopener" href="http://www.cnblogs.com/xiaoqi/p/6955288.html">Spring Boot配置文件放在jar外部</a></p>
<hr>
<blockquote>
<p>作者：Jadepeng<br> 出处：jqpeng的技术记事本–<a target="_blank" rel="noopener" href="http://www.cnblogs.com/xiaoqi">http://www.cnblogs.com/xiaoqi</a><br> 您的支持是对博主最大的鼓励，感谢您的认真阅读。<br> 本文版权归作者所有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文连接，否则保留追究法律责任的权利。</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.iflyresearch.com/2018/03/08/jqpeng-%E6%98%93%E4%BC%81%E7%A7%80%E5%89%8D%E7%AB%AF%E5%8E%8B%E7%BC%A9%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B8%8E%E8%BF%98%E5%8E%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="JadePeng">
      <meta itemprop="description" content="JadePeng的技术笔记本">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JadePeng的技术笔记本">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2018/03/08/jqpeng-%E6%98%93%E4%BC%81%E7%A7%80%E5%89%8D%E7%AB%AF%E5%8E%8B%E7%BC%A9%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B8%8E%E8%BF%98%E5%8E%9F/" class="post-title-link" itemprop="url">易企秀前端压缩源码分析与还原</a>
        </h2>

        <div class="post-meta">

         
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-03-08 17:50:00" itemprop="dateCreated datePublished" datetime="2018-03-08T17:50:00+08:00">2018-03-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 17:44:20" itemprop="dateModified" datetime="2021-05-14T17:44:20+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%8D%9A%E5%AE%A2/" itemprop="url" rel="index"><span itemprop="name">博客</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%8D%9A%E5%AE%A2/jqpeng/" itemprop="url" rel="index"><span itemprop="name">jqpeng</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>35k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>32 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>文章作者:jqpeng<br>原文链接: <a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaoqi/p/8529899.html">易企秀前端压缩源码分析与还原</a></p>
<p>你是否想知道易企秀炫酷的H5是如何实现的，原理是什么，本文会为你揭秘并还原压缩过的源代码。</p>
<p>易企秀是一款h5页面制作工具，因方便易用成为业界标杆。后续一个项目会用到类似易企秀这样的自定义H5的功能，因此首先分析下易企秀的前端代码，看看他们是怎么实现的，再取其精华去其糟粕。<br> 由于代码较多，且是压缩处理过的，阅读和还原起来较为困难，不过可以先大概分析下原理，然后有针对性的看主要代码，并借助VS Code等工具对变量、函数进行重命名，稍微耐心一点就能大概还原源代码。</p>
<h2 id="分析数据模型"><a href="#分析数据模型" class="headerlink" title="分析数据模型"></a>分析数据模型</h2><p>前端分析第一步，看看易企秀的数据模型：</p>
<p><img src="https://raw.githubusercontent.com/jadepeng/blogpic/master/pic/2018/1520492536143.jpg" alt="数据模型" title="1520492536143"></p>
<p>dataList是页面配置信息，elemengts是页面元素的配置信息，obj是H5的配置信息，</p>
<h2 id="加载流程分析"><a href="#加载流程分析" class="headerlink" title="加载流程分析"></a>加载流程分析</h2><p>查看H5源代码，发现入口函数是：</p>
<pre><code> eqShow.bootstrap();
</code></pre>
<p>顺藤摸瓜，大概分析下，主要流程如下：</p>
<p><img src="https://raw.githubusercontent.com/jadepeng/blogpic/master/pic/2018/1520493739334.jpg" alt="加载主要流程" title="1520493739334"></p>
<p>主要的功能函数在eqxiu和window对象下面，其中的重点是parsePage、renderPage和app,下面一一来分析。</p>
<h2 id="parsePage"><a href="#parsePage" class="headerlink" title="parsePage"></a>parsePage</h2><p>先看主要代码（重命名后的），主要功能是为每一页生成一个section并appendTo(“.nr”)，另外如果页面有特效，加载相关js库并执行，最后再renderPage。</p>
<pre><code>function parsePage(dataList, response) &#123;

        for (var pageIndex = 1; pageIndex &lt;= dataList.length; pageIndex++) &#123;
            // 分页容器
            $(&#39;&lt;section class=&quot;main-page&quot;&gt;&lt;div class=&quot;m-img&quot; id=&quot;page&#39; + pageIndex + &#39;&quot;&gt;&lt;/div&gt;&lt;/section&gt;&#39;).appendTo(&quot;.nr&quot;);

            if (10 == pageMode) &#123;
                $(&quot;#page&quot; + pageIndex).parent(&quot;.main-page&quot;).wrap(&#39;&lt;div class=&quot;flip-mask&quot; id=&quot;flip&#39; + pageIndex + &#39;&quot;&gt;&lt;/div&gt;&#39;),
                    $(&quot;.main-page&quot;).css(&#123;
                        width: $(&quot;.nr&quot;).width() + &quot;px&quot;,
                        height: $(&quot;.nr&quot;).height() + &quot;px&quot;
                    &#125;);
            &#125;

            if (dataList.length &gt; 1 &amp;&amp; 14 != pageMode &amp;&amp; !response.obj.property.forbidHandFlip) &#123;
                if (0 == pageMode || 1 == pageMode || 2 == pageMode || 6 == pageMode || 7 == pageMode ||
                    8 == pageMode || 11 == pageMode || 12 == pageMode || 13 == pageMode || 14 == pageMode) &#123;
                    $(&#39;&lt;section class=&quot;u-arrow-bottom&quot;&gt;&lt;div class=&quot;pre-wrap&quot;&gt;&lt;div class=&quot;pre-box1&quot;&gt;&lt;div class=&quot;pre1&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;pre-box2&quot;&gt;&lt;div class=&quot;pre2&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/section&gt;&#39;)
                        .appendTo(&quot;#page&quot; + pageIndex)
                &#125; else if (3 == pageMode || 4 == pageMode || 5 == pageMode || 9 == pageMode || 10 == pageMode) &#123;
                    $(&#39;&lt;section class=&quot;u-arrow-right&quot;&gt;&lt;div class=&quot;pre-wrap-right&quot;&gt;&lt;div class=&quot;pre-box3&quot;&gt;&lt;div class=&quot;pre3&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;pre-box4&quot;&gt;&lt;div class=&quot;pre4&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/section&gt;&#39;)
                        .appendTo(&quot;#page&quot; + pageIndex);
                &#125;
            &#125;

              ....
           renderPage(eqShow, pageIndex, dataList);

                // 最后一页
                if (pageIndex == dataList.length) &#123;
                    eqxiu.app($(&quot;.nr&quot;), response.obj.pageMode, dataList, response);
                    addEnabledClassToPageCtrl(response);
                &#125;
            &#125;

        &#125;

        hasSymbols || addReportToLastPage(dataList, response);
    &#125;
</code></pre>
<h2 id="渲染页面和组件"><a href="#渲染页面和组件" class="headerlink" title="渲染页面和组件"></a>渲染页面和组件</h2><p>parsePage搭建了页面框架，renderPage实现页面渲染。</p>
<p>rendepage里，核心代码是：</p>
<pre><code>eqShow.templateParser(&quot;jsonParser&quot;).parse(&#123;
    def: dataList[pageIndex - 1],
    appendTo: &quot;#page&quot; + pageIndex,
    mode: &quot;view&quot;,
    disEvent: disEvent
&#125;);
</code></pre>
<p>templateParser负责将页面上的elements还原为组件，因此这里核心是要了解下templateParser，大致还原的代码如下：</p>
<pre><code>            var jsonTemplateParser = eqShow.templateParser(&quot;jsonParser&quot;, function () &#123;

                function createContainerFunction(container) &#123;
                    return function (key, value) &#123;
                        container[key] = value
                    &#125;
                &#125;

                function wrapComp(element, mode) &#123;
                    try &#123;
                        var comp = components[(&quot;&quot; + element.type).charAt(0)](element, mode)
                    &#125; catch (e) &#123;
                        return
                    &#125;
                    if (comp) &#123;
                        var elementContainer = $(&#39;&lt;li comp-drag comp-rotate class=&quot;comp-resize comp-rotate inside&quot; id=&quot;inside_&#39; + element.id + &#39;&quot; num=&quot;&#39; +
                                element.num + &#39;&quot; ctype=&quot;&#39; + element.type + &#39;&quot;&gt;&lt;/li&gt;&#39;),
                            elementType = (&quot;&quot; + element.type).charAt(0);

                        if (&quot;3&quot; !== elementType &amp;&amp; &quot;1&quot; !== elementType) &#123;
                            elementContainer.attr(&quot;comp-resize&quot;, &quot;&quot;)
                        &#125;

                        // 组件类型
                        /**
                         *  2 文本
                         *  3 背景
                         *  9 音乐
                         *  v video
                         *  4 图片
                         *  h shape形状
                         *  p 图集
                         *  5 输入框
                         *  r radio
                         *  c checkbox
                         *  z 多选按钮
                         *  a 评分组件
                         *  b 留言板
                         *  6 提交按钮
                         */
                        switch (elementType) &#123;
                            case &quot;p&quot;:
                                elementContainer.removeAttr(&quot;comp-rotate&quot;);
                                break;
                            case &quot;1&quot;:
                                elementContainer.removeAttr(&quot;comp-drag&quot;);
                                break;
                            case &quot;2&quot;: // 文本
                                elementContainer.addClass(&quot;wsite-text&quot;);
                                break;
                            case &quot;3&quot;:
                                // 背景
                                break;
                            case &quot;x&quot;:
                                elementContainer.addClass(&quot;show-text&quot;);
                                break;
                            case &quot;4&quot;:
                                // image
                                element.properties.imgStyle &amp;&amp; $(comp).css(element.properties.imgStyle), elementContainer.addClass(&quot;wsite-image&quot;);
                                break;
                            case &quot;n&quot;:
                                elementContainer.addClass(&quot;wsite-image&quot;);
                                break;
                            case &quot;h&quot;:
                                elementContainer.addClass(&quot;wsite-shape&quot;)
                                break;
                            case &quot;5&quot;:
                                elementContainer.removeAttr(&quot;comp-input&quot;);
                                break;
                            case &quot;6&quot;:
                            case &quot;8&quot;:
                                elementContainer.removeAttr(&quot;comp-button&quot;);
                                break;
                            case &quot;v&quot;:
                                elementContainer.removeAttr(&quot;comp-video&quot;);
                                elementContainer.addClass(&quot;wsite-video&quot;);
                                if (element.properties &amp;&amp; element.properties.lock) &#123;
                                    elementContainer.addClass(&quot;alock&quot;)
                                &#125;
                                break;
                            case &quot;b&quot;:
                                elementContainer.removeAttr(&quot;comp-boards&quot;);
                                elementContainer.attr(&quot;min-h&quot;, 60),
                                    elementContainer.attr(&quot;min-w&quot;, 230);
                                break;
                            default:
                                break;
                        &#125;

                        elementContainer.mouseenter(function () &#123;
                                $(this).addClass(&quot;inside-hover&quot;)
                            &#125;),
                            elementContainer.mouseleave(function () &#123;
                                $(this).removeClass(&quot;inside-hover&quot;)
                            &#125;);

                        // edit或者非文本type，再套一层
                        if (&quot;edit&quot; === jsonTemplateParser.mode || &quot;x&quot; !== (&quot;&quot; + element.type).charAt(0)) &#123;
                            var elementBoxContent = $(&#39;&lt;div class=&quot;element-box-contents&quot;&gt;&#39;),
                                elementBox = $(&#39;&lt;div class=&quot;element-box&quot;&gt;&#39;).append(elementBoxContent.append(comp));
                            elementContainer.append(elementBox),
                                &quot;5&quot; !== (&quot;&quot; + element.type).charAt(0) &amp;&amp; &quot;6&quot; !== (&quot;&quot; + element.type).charAt(0) &amp;&amp; &quot;r&quot; !== element.type &amp;&amp; &quot;c&quot; !== element.type &amp;&amp; &quot;a&quot; !== element.type &amp;&amp; &quot;8&quot; !== element.type &amp;&amp; &quot;l&quot; !== element.type &amp;&amp; &quot;s&quot; !== element.type &amp;&amp; &quot;i&quot; !== element.type &amp;&amp; &quot;h&quot; !== element.type &amp;&amp; &quot;z&quot; !== element.type || &quot;edit&quot; !== mode || $(comp).before($(&#39;&lt;div class=&quot;element&quot; style=&quot;position: absolute; height: 100%; width: 100%;z-index: 1;&quot;&gt;&#39;))
                        &#125;

                        // 文本类型，处理font
                        var k, eleFonts = element.fonts || element.css.fontFamily || element.fontFamily;
                        if (&quot;2&quot; === elementType || &quot;x&quot; === elementType) &#123;
                            for (var content = element.content, font_pattern = /font-family:(.*?);/g, matchResults = [], fonts = []; null !== (matchResults = font_pattern.exec(content));)
                                fonts.push(matchResults[1].trim());
                            if (1 !== fonts.length || &quot;defaultFont&quot; !== fonts[0] &amp;&amp; &quot;moren&quot; !== fonts[0] || (eleFonts = null),
                                eleFonts) &#123;
                                if (&quot;view&quot; === jsonTemplateParser.mode &amp;&amp; element.css.fontFamily &amp;&amp; window.scene &amp;&amp; (window.scene.publishTime || !mobilecheck() &amp;&amp; !tabletCheck() || (k = &quot;@font-face&#123;font-family:&quot; + element.css.fontFamily + &#39;;src: url(&quot;&#39; + element.properties.localFontPath + &#39;&quot;) format(&quot;truetype&quot;);&#125;&#39;,
                                        b(k))),
                                    &quot;object&quot; == typeof eleFonts &amp;&amp; eleFonts.constructor === Object) &#123;
                                    if (!jQuery.isEmptyObject(eleFonts))
                                        for (var q in eleFonts)
                                            u[q] || (&quot;edit&quot; === jsonTemplateParser.mode ? k = &quot;@font-face&#123;font-family:&quot; + q + &quot;;src: url(&quot; + PREFIX_FILE_HOST + eleFonts[q] + &quot;) format(woff);&#125;&quot; : window.scene &amp;&amp; window.scene.publishTime &amp;&amp; (k = &quot;@font-face&#123;font-family:&quot; + q + &#39;;src: url(&quot;&#39; + PREFIX_S2_URL + &quot;fc/&quot; + q + &quot;_&quot; + element.sceneId + &quot;_&quot; + scene.publishTime + &#39;.woff&quot;) format(&quot;woff&quot;);&#125;&#39;),
                                                b(k),
                                                u[q] = !0)
                                &#125; else
                                    u[eleFonts] || (&quot;edit&quot; === jsonTemplateParser.mode ? k = &quot;@font-face&#123;font-family:&quot; + eleFonts + &quot;;src: url(&quot; + PREFIX_FILE_HOST + element.preWoffPath + &quot;) format(woff);&#125;&quot; : window.scene &amp;&amp; window.scene.publishTime &amp;&amp; (k = &quot;@font-face&#123;font-family:&quot; + eleFonts + &#39;;src: url(&quot;&#39; + PREFIX_S2_URL + &quot;fc/&quot; + eleFonts + &quot;_&quot; + element.sceneId + &quot;_&quot; + scene.publishTime + &#39;.woff&quot;) format(&quot;woff&quot;);&#125;&#39;),
                                        b(k),
                                        u[eleFonts] = !0);
                                &quot;edit&quot; === jsonTemplateParser.mode &amp;&amp; localStorage.setItem(&quot;shoppingFontFamily&quot;, JSON.stringify(u))
                            &#125;
                        &#125;

                        // 处理css
                        if (element.css) &#123;
                            var elementWidth = 320 - parseInt(element.css.left, 10);
                            elementContainer.css(&#123;
                                width: elementWidth
                            &#125;);
                            elementContainer.css(&#123;
                                width: element.css.width,
                                height: element.css.height,
                                left: element.css.left,
                                top: element.css.top,
                                zIndex: element.css.zIndex,
                                bottom: element.css.bottom,
                                transform: element.css.transform
                            &#125;);
                            if (0 === element.css.boxShadowSize || &quot;&quot; + element.css.boxShadowSize == &quot;0&quot;) &#123;
                                element.css.boxShadow = &quot;0px 0px 0px rgba(0,0,0,0.5)&quot;;
                                if (&quot;edit&quot; !== jsonTemplateParser.mode &amp;&amp; &quot;x&quot; === (&quot;&quot; + element.type).charAt(0)) &#123;
                                    return elementContainer.append(comp),
                                        elementContainer.find(&quot;.element-box&quot;).css(&#123;
                                            borderStyle: element.css.borderStyle,
                                            borderWidth: element.css.borderWidth,
                                            borderColor: element.css.borderColor,
                                            borderTopLeftRadius: element.css.borderTopLeftRadius,
                                            borderTopRightRadius: element.css.borderTopRightRadius,
                                            borderBottomRightRadius: element.css.borderBottomRightRadius,
                                            borderBottomLeftRadius: element.css.borderBottomLeftRadius,
                                            boxShadow: element.css.boxShadow,
                                            backgroundColor: element.css.backgroundColor,
                                            opacity: element.css.opacity,
                                            width: &quot;100%&quot;,
                                            height: &quot;100%&quot;,
                                            overflow: &quot;hidden&quot;
                                        &#125;),
                                        elementContainer.find(&quot;img&quot;).css(&#123;
                                            width: &quot;100%&quot;
                                        &#125;),
                                        elementContainer;
                                &#125;
                            &#125;

                            // Android 微信，图片，设置borderColor
                            isAndroid() &amp;&amp;
                                isWeixin() &amp;&amp;
                                &quot;&quot; + element.type == &quot;4&quot; &amp;&amp;
                                &quot;0px&quot; !== element.css.borderRadius &amp;&amp;
                                0 === element.css.borderWidth &amp;&amp;
                                element.properties.anim &amp;&amp; (element.css.borderWidth = 1, element.css.borderColor = &quot;rgba(0,0,0,0)&quot;);

                            var elementCss = $.extend(!0, &#123;&#125;, element.css);
                            delete elementCss.fontFamily,
                                elementBox.css(elementCss).css(&#123;
                                    width: &quot;100%&quot;,
                                    height: &quot;100%&quot;,
                                    transform: &quot;none&quot;
                                &#125;),
                                elementBox.children(&quot;.element-box-contents&quot;).css(&#123;
                                    width: &quot;100%&quot;,
                                    height: &quot;100%&quot;
                                &#125;),
                                // 设置宽高
                                &quot;4&quot; !== (&quot;&quot; + element.type).charAt(0) &amp;&amp;
                                &quot;n&quot; !== (&quot;&quot; + element.type).charAt(0) &amp;&amp;
                                &quot;p&quot; !== (&quot;&quot; + element.type).charAt(0) &amp;&amp;
                                &quot;h&quot; !== (&quot;&quot; + element.type).charAt(0) &amp;&amp; &quot;t&quot; !== (&quot;&quot; + element.type).charAt(0) &amp;&amp;
                                &quot;z&quot; !== (&quot;&quot; + element.type).charAt(0) &amp;&amp;
                                $(comp).css(&#123;
                                    width: element.css.width,
                                    height: element.css.height
                                &#125;),
                                // w01 w02 设置lineHeight
                                (&quot;w01&quot; === element.type || &quot;w02&quot; === element.type) &amp;&amp;
                                $(comp).css(&#123;
                                    lineHeight: element.css.height + &quot;px&quot;
                                &#125;),
                                // shape 类型
                                &quot;h&quot; === (&quot;&quot; + element.type).charAt(0) &amp;&amp;
                                ($(comp).find(&quot;g&quot;).length ?
                                    $(comp).find(&quot;g&quot;).attr(&quot;fill&quot;, element.css.color) :
                                    $(comp).children().attr(&quot;fill&quot;, element.css.color),
                                    elementBox.children(&quot;.element-box-contents&quot;).css(&quot;position&quot;, &quot;relative&quot;))
                        &#125;
                        return elementContainer
                    &#125;
                &#125;

                /**
                 * 将element按zindex排序
                 */
                function sortElementsByZindex(elements) &#123;
                    for (var i = 0; i &lt; elements.length - 1; i++)
                        for (var j = i + 1; j &lt; elements.length; j++)
                            if (parseInt(elements[i].css.zIndex, 10) &gt; parseInt(elements[j].css.zIndex, 10)) &#123;
                                var element = elements[i];
                                elements[i] = elements[j],
                                    elements[j] = element
                            &#125;
                    for (var e = 0; e &lt; elements.length; e++)
                        elements[e].css.zIndex = e + 1 + &quot;&quot;;
                    return elements
                &#125;

                function parseElements(pageDef, $edit_wrapper, mode) &#123;
                    $edit_wrapper = $edit_wrapper.find(&quot;.edit_area&quot;);
                    var i, elements = pageDef.elements;
                    if (elements)
                        for (elements = sortElementsByZindex(elements),
                            i = 0; i &lt; elements.length; i++)
                            if (elements[i].sceneId = pageDef.sceneId,
                                &quot;&quot; + elements[i].type == &quot;3&quot;) &#123;
                                // type == 3 
                                var component = components[(&quot;&quot; + elements[i].type).charAt(0)](elements[i], $edit_wrapper);

                                // if is edit mode, dispatch edit event
                                &quot;edit&quot; === mode
                                    &amp;&amp;
                                    editEvents[(&quot;&quot; + elements[i].type).charAt(0)] &amp;&amp;
                                    editEvents[(&quot;&quot; + elements[i].type).charAt(0)](component, elements[i])
                            &#125; else &#123;
                                var comp = wrapComp(elements[i], mode);
                                if (!comp)
                                    continue;
                                $edit_wrapper.append(comp);

                                // invoke interceptors
                                for (var n = 0; n &lt; interceptors.length; n++)
                                    interceptors[n](comp, elements[i], mode);

                                afterRenderEvents[(&quot;&quot; + elements[i].type).charAt(0)] &amp;&amp;
                                    (
                                        afterRenderEvents[(&quot;&quot; + elements[i].type).charAt(0)](comp, elements[i]),
                                        &quot;edit&quot; !== mode &amp;&amp; (
                                            parseElementTrigger(comp, elements[i]),
                                            r(comp, elements[i])
                                        )
                                    ),

                                    &quot;edit&quot; === mode &amp;&amp;
                                    editEvents[(&quot;&quot; + elements[i].type).charAt(0)] &amp;&amp;
                                    editEvents[(&quot;&quot; + elements[i].type).charAt(0)](comp, elements[i])
                            &#125;
                &#125;

                function getEventHandlers() &#123;
                    return editEvents
                &#125;

                function getComponents() &#123;
                    return components
                &#125;

                function addInterceptor(interceptor) &#123;
                    interceptors.push(interceptor)
                &#125;

                function getInterceptors() &#123;
                    return interceptors
                &#125;
                var components = &#123;&#125;,
                    editEvents = &#123;&#125;,
                    afterRenderEvents = &#123;&#125;,
                    interceptors = [],
                    _width = containerWidth = 320,
                    _height = containerHeight = 486,
                    p = 1,
                    s = 1,
                    parser = &#123;
                        getComponents: getComponents,
                        getEventHandlers: getEventHandlers,
                        addComponent: createContainerFunction(components),
                        bindEditEvent: createContainerFunction(editEvents),
                        bindAfterRenderEvent: createContainerFunction(afterRenderEvents),
                        addInterceptor: addInterceptor,
                        getInterceptors: getInterceptors,
                        wrapComp: wrapComp,
                        disEvent: !1,
                        mode: &quot;view&quot;,
                        parse: function (parseInfo) &#123;
                            var edit_wrapper = $(&#39;&lt;div class=&quot;edit_wrapper&quot; data-scene-id=&quot;&#39; + parseInfo.def.sceneId + &#39;&quot;&gt;&lt;ul eqx-edit-destroy id=&quot;edit_area&#39; + parseInfo.def.id + &#39;&quot; paste-element class=&quot;edit_area weebly-content-area weebly-area-active&quot;&gt;&lt;/div&gt;&#39;),
                                mode = this.mode = parseInfo.mode;
                            // page 定义
                            this.def = parseInfo.def,
                                parseInfo.disEvent &amp;&amp; (this.disEvent = !0),
                                &quot;view&quot; === mode &amp;&amp; tplCount++;
                            // 页面容器
                            var pageContainer = $(parseInfo.appendTo);
                            return containerWidth = pageContainer.width(),
                                containerHeight = pageContainer.height(),
                                p = _width / containerWidth,
                                s = _height / containerHeight,
                                parseElements(parseInfo.def, edit_wrapper.appendTo($(parseInfo.appendTo)), mode)
                        &#125;
                    &#125;;
                return parser
            &#125;);
</code></pre>
<p>上面的重点是parseElements，先把elements按zindex排序，然后逐个渲染。<br> 注意，渲染是根据elementType,从components找到对应的组件，然后创建一个实例，因此这里要单独说下组件是如何定义的。</p>
<p>先看下一个组件的配置信息大概是这样，有id，css，type和动画等配置信息：</p>
<pre><code>    &#123;
    &quot;id&quot;: 29,
    &quot;css&quot;: &#123;
        &quot;top&quot;: 124.93546211843,
        &quot;left&quot;: 62.967731059217,
        &quot;color&quot;: &quot;#676767&quot;,
        &quot;width&quot;: 195,
        &quot;height&quot;: 195,
        &quot;zIndex&quot;: &quot;1&quot;,
        &quot;opacity&quot;: 1,
        &quot;boxShadow&quot;: &quot;0px 0px 0px rgba(0,0,0,0.5)&quot;,
        &quot;transform&quot;: &quot;rotateZ(45deg)&quot;,
        &quot;lineHeight&quot;: 1,
        &quot;paddingTop&quot;: 0,
        &quot;borderColor&quot;: &quot;rgba(255,255,255,1)&quot;,
        &quot;borderStyle&quot;: &quot;double&quot;,
        &quot;borderWidth&quot;: 4,
        &quot;borderRadius&quot;: &quot;0px&quot;,
        &quot;boxShadowSize&quot;: 0,
        &quot;paddingBottom&quot;: 0,
        &quot;backgroundColor&quot;: &quot;rgba(252,230,238,0.16)&quot;,
        &quot;borderRadiusPerc&quot;: 0,
        &quot;boxShadowDirection&quot;: 0,
        &quot;textAlign&quot;: &quot;left&quot;,
        &quot;borderBottomRightRadius&quot;: &quot;0px&quot;,
        &quot;borderBottomLeftRadius&quot;: &quot;0px&quot;,
        &quot;borderTopRightRadius&quot;: &quot;0px&quot;,
        &quot;borderTopLeftRadius&quot;: &quot;0px&quot;
    &#125;,
    &quot;type&quot;: &quot;2&quot;,
    &quot;pageId&quot;: &quot;24642&quot;,
    &quot;content&quot;: &quot;&lt;div style=\&quot;text-align: center;\&quot;&gt;&lt;br&gt;&lt;/div&gt;&quot;,
    &quot;sceneId&quot;: 8831293,
    &quot;properties&quot;: &#123;
        &quot;anim&quot;: &#123;
            &quot;type&quot;: 4,
            &quot;delay&quot;: 0.6,
            &quot;countNum&quot;: 1,
            &quot;duration&quot;: 1,
            &quot;direction&quot;: 0
        &#125;,
        &quot;width&quot;: 195,
        &quot;height&quot;: 195
    &#125;
&#125;
</code></pre>
<p>jsonParser里用一个components对象存储组件，通过addComponent添加组件，key就是组件的type：</p>
<pre><code>addComponent: createContainerFunction(components)
function createContainerFunction(container) &#123;
                return function (key, value) &#123;
                    container[key] = value
                &#125;
            &#125;
</code></pre>
<p>添加组件时，type 作为key，value为创建组件的函数：</p>
<pre><code>// 添加组件1jsonTemplateParser.addComponent(&quot;1&quot;, function (element, mode) &#123;    var comp = document.createElement(&quot;div&quot;);    if (comp.id = element.id,        comp.setAttribute(&quot;class&quot;, &quot;element comp_title&quot;),        // 设置组件content        element.content &amp;&amp; (comp.textContent = element.content),        element.css) &#123;        var item, elementCss = element.css;        for (item in elementCss)            comp.style[item] = elementCss[item]    &#125;    if (element.properties.labels)        for (var labels = element.properties.labels, f = 0; f &lt; labels.length; f++)            $(&#39;&lt;a class = &quot;label_content&quot; style = &quot;display: inline-block;&quot;&gt;&#39;)            .appendTo($(comp))            .html(labels[f].title)            .css(labels[f].color)            .css(&quot;width&quot;, 100 / labels.length + &quot;%&quot;);    return comp&#125;);
</code></pre>
<p>这样渲染组件时，根据element的类型就能找到createCompFunction，从而创建组件。</p>
<h2 id="组件动画播放"><a href="#组件动画播放" class="headerlink" title="组件动画播放"></a>组件动画播放</h2><p>H5之所以炫酷，很大一部分因为每个组件都有定制好的CSS3动画，我们这里来看看这些动画是如何执行的。</p>
<p>代码还是上一部分的代码，我们注意到组件渲染后，有一段代码;</p>
<pre><code>  // invoke interceptorsfor (var n = 0; n &lt; interceptors.length; n++)    interceptors[n](comp, elements[i], mode);
</code></pre>
<p>执行interceptors，这个interceptors可以通过addInterceptor注册拦截器，在组件渲染完成后会调用定义的拦截器，组件的动画就是这样来调用的。</p>
<pre><code>        // 添加拦截器执行动画
        jsonTemplateParser.addInterceptor(function (comp, element, mode) &#123;
            eqxCommon.animation(comp, element, mode, jsonTemplateParser.def.properties)
        &#125;);
</code></pre>
<p>我们发现，eqxiu通过addInterceptor注册了一个拦截器，该拦截器调用eqxCommon.animation执行组件动画，因此分析eqxCommon.animation就可以了解动画是如何实现的。</p>
<p>还是先看element里的定义：</p>
<pre><code>     &quot;properties&quot;: &#123;        &quot;anim&quot;: &#123;            &quot;type&quot;: 4,            &quot;delay&quot;: 0.6,            &quot;countNum&quot;: 1,            &quot;duration&quot;: 1,            &quot;direction&quot;: 0        &#125;,
</code></pre>
<p>我们看到，anim里定义了type，delay，duration等配置信息，可以设想播放动画无非就是解析这个配置，然后执行，其中type应该是对应的各种动画类型，分析代码吧，下面给出破解后的代码：</p>
<pre><code>        // 动画播放序号
        var animIndex = 0;

        // 处理动画属性
        if (element.properties &amp;&amp; element.properties.anim) &#123;
            var anim = [];
            element.properties.anim.length ? anim = element.properties.anim : anim.push(element.properties.anim);
            var elementBox = $(&quot;.element-box&quot;, comp);
            elementBox.attr(&quot;element-anim&quot;, &quot;&quot;);

            // 找出animations
            for (var animType, animTypes = [], anims = [], index = 0, animLength = anim.length; animLength &gt; index; index++)
                if (null != anim[index].type &amp;&amp;
                    -1 != anim[index].type) &#123;
                    animType = eqxCommon.convertType(anim[index]),
                        animTypes.push(animType),
                        anims.push(anim[index]);
                &#125;

            if (properties &amp;&amp; properties.scale)
                return;

            // 动画播放类型
            element.properties.anim.trigger ?
                comp.click(function () &#123;
                    // 点击播放
                    playAnimation(elementBox, animType, element.properties.anim)
                &#125;) :
                properties &amp;&amp; properties.longPage ?
                playAnimation(elementBox, animTypes, anims, !0, element.css) // longpage
                :
                playAnimation(elementBox, animTypes, anims)
        &#125;
</code></pre>
<p>上面的逻辑是先从element里找到anim，放入数组，然后再playAnimation。这里使用了convertType函数将数字type转换为真实的动画类型：</p>
<pre><code>var convertType = function (a) &#123;
        var animType, c, d = a.type;
        return &quot;typer&quot; === d &amp;&amp; (animType = &quot;typer&quot;),
            0 === d &amp;&amp; (animType = &quot;fadeIn&quot;),
            1 === d &amp;&amp; (c = a.direction,
                0 === c &amp;&amp; (animType = &quot;fadeInLeft&quot;),
                1 === c &amp;&amp; (animType = &quot;fadeInDown&quot;),
                2 === c &amp;&amp; (animType = &quot;fadeInRight&quot;),
                3 === c &amp;&amp; (animType = &quot;fadeInUp&quot;)),
            6 === d &amp;&amp; (animType = &quot;wobble&quot;),
            5 === d &amp;&amp; (animType = &quot;rubberBand&quot;),
            7 === d &amp;&amp; (animType = &quot;rotateIn&quot;),
            8 === d &amp;&amp; (animType = &quot;flip&quot;),
            9 === d &amp;&amp; (animType = &quot;swing&quot;),
            2 === d &amp;&amp; (c = a.direction,
                0 === c &amp;&amp; (animType = &quot;bounceInLeft&quot;),
                1 === c &amp;&amp; (animType = &quot;bounceInDown&quot;),
                2 === c &amp;&amp; (animType = &quot;bounceInRight&quot;),
                3 === c &amp;&amp; (animType = &quot;bounceInUp&quot;)),
            3 === d &amp;&amp; (animType = &quot;bounceIn&quot;),
            4 === d &amp;&amp; (animType = &quot;zoomIn&quot;),
            10 === d &amp;&amp; (animType = &quot;fadeOut&quot;),
            11 === d &amp;&amp; (animType = &quot;flipOutY&quot;),
            12 === d &amp;&amp; (animType = &quot;rollIn&quot;),
            13 === d &amp;&amp; (animType = &quot;lightSpeedIn&quot;),
            14 === d &amp;&amp; (animType = &quot;bounceOut&quot;),
            15 === d &amp;&amp; (animType = &quot;rollOut&quot;),
            16 === d &amp;&amp; (animType = &quot;lightSpeedOut&quot;),
            17 === d &amp;&amp; (c = a.direction,
                0 === c &amp;&amp; (animType = &quot;fadeOutRight&quot;),
                1 === c &amp;&amp; (animType = &quot;fadeOutDown&quot;),
                2 === c &amp;&amp; (animType = &quot;fadeOutLeft&quot;),
                3 === c &amp;&amp; (animType = &quot;fadeOutUp&quot;)),
            18 === d &amp;&amp; (animType = &quot;zoomOut&quot;),
            19 === d &amp;&amp; (c = a.direction,
                0 === c &amp;&amp; (animType = &quot;bounceOutRight&quot;),
                1 === c &amp;&amp; (animType = &quot;bounceOutDown&quot;),
                2 === c &amp;&amp; (animType = &quot;bounceOutLeft&quot;),
                3 === c &amp;&amp; (animType = &quot;bounceOutUp&quot;)),
            20 === d &amp;&amp; (animType = &quot;flipInY&quot;),
            21 === d &amp;&amp; (animType = &quot;tada&quot;),
            22 === d &amp;&amp; (animType = &quot;jello&quot;),
            23 === d &amp;&amp; (animType = &quot;flash&quot;),
            26 === d &amp;&amp; (animType = &quot;twisterInDown&quot;),
            27 === d &amp;&amp; (animType = &quot;puffIn&quot;),
            28 === d &amp;&amp; (animType = &quot;puffOut&quot;),
            29 === d &amp;&amp; (animType = &quot;slideDown&quot;),
            30 === d &amp;&amp; (animType = &quot;slideUp&quot;),
            24 === d &amp;&amp; (animType = &quot;flipInX&quot;),
            25 === d &amp;&amp; (animType = &quot;flipOutX&quot;),
            31 === d &amp;&amp; (animType = &quot;twisterInUp&quot;),
            32 == d &amp;&amp; (animType = &quot;vanishOut&quot;),
            33 == d &amp;&amp; (animType = &quot;vanishIn&quot;),
            animType
    &#125;;
</code></pre>
<p>播放动画函数在playAnimation里：</p>
<ul>
<li>大概是先判断类型是否是typer，typer的话是打字机特效，调用相关代码</li>
<li>设置element的的css animation属性，本质上是CSS3的animation动画,可以参见（<a target="_blank" rel="noopener" href="http://www.w3school.com.cn/css3/css3_animation.asp%EF%BC%89">http://www.w3school.com.cn/css3/css3_animation.asp）</a></li>
</ul>
<pre><code> elementBox.css(&quot;animation&quot;, &quot;&quot;);
                elementBox.css(&quot;animation&quot;, animTypes[animIndex] + &quot; &quot; + anims[animIndex].duration + &quot;s ease &quot; + anims[animIndex].delay + &quot;s &quot; +
                    (anims[animIndex].countNum ? anims[animIndex].countNum : &quot;&quot;));                 anims[animIndex].count &amp;&amp; animIndex == anims.length - 1 &amp;&amp; elementBox.css(&quot;animation-iteration-count&quot;, &quot;infinite&quot;);
                    elementBox.css(&quot;animation-fill-mode&quot;, &quot;both&quot;);
</code></pre>
<p>最后，如果有多个动画，在播放完成后继续播放下一个：</p>
<pre><code>// 动画播放结束，播放下一个动画（一个组件可能有多个动画）
                elementBox.one(&quot;webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend&quot;, function () &#123;
                    animIndex++;
                    playAnimation(elementBox, animTypes, anims);
                &#125;)
</code></pre>
<h2 id="页面切换"><a href="#页面切换" class="headerlink" title="页面切换"></a>页面切换</h2><p>由于是多页应用，因此涉及到页面切换，并且页面切换时还需要有对应的切换动画，改工作是由一个eqxiu对象来管理和实现的。</p>
<p>老套路，先看这块的配置吧，页面的配置在obj下面,其中pageMode定义了翻页效果：</p>
<pre><code>&quot;obj&quot;: &#123;
    &quot;id&quot;: 8831293,
    &quot;name&quot;: &quot;房产广告&quot;,
    &quot;createUser&quot;: &quot;1&quot;,
    &quot;type&quot;: 103,
    &quot;pageMode&quot;: 4,
    &quot;image&quot;: &#123;&#125;,
    &quot;property&quot;: &quot;&#123;\&quot;triggerLoop\&quot;:true,\&quot;slideNumber\&quot;:true,\&quot;autoFlipTime\&quot;:4,\&quot;shareDes\&quot;:\&quot;\&quot;,\&quot;eqAdType\&quot;:1,\&quot;hideEqAd\&quot;:false,\&quot;autoFlip\&quot;:true,\&quot;lastPageId\&quot;:604964&#125;&quot;,
    &quot;timeout&quot;: &quot;&quot;,
    &quot;timeout_url&quot;: &quot;&quot;,
    &quot;accessCode&quot;: null,
    &quot;cover&quot;: &quot;syspic/pageimg/yq0KA1UrbkOAV_yiAAFuhyGx9LE397.jpg&quot;,
    &quot;bgAudio&quot;: &quot;&#123;\&quot;url\&quot;:\&quot;syspic/mp3/yq0KA1RHT3iAMXYOAAgPq1MjV9M930.mp3\&quot;,\&quot;type\&quot;:\&quot;3\&quot;&#125;&quot;,
    &quot;isTpl&quot;: 0,
    &quot;isPromotion&quot;: 0,
    &quot;status&quot;: 1,
    &quot;openLimit&quot;: 0,
    &quot;startDate&quot;: null,
    &quot;endDate&quot;: null,
    &quot;updateTime&quot;: 1426045746000,
    &quot;createTime&quot;: 1426572693000,
    &quot;publishTime&quot;: 1426572693000,
    &quot;applyTemplate&quot;: 0,
    &quot;applyPromotion&quot;: 0,
    &quot;sourceId&quot;: null,
    &quot;code&quot;: &quot;U903078B74Q5&quot;,
    &quot;description&quot;: &quot;房产广告&quot;,
    &quot;sort&quot;: 0,
    &quot;pageCount&quot;: 0,
    &quot;dataCount&quot;: 0,
    &quot;showCount&quot;: 44,
    &quot;eqcode&quot;: &quot;&quot;,
    &quot;userLoginName&quot;: null,
    &quot;userName&quot;: null
&#125;,
</code></pre>
<p>pagemode是这样定义的：</p>
<pre><code>pagemodes = [&#123;        id: 0,        name: &quot;上下翻页&quot;    &#125;, &#123;        id: 4,        name: &quot;左右翻页&quot;    &#125;, &#123;        id: 1,        name: &quot;上下惯性翻页&quot;    &#125;, &#123;        id: 3,        name: &quot;左右惯性翻页&quot;    &#125;, &#123;        id: 11,        name: &quot;上下连续翻页&quot;    &#125;, &#123;        id: 5,        name: &quot;左右连续翻页&quot;    &#125;, &#123;        id: 6,        name: &quot;立体翻页&quot;    &#125;, &#123;        id: 7,        name: &quot;卡片翻页&quot;    &#125;, &#123;        id: 8,        name: &quot;放大翻页&quot;    &#125;, &#123;        id: 9,        name: &quot;交换翻页&quot;    &#125;, &#123;        id: 10,        name: &quot;翻书翻页&quot;    &#125;, &#123;        id: 12,        name: &quot;掉落翻页&quot;    &#125;, &#123;        id: 13,        name: &quot;淡入翻页&quot;    &#125;];
</code></pre>
<p>在renderpage结束后，调用eqxiu.app：</p>
<pre><code>                  // 最后一页
                if (pageIndex == dataList.length) &#123;
                    eqxiu.app($(&quot;.nr&quot;), response.obj.pageMode, dataList, response);
                    addEnabledClassToPageCtrl(response);
                &#125;
</code></pre>
<p>来分析eqxiu.app代码，通过pagemode，我们可以看出翻页打开分为上下翻页、左右翻页两个大类：</p>
<pre><code>if (&quot;8&quot; == pageMode || &quot;9&quot; == pageMode) &#123;
            transformTime = 0.7;
            timeoutDelay = 800;
        &#125;
        // 上下翻页  上下惯性翻页 立体翻页 卡片翻页 放大翻页 上下连续翻页 上下连续翻页
        if (0 == pageMode || (1 == pageMode || (2 == pageMode || (6 == pageMode || (7 == pageMode || (8 == pageMode || (11 == pageMode || 12 == pageMode))))))) &#123;
            /** @type &#123;boolean&#125; */
            upDownMode = true;
        &#125; else &#123;
            // 左右惯性翻页 左右翻页 左右连续翻页  翻书翻页
            if (3 == pageMode || (4 == pageMode || (5 == pageMode || 10 == pageMode))) &#123;
                /** @type &#123;boolean&#125; */
                leftRightMode = true;
            &#125;
        &#125;
</code></pre>
<p>然后配置里有一个autoFlip，代表是否自动翻页,通过setInterval设置定时翻页任务：</p>
<pre><code>        // 自动翻页
        if (response.obj.property.autoFlip) &#123;
            // 自动翻页时间
            autoFlipTimeMS = 1000 * response.obj.property.autoFlipTime;
            setAndStartAutoFlip(autoFlipTimeMS);
        &#125;    
    /**
     * 设置翻页时间间隔并启动翻页
     * @param &#123;number&#125; textStatus
     * @return &#123;undefined&#125;
     */
    function setAndStartAutoFlip(autoFlipTime) &#123;
        autoFlipTime = autoFlipTime;
        pauseAutoFlip();
        startAutoFlip();
    &#125;           /**
     * 启动自动翻页
     * @return &#123;undefined&#125;
     */
    function startAutoFlip() &#123;
        // 通过setInterval
        autoFlipIntervalId = setInterval(function () &#123;
            if (!(10 === self._scrollMode)) &#123;
                if (!isTouching) &#123;
                    nextPage();
                &#125;
            &#125;
        &#125;, autoFlipTimeMS);
    &#125;
</code></pre>
<p>默认情况下H5是支持touch滑动翻页的，这种滑动操作一般是监听相关事件，开始滑动、滑动中和滑动结束，为了同时支持移动端和PC端，还需要加上鼠标点击事件：</p>
<pre><code>        var isTouch = false;
        self._$app.on(&quot;mousedown touchstart&quot;, function (e) &#123;
            if (!self._isforbidHandFlip) &#123;
                onTouchStart(e);
                isTouch = true;
            &#125;
        &#125;).on(&quot;mousemove touchmove&quot;, function (e) &#123;
            if (!self._isforbidHandFlip) &#123;
                if (isTouch) &#123;
                    onTouchMove(e);
                &#125;
            &#125;
        &#125;).on(&quot;mouseup touchend mouseleave&quot;, function (events) &#123;
            if (!self._isforbidHandFlip) &#123;
                onTouchEnd(events);
                /** @type &#123;boolean&#125; */
                isTouch = false;
            &#125;
        &#125;);
</code></pre>
<p>翻页的核心无非就是判断位移是否超过特定的值，比如左右翻页X位移是否大于Y位移并且X的偏移量大于20。因此onTouchStart开始时，记录初始位置，onTouchMove时计算offset变化，按照pageMode执行对应的动画，onTouchEnd时判断位移是否足够，足够就切换页面，否则复位。</p>
<pre><code>/**
         * 开始滑动
         * @param &#123;Object&#125; e
         * @return &#123;undefined&#125;
         */
        onTouchStart = function (e) &#123;
            /** @type &#123;boolean&#125; */
            fa = false;
            if (isMobile) &#123;
                if (e) &#123;
                    e = event;
                &#125;
            &#125;
            if (!self._isDisableFlipPage) &#123;
                self.$currentPage = self._$pages.filter(&quot;.z-current&quot;).get(0);
                if (!C) &#123;
                    /** @type &#123;null&#125; */
                    self.$activePage = null;
                &#125;
                if (self.$currentPage) &#123;
                    if (completeEffect($(self.$currentPage))) &#123;
                        isTouching = true;
                        isCursorAtEnd = false;
                        ignoreEvent = true;
                        offsetX = 0;
                        offsetY = 0;
                        if (e &amp;&amp; &quot;mousedown&quot; == e.type) &#123;
                            currentPageX = e.pageX;
                            currentPageY = e.pageY;
                        &#125; else if (e &amp;&amp; &quot;touchstart&quot; == e.type) &#123;
                            currentPageX = e.touches ? e.touches[0].pageX : e.originalEvent.touches[0].pageX;
                            currentPageY = e.touches ? e.touches[0].pageY : e.originalEvent.touches[0].pageY;
                        &#125;
                        self.$currentPage.classList.add(&quot;z-move&quot;);
                        setAttribute(self.$currentPage.style, &quot;Transition&quot;, &quot;none&quot;);
                        if (&quot;12&quot; == self._scrollMode) &#123;
                            /** @type &#123;number&#125; */
                            self.$currentPage.style.zIndex = 3;
                        &#125;
                    &#125;
                &#125;
            &#125;
        &#125;;

        /**
         * 滑动处理
         * @param &#123;Object&#125; e
         * @return &#123;undefined&#125;
         */
        onTouchMove = function (e) &#123;
            if (isMobile) &#123;
                if (e) &#123;
                    e = event;
                &#125;
            &#125;
            if (isTouching) &#123;
                if (self._$pages.length &gt; 1) &#123;
                    if (e &amp;&amp; &quot;mousemove&quot; == e.type) &#123;
                        offsetX = e.pageX - currentPageX;
                        offsetY = e.pageY - currentPageY;
                    &#125; else &#123;
                        if (e) &#123;
                            if (&quot;touchmove&quot; == e.type) &#123;
                                offsetX = (e.touches ? e.touches[0].pageX : e.originalEvent.touches[0].pageX) - currentPageX;
                                offsetY = (e.touches ? e.touches[0].pageY : e.originalEvent.touches[0].pageY) - currentPageY;
                            &#125;
                        &#125;
                    &#125;
                    if (!fa) &#123;
                        if (Math.abs(offsetX) &gt; 20 || Math.abs(offsetY) &gt; 20) &#123;
                            /** @type &#123;boolean&#125; */
                            fa = true;
                        &#125;
                    &#125;

                    switch (self._scrollMode + &quot;&quot;) &#123;
                        case &quot;0&quot;:
                        case &quot;1&quot;:
                        case &quot;2&quot;:
                        case &quot;15&quot;:
                            //上下翻页
                            upDownFlip();
                            break;
                        case &quot;3&quot;:
                        case &quot;4&quot;:
                            // 左右翻页
                            leftRightFlip();
                            break;
                        case &quot;5&quot;:
                            // 左右连续翻页
                            leftRightLoopFlip();
                            break;
                        case &quot;7&quot;:
                            cardFlip();
                            break;
                        case &quot;8&quot;:
                            scaleUpFlip();
                            break;
                        case &quot;9&quot;:
                            switchFlip();
                            break;
                        case &quot;11&quot;:
                            //上下连续翻页
                            upDownContinuousFlip();
                            break;
                        case &quot;12&quot;:
                            //掉落翻页
                            dropFlip();
                            break;
                        case &quot;13&quot;:
                        case &quot;14&quot;:
                            //淡入翻页
                            fadeFlip();
                            break;
                        default:
                            break;
                    &#125;
                &#125;
            &#125;
        &#125;;


        /**
         *  滑动结束
         * @param &#123;?&#125; e
         * @return &#123;undefined&#125;
         */
        onTouchEnd = function (e) &#123;
            if (isTouching &amp;&amp; completeEffect($(self.$currentPage))) &#123;
                isTouching = false;
                if (self.$activePage) &#123;
                    self._isDisableFlipPage = true;
                    var ease;
                    ease = &quot;6&quot; == self._scrollMode || &quot;7&quot; == self._scrollMode ? &quot;cubic-bezier(0,0,0.99,1)&quot; : &quot;12&quot; == self._scrollMode ? &quot;cubic-bezier(.17,.67,.87,.13)&quot; : &quot;linear&quot;;
                    self.$currentPage.style.webkitTransition = &quot;-webkit-transform &quot; + transformTime + &quot;s &quot; + ease;
                    self.$activePage.style.webkitTransition = &quot;-webkit-transform &quot; + transformTime + &quot;s &quot; + ease;
                    self.$currentPage.style.mozTransition = &quot;-moz-transform &quot; + transformTime + &quot;s &quot; + ease;
                    self.$activePage.style.mozTransition = &quot;-moz-transform &quot; + transformTime + &quot;s &quot; + ease;
                    self.$currentPage.style.transition = &quot;transform &quot; + transformTime + &quot;s &quot; + ease;
                    self.$activePage.style.transition = &quot;transform &quot; + transformTime + &quot;s &quot; + ease;

                    // 完成翻页
                    if (&quot;0&quot; == self._scrollMode || (&quot;2&quot; == self._scrollMode || (&quot;1&quot; == self._scrollMode || &quot;15&quot; == self._scrollMode))) &#123;
                        endUpDownFlip();
                    &#125; else if (&quot;4&quot; == self._scrollMode || &quot;3&quot; == self._scrollMode) &#123;
                        // 左右翻页
                        endLeftRightFlip();
                    &#125; else if (&quot;5&quot; == self._scrollMode) &#123;
                        //左右连续翻页
                        endLeftRightContinueFlip();
                    &#125; else if (&quot;6&quot; == self._scrollMode) &#123;
                        //立体翻页
                        endCubeFlip();
                    &#125; else if (&quot;7&quot; == self._scrollMode) &#123;
                        //卡片翻页
                        endCardFlip();
                    &#125; else if (&quot;8&quot; == self._scrollMode) &#123;
                        //放大翻页
                        endScaleUpFlip();
                    &#125; else if (&quot;9&quot; == self._scrollMode) &#123;
                        //交换翻页
                        endSwitchFlip();
                    &#125; else if (&quot;11&quot; == self._scrollMode) &#123;
                        //上下连续翻页
                        endUpDownContinueFlip();
                    &#125; else if (&quot;12&quot; == self._scrollMode) &#123;
                        //掉落翻页
                        endDropFlip();
                    &#125; else if (&quot;13&quot; == self._scrollMode || &quot;14&quot; == self._scrollMode) &#123;
                        //淡入翻页
                        endFadeFlip();
                    &#125; 

                    /** @type &#123;number&#125; */
                    var pageIndex = $(self.$activePage).find(&quot;.m-img&quot;).attr(&quot;id&quot;).replace(&quot;page&quot;, &quot;&quot;) - 1;
                    if (self._pageData[pageIndex].properties) &#123;
                        if (self._pageData[pageIndex].properties.longPage) &#123;
                            $(document).trigger(&quot;clearTouchPos&quot;);
                        &#125;
                    &#125;
                    $(self.$activePage).find(&quot;li.comp-resize&quot;).each(function (dataAndEvents) &#123;
                        /** @type &#123;number&#125; */
                        var i = 0;
                        for (; i &lt; self._pageData[pageIndex].elements.length; i++) &#123;
                            if (self._pageData[pageIndex].elements[i].id == parseInt($(this).attr(&quot;id&quot;).substring(7), 10)) &#123;
                                eqxCommon.animation($(this), self._pageData[pageIndex].elements[i], &quot;view&quot;, self._pageData[pageIndex].properties);
                                var r20 = getComp(self._pageData[pageIndex].elements[i].id);
                                eqxCommon.bindTrigger(r20, self._pageData[pageIndex].elements[i]);
                            &#125;
                        &#125;
                    &#125;);
                    /** @type &#123;number&#125; */
                    var i = 0;
                    for (; i &lt; self._pageData.length; i++) &#123;
                        if (self._pageData[i].effObj) &#123;
                            /** @type &#123;boolean&#125; */
                            self._pageData[i].effObj.pause = true;
                        &#125;
                    &#125;
                    if (self._pageData[pageIndex].effObj) &#123;
                        self._pageData[pageIndex].effObj.startPlay();
                    &#125;
                    eqShow.setPageHis(self._pageData[pageIndex].id);
                &#125; else &#123;
                    self.$currentPage.classList.remove(&quot;z-move&quot;);
                &#125;
            &#125;
            C = false;
        &#125;;
</code></pre>
<p>然后再来看自动翻页nextPage</p>
<pre><code>  /**
     * 启动自动翻页
     * @return &#123;undefined&#125;
     */
    function startAutoFlip() &#123;
        // 通过setInterval
        autoFlipIntervalId = setInterval(function () &#123;
            if (!(10 === self._scrollMode)) &#123;
                if (!isTouching) &#123;
                    nextPage();
                &#125;
            &#125;
        &#125;, autoFlipTimeMS);
    &#125;
</code></pre>
<p>自动翻页比较简单，模拟滑动操作，当位移足够时就可以自动翻页了：</p>
<pre><code>/**
     *  上一页
     * @param &#123;number&#125; direction
     * @return &#123;undefined&#125;
     */
    function prePage(direction) &#123;
        if (!(leftRightMode &amp;&amp; 2 == direction || upDownMode &amp;&amp; 1 == direction)) &#123;
            if (&quot;10&quot; != self._scrollMode) &#123;
                var offset = 0;
                // 开启滑动
                onTouchStart();
                // 定时器，增加offset,模拟滑动
                var poll = setInterval(function () &#123;
                    offset += 2;
                    if (&quot;0&quot; == self._scrollMode || (&quot;1&quot; == self._scrollMode || (&quot;2&quot; == self._scrollMode || (&quot;6&quot; == self._scrollMode || (&quot;7&quot; == self._scrollMode || (&quot;8&quot; == self._scrollMode || (&quot;11&quot; == self._scrollMode || (&quot;12&quot; == self._scrollMode || (&quot;13&quot; == self._scrollMode || (&quot;14&quot; == self._scrollMode || &quot;15&quot; == self._scrollMode)))))))))) &#123;
                        // 纵向翻页，增加y
                        offsetY = offset;
                    &#125; else &#123;
                        if (&quot;3&quot; == self._scrollMode || (&quot;4&quot; == self._scrollMode || (&quot;5&quot; == self._scrollMode || &quot;9&quot; == self._scrollMode))) &#123;
                            // 横向翻页，增加x
                            offsetX = offset;
                        &#125;
                    &#125;
                    // 触发move操作，模拟滑动
                    onTouchMove();
                    if (offset &gt;= 21) &#123;
                        // 位移超过20，
                        clearInterval(poll);
                        // 停止滑动,完成翻页
                        onTouchEnd();
                    &#125;
                &#125;, 1);
            &#125; else &#123;
                // 翻书
                $(document).trigger(&quot;bookFlipPre&quot;);
            &#125;
        &#125;
    &#125;

    /**
     * 下一页，逻辑和prePage类似
     * @param &#123;number&#125; direction
     * @return &#123;undefined&#125;
     */
    function nextPage(direction) &#123;
        if (!(leftRightMode &amp;&amp; 2 == direction || upDownMode &amp;&amp; 1 == direction)) &#123;
            if (&quot;10&quot; != self._scrollMode) &#123;
                u = false;
                var offset = 0;
                if (&quot;block&quot; == $(&quot;body .boards-panel&quot;).css(&quot;display&quot;)) &#123;
                    $(&quot;body .boards-panel&quot;).hide();
                    $(&quot;body .z-current&quot;).show();
                &#125;
                onTouchStart();
                var poll = setInterval(function () &#123;
                    offset -= 2;
                    if (&quot;0&quot; == self._scrollMode || (&quot;1&quot; == self._scrollMode || (&quot;2&quot; == self._scrollMode || (&quot;6&quot; == self._scrollMode || (&quot;7&quot; == self._scrollMode || (&quot;8&quot; == self._scrollMode || (&quot;11&quot; == self._scrollMode || (&quot;12&quot; == self._scrollMode || (&quot;13&quot; == self._scrollMode || (&quot;14&quot; == self._scrollMode || &quot;15&quot; == self._scrollMode)))))))))) &#123;
                        offsetY = offset;
                    &#125; else &#123;
                        if (&quot;3&quot; == self._scrollMode || (&quot;4&quot; == self._scrollMode || (&quot;5&quot; == self._scrollMode || &quot;9&quot; == self._scrollMode))) &#123;
                            offsetX = offset;
                        &#125;
                    &#125;
                    onTouchMove();
                    if (-21 &gt;= offset) &#123;
                        clearInterval(poll);
                        onTouchEnd();
                        if (!triggerLoop) &#123;
                            if (!self.$activePage) &#123;
                                clearInterval(autoFlipIntervalId);
                            &#125;
                        &#125;
                    &#125;
                &#125;, 1);
            &#125; else &#123;
                $(document).trigger(&quot;bookFlipNext&quot;);
            &#125;
        &#125;
    &#125;
</code></pre>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>上面是花了大概一天多的时间阅读代码的成果，总结经验就是阅读代码先分析大的流程，再层层递进分析一些细节，就能一步一步接近真相。</p>
<p>另外，阅读压缩过的代码，可以借助VS Code，善用F2重命名，修改的越多，越接近本来的代码：）</p>
<hr>
<blockquote>
<p>作者：Jadepeng<br> 出处：jqpeng的技术记事本–<a target="_blank" rel="noopener" href="http://www.cnblogs.com/xiaoqi">http://www.cnblogs.com/xiaoqi</a><br> 您的支持是对博主最大的鼓励，感谢您的认真阅读。<br> 本文版权归作者所有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文连接，否则保留追究法律责任的权利。</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.iflyresearch.com/2018/02/28/jqpeng-Spring%20boot%E8%87%AA%E5%AE%9A%E4%B9%89%E5%90%AF%E5%8A%A8%E5%AD%97%E7%AC%A6%E7%94%BB%EF%BC%88banner%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="JadePeng">
      <meta itemprop="description" content="JadePeng的技术笔记本">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JadePeng的技术笔记本">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2018/02/28/jqpeng-Spring%20boot%E8%87%AA%E5%AE%9A%E4%B9%89%E5%90%AF%E5%8A%A8%E5%AD%97%E7%AC%A6%E7%94%BB%EF%BC%88banner%EF%BC%89/" class="post-title-link" itemprop="url">Spring boot自定义启动字符画（banner）</a>
        </h2>

        <div class="post-meta">

         
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-02-28 11:11:00" itemprop="dateCreated datePublished" datetime="2018-02-28T11:11:00+08:00">2018-02-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 17:44:20" itemprop="dateModified" datetime="2021-05-14T17:44:20+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%8D%9A%E5%AE%A2/" itemprop="url" rel="index"><span itemprop="name">博客</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%8D%9A%E5%AE%A2/jqpeng/" itemprop="url" rel="index"><span itemprop="name">jqpeng</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.8k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>文章作者:jqpeng<br>原文链接: <a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaoqi/p/springboot-banner.html">Spring boot自定义启动字符画（banner）</a></p>
<p>spring boot项目启动时会打印spring boot的ANSI字符画，可以进行自定义。</p>
<h2 id="如何自定义"><a href="#如何自定义" class="headerlink" title="如何自定义"></a>如何自定义</h2><p>实现方式非常简单，我们只需要在Spring Boot工程的/src/main/resources目录下创建一个banner.txt文件，然后将ASCII字符画复制进去，就能替换默认的banner了。</p>
<pre><code>█████████████████████████████████████████████████████████████████████████████████████████████████████

 █████╗ ██╗██╗   ██╗██╗    ███████╗ █████╗  █████╗ ███████╗
██╔══██╗██║██║   ██║██║    ██╔════╝██╔══██╗██╔══██╗██╔════╝
███████║██║██║   ██║██║    ███████╗███████║███████║███████╗
██╔══██║██║██║   ██║██║    ╚════██║██╔══██║██╔══██║╚════██║
██║  ██║██║╚██████╔╝██║    ███████║██║  ██║██║  ██║███████║
╚═╝  ╚═╝╚═╝ ╚═════╝ ╚═╝    ╚══════╝╚═╝  ╚═╝╚═╝  ╚═╝╚══════╝

█████████████████████████████████████████████████████████████████████████████████████████████████████
</code></pre>
<h2 id="如何生成字符画"><a href="#如何生成字符画" class="headerlink" title="如何生成字符画"></a>如何生成字符画</h2><p>如果让我们手工的来编辑这些字符画，显然是一件非常困难的差事。</p>
<p>正好刚接触jhipster，发现有一个 <a target="_blank" rel="noopener" href="https://github.com/PierreBesson/generator-jhipster-banner">generator-jhipster-banner插件</a>，可以生成banner.</p>
<p>首先安装：</p>
<pre><code>npm install -g generator-jhipster-banner
</code></pre>
<p>使用：</p>
<pre><code>yo jhipster-banner.
</code></pre>
<p>没有安装yo的，先安装：</p>
<pre><code>npm install -g yo
</code></pre>
<p>按提示输入文本和选择颜色即可。</p>
<p>其他方法：</p>
<p><a target="_blank" rel="noopener" href="http://patorjk.com/software/taag">http://patorjk.com/software/taag</a><br><a target="_blank" rel="noopener" href="http://www.network-science.de/ascii/">http://www.network-science.de/ascii/</a><br><a target="_blank" rel="noopener" href="http://www.degraeve.com/img2txt.php">http://www.degraeve.com/img2txt.php</a></p>
<h2 id="彩蛋：永不宕机佛祖"><a href="#彩蛋：永不宕机佛祖" class="headerlink" title="彩蛋：永不宕机佛祖"></a>彩蛋：永不宕机佛祖</h2><pre><code>$&#123;AnsiColor.BRIGHT_YELLOW&#125;
////////////////////////////////////////////////////////////////////
//                          _ooOoo_                               //
//                         o8888888o                              //
//                         88&quot; . &quot;88                              //
//                         (| ^_^ |)                              //
//                         O\  =  /O                              //
//                      ____/`---&#39;\____                           //
//                    .&#39;  \\|     |//  `.                         //
//                   /  \\|||  :  |||//  \                        //
//                  /  _||||| -:- |||||-  \                       //
//                  |   | \\\  -  /// |   |                       //
//                  | \_|  &#39;&#39;\---/&#39;&#39;  |   |                       //
//                  \  .-\__  `-`  ___/-. /                       //
//                ___`. .&#39;  /--.--\  `. . ___                     //
//              .&quot;&quot; &#39;&lt;  `.___\_&lt;|&gt;_/___.&#39;  &gt;&#39;&quot;&quot;.                  //
//            | | :  `- \`.;`\ _ /`;.`/ - ` : | |                 //
//            \  \ `-.   \_ __\ /__ _/   .-` /  /                 //
//      ========`-.____`-.___\_____/___.-`____.-&#39;========         //
//                           `=---=&#39;                              //
//      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^        //
//            佛祖保佑       永不宕机     永无BUG                  //
////////////////////////////////////////////////////////////////////
</code></pre>
<hr>
<blockquote>
<p>作者：Jadepeng<br> 出处：jqpeng的技术记事本–<a target="_blank" rel="noopener" href="http://www.cnblogs.com/xiaoqi">http://www.cnblogs.com/xiaoqi</a><br> 您的支持是对博主最大的鼓励，感谢您的认真阅读。<br> 本文版权归作者所有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文连接，否则保留追究法律责任的权利。</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.iflyresearch.com/2018/01/04/jqpeng-gitbook%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8%EF%BC%8C%E5%B9%B6%E4%BD%BF%E7%94%A8docker%E9%83%A8%E7%BD%B2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="JadePeng">
      <meta itemprop="description" content="JadePeng的技术笔记本">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JadePeng的技术笔记本">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2018/01/04/jqpeng-gitbook%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8%EF%BC%8C%E5%B9%B6%E4%BD%BF%E7%94%A8docker%E9%83%A8%E7%BD%B2/" class="post-title-link" itemprop="url">gitbook安装与使用，并使用docker部署</a>
        </h2>

        <div class="post-meta">

         
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-01-04 17:03:00" itemprop="dateCreated datePublished" datetime="2018-01-04T17:03:00+08:00">2018-01-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 17:44:20" itemprop="dateModified" datetime="2021-05-14T17:44:20+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%8D%9A%E5%AE%A2/" itemprop="url" rel="index"><span itemprop="name">博客</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%8D%9A%E5%AE%A2/jqpeng/" itemprop="url" rel="index"><span itemprop="name">jqpeng</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>文章作者:jqpeng<br>原文链接: <a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaoqi/p/gitbook-setup-and-usage-publish-with-docker.html">gitbook安装与使用，并使用docker部署</a></p>
<p>本文简单介绍如何安装并使用gitbook，最后如何使用docker构建书籍镜像。</p>
<h1 id="1-前置条件"><a href="#1-前置条件" class="headerlink" title="1. 前置条件"></a>1. 前置条件</h1><p>需要Nodejs环境，安装npm，国内用户再安装cnpm</p>
<pre><code>npm install -g cnpm --registry=https://registry.npm.taobao.org
</code></pre>
<h1 id="2-安装gitbook"><a href="#2-安装gitbook" class="headerlink" title="2. 安装gitbook"></a>2. 安装gitbook</h1><pre><code>cnpm install -g gitbook-cli
gitbook -V 
CLI version: 2.3.2
Installing GitBook 3.2.3
gitbook@3.2.3 ..\AppData\Local\Temp\tmp-20544doJtj1hfVp40\node_modules\gitbook
├── escape-string-regexp@1.0.5
├── escape-html@1.0.3
 。。。。
GitBook version: 3.2.3
</code></pre>
<h1 id="3-gitbook使用"><a href="#3-gitbook使用" class="headerlink" title="3. gitbook使用"></a>3. gitbook使用</h1><h2 id="3-1-生成目录和图书结构"><a href="#3-1-生成目录和图书结构" class="headerlink" title="3.1 生成目录和图书结构"></a>3.1 生成目录和图书结构</h2><pre><code>mkdir docker-start
gitbook init
warn: no summary file in this book
info: create README.md
info: create SUMMARY.md
info: initialization is finished
</code></pre>
<p>编辑SUMMARY.md，输入：</p>
<pre><code>* [简介](README.md)
* [1.Docker入门](chapter1/README.md)
 - [1.1 什么是Docker](chapter1/section1.md)
 - [1.2 Docker基本概念](chapter1/section2.md)
 - [1.3 安装Docker](chapter1/section3.md)
 - [1.4 使用Docker镜像](chapter1/section4.md)
 - [1.5 操作容器](chapter1/section5.md)
 - [1.6 访问仓库](chapter1/section6.md)
 - [1.6 数据管理](chapter1/section7.md)
* [2.使用Docker部署web应用](chapter2/README.md)
 - [2.1 编写DockerFile](chapter2/section1.md)
 - [2.2 编写web应用](chapter2/section2.md)
 - [2.3 构建镜像](chapter2/section3.md)
 - [2.4 运行web应用](chapter2/section4.md)
 - [2.5 分享镜像](chapter2/section5.md)
* [结束](end/README.md)
</code></pre>
<p>再次执行：</p>
<pre><code>gitbook init
info: create chapter1/README.md
info: create chapter1/section1.md
info: create chapter1/section2.md
info: create chapter1/section3.md
info: create chapter1/section4.md
info: create chapter1/section5.md
info: create chapter1/section6.md
info: create chapter1/section7.md
info: create chapter2/README.md
info: create chapter2/section1.md
info: create chapter2/section2.md
info: create chapter2/section3.md
info: create chapter2/section4.md
info: create chapter2/section5.md
info: create end/README.md
info: create SUMMARY.md
info: initialization is finished
</code></pre>
<h2 id="3-2-生成图书"><a href="#3-2-生成图书" class="headerlink" title="3.2 生成图书"></a>3.2 生成图书</h2><p>使用：</p>
<pre><code>gitbook serve .
Live reload server started on port: 35729
Press CTRL+C to quit ...

info: 7 plugins are installed
info: loading plugin &quot;livereload&quot;... OK
info: loading plugin &quot;highlight&quot;... OK
info: loading plugin &quot;search&quot;... OK
info: loading plugin &quot;lunr&quot;... OK
info: loading plugin &quot;sharing&quot;... OK
info: loading plugin &quot;fontsettings&quot;... OK
info: loading plugin &quot;theme-default&quot;... OK
info: found 16 pages
info: found 15 asset files
info: &gt;&gt; generation finished with success in 4.0s !

Starting server ...
Serving book on http://localhost:4000
</code></pre>
<p>访问 <a target="_blank" rel="noopener" href="http://localhost:4000/">http://localhost:4000</a> ，就可以看到图书了</p>
<p><img src="http://oyqmmpkcm.bkt.clouddn.com/1515048112496.jpg" alt="enter description here" title="1515048112496"></p>
<p>编辑生成的md，gitbook会自动Restart，</p>
<p><img src="http://oyqmmpkcm.bkt.clouddn.com/1515048702182.jpg" alt="enter description here" title="1515048702182"></p>
<p>在当前目录下，会生成一个_book目录 ，里面是生成的静态html，可以发布到服务器直接使用。</p>
<h1 id="4-使用docker发布gitbook书籍"><a href="#4-使用docker发布gitbook书籍" class="headerlink" title="4. 使用docker发布gitbook书籍"></a>4. 使用docker发布gitbook书籍</h1><p>首先 将_book目录里的内容拷贝到一个新目录。</p>
<p>然后编写Dockerfile</p>
<pre><code>FROM nginx
WORKDIR /usr/share/nginx/html
ADD . /usr/share/nginx/html
EXPOSE 80
</code></pre>
<p>build：</p>
<pre><code>docker build -t docker-start-web .
Sending build context to Docker daemon  4.766MB
Step 1/4 : FROM nginx
 ---&gt; 3f8a4339aadd
Step 2/4 : WORKDIR /usr/share/nginx/html
Removing intermediate container a4232f4b6b62
 ---&gt; 91a66299ecad
Step 3/4 : ADD . /usr/share/nginx/html
 ---&gt; 9a9fef80da3b
Step 4/4 : EXPOSE 80
 ---&gt; Running in 59f2b829aba6
Removing intermediate container 59f2b829aba6
 ---&gt; b92c92688046
Successfully built b92c92688046
Successfully tagged docker-start-web:latest
</code></pre>
<p>执行：</p>
<pre><code>docker run -p 4000:80 --name docker-start-web -d docker-start-web
f91cf4446b3746c665476b3dd214446a941d838fa9a3ad47680190bb08c9aa48
</code></pre>
<p>访问服务器ip:4000就可以查看到了。</p>
<hr>
<blockquote>
<p>作者：Jadepeng<br> 出处：jqpeng的技术记事本–<a target="_blank" rel="noopener" href="http://www.cnblogs.com/xiaoqi">http://www.cnblogs.com/xiaoqi</a><br> 您的支持是对博主最大的鼓励，感谢您的认真阅读。<br> 本文版权归作者所有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文连接，否则保留追究法律责任的权利。</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.iflyresearch.com/2017/12/26/jqpeng-%E4%BD%BF%E7%94%A8Spring%E8%AE%BF%E9%97%AEMongodb%E7%9A%84%E6%96%B9%E6%B3%95%E5%A4%A7%E5%85%A8%E2%80%94%E2%80%94Spring%20Data%20MongoDB%E6%9F%A5%E8%AF%A2%E6%8C%87%E5%8D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="JadePeng">
      <meta itemprop="description" content="JadePeng的技术笔记本">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JadePeng的技术笔记本">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2017/12/26/jqpeng-%E4%BD%BF%E7%94%A8Spring%E8%AE%BF%E9%97%AEMongodb%E7%9A%84%E6%96%B9%E6%B3%95%E5%A4%A7%E5%85%A8%E2%80%94%E2%80%94Spring%20Data%20MongoDB%E6%9F%A5%E8%AF%A2%E6%8C%87%E5%8D%97/" class="post-title-link" itemprop="url">使用Spring访问Mongodb的方法大全——Spring Data MongoDB查询指南</a>
        </h2>

        <div class="post-meta">

         
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-12-26 16:28:00" itemprop="dateCreated datePublished" datetime="2017-12-26T16:28:00+08:00">2017-12-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 17:44:20" itemprop="dateModified" datetime="2021-05-14T17:44:20+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%8D%9A%E5%AE%A2/" itemprop="url" rel="index"><span itemprop="name">博客</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%8D%9A%E5%AE%A2/jqpeng/" itemprop="url" rel="index"><span itemprop="name">jqpeng</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>8.6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>8 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>文章作者:jqpeng<br>原文链接: <a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaoqi/p/queries-in-spring-data-mongodb.html">使用Spring访问Mongodb的方法大全——Spring Data MongoDB查询指南</a></p>
<h1 id="1-概述"><a href="#1-概述" class="headerlink" title="1.概述"></a>1.概述</h1><p>Spring Data MongoDB 是Spring框架访问mongodb的神器，借助它可以非常方便的读写mongo库。本文介绍使用Spring Data MongoDB来访问mongodb数据库的几种方法：</p>
<ul>
<li>使用Query和Criteria类</li>
<li>JPA自动生成的查询方法</li>
<li>使用@Query 注解基于JSON查询</li>
</ul>
<p>在开始前，首先需要引入maven依赖</p>
<h2 id="1-1-添加Maven的依赖"><a href="#1-1-添加Maven的依赖" class="headerlink" title="1.1 添加Maven的依赖"></a>1.1 添加Maven的依赖</h2><p>如果您想使用Spring Data MongoDB，则需要将以下条目添加到您的pom.xml文件中：</p>
<pre><code>&lt;dependency&gt;&lt;groupId&gt;org.springframework.data&lt;/groupId&gt;&lt;artifactId&gt;spring-data-mongodb&lt;/artifactId&gt;&lt;version&gt;1.9.6.RELEASE&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<p>版本根据需要选择。</p>
<h1 id="2-文档查询"><a href="#2-文档查询" class="headerlink" title="2.文档查询"></a>2.文档查询</h1><p>使用Spring Data来查询MongoDB的最常用方法之一是使用Query和Criteria类 ， 它们非常接近本地操作符。</p>
<h2 id="2-1-is查询"><a href="#2-1-is查询" class="headerlink" title="2.1 is查询"></a>2.1 is查询</h2><p>在以下示例中 - 我们正在寻找名为Eric的用户。</p>
<p>我们来看看我们的数据库：</p>
<pre><code>[&#123;    &quot;_id&quot; : ObjectId(&quot;55c0e5e5511f0a164a581907&quot;),    &quot;_class&quot; : &quot;org.baeldung.model.User&quot;,    &quot;name&quot; : &quot;Eric&quot;,    &quot;age&quot; : 45&#125;,&#123;    &quot;_id&quot; : ObjectId(&quot;55c0e5e5511f0a164a581908&quot;),    &quot;_class&quot; : &quot;org.baeldung.model.User&quot;,    &quot;name&quot; : &quot;Antony&quot;,    &quot;age&quot; : 55&#125;
&#125;]
</code></pre>
<p>让我们看看查询代码：</p>
<pre><code>Query query = new Query();
query.addCriteria(Criteria.where(&quot;name&quot;).is(&quot;Eric&quot;));
List&lt;User&gt; users = mongoTemplate.find(query, User.class);
</code></pre>
<p>如预期的那样，这个逻辑返回：</p>
<pre><code>&#123;&quot;_id&quot; : ObjectId(&quot;55c0e5e5511f0a164a581907&quot;),&quot;_class&quot; : &quot;org.baeldung.model.User&quot;,&quot;name&quot; : &quot;Eric&quot;,&quot;age&quot; : 45
&#125;
</code></pre>
<h2 id="2-2-正则查询"><a href="#2-2-正则查询" class="headerlink" title="2.2 正则查询"></a>2.2 正则查询</h2><p>正则表达式是一个更灵活和强大的查询类型。这使用了一个使用MongoDB $ regex的标准，该标准返回适用于这个字段的这个正则表达式的所有记录。</p>
<p>它的作用类似于startingWith，endingWith操作 - 让我们来看一个例子。</p>
<p>寻找名称以A开头的所有用户，这是数据库的状态：</p>
<pre><code>[&#123;    &quot;_id&quot; : ObjectId(&quot;55c0e5e5511f0a164a581907&quot;),    &quot;_class&quot; : &quot;org.baeldung.model.User&quot;,    &quot;name&quot; : &quot;Eric&quot;,    &quot;age&quot; : 45&#125;,&#123;    &quot;_id&quot; : ObjectId(&quot;55c0e5e5511f0a164a581908&quot;),    &quot;_class&quot; : &quot;org.baeldung.model.User&quot;,    &quot;name&quot; : &quot;Antony&quot;,    &quot;age&quot; : 33&#125;,&#123;    &quot;_id&quot; : ObjectId(&quot;55c0e5e5511f0a164a581909&quot;),    &quot;_class&quot; : &quot;org.baeldung.model.User&quot;,    &quot;name&quot; : &quot;Alice&quot;,    &quot;age&quot; : 35&#125;
]
</code></pre>
<p>我们来创建查询：</p>
<pre><code>Query query = new Query();
query.addCriteria(Criteria.where(&quot;name&quot;).regex(&quot;^A&quot;));
List&lt;User&gt; users = mongoTemplate.find(query,User.class);
</code></pre>
<p>这运行并返回2条记录：</p>
<pre><code>[&#123;    &quot;_id&quot; : ObjectId(&quot;55c0e5e5511f0a164a581908&quot;),    &quot;_class&quot; : &quot;org.baeldung.model.User&quot;,    &quot;name&quot; : &quot;Antony&quot;,    &quot;age&quot; : 33&#125;,&#123;    &quot;_id&quot; : ObjectId(&quot;55c0e5e5511f0a164a581909&quot;),    &quot;_class&quot; : &quot;org.baeldung.model.User&quot;,    &quot;name&quot; : &quot;Alice&quot;,    &quot;age&quot; : 35&#125;
]
</code></pre>
<p>下面是另一个简单的例子，这次查找名称以c结尾的所有用户：</p>
<pre><code>Query query = new Query();
query.addCriteria(Criteria.where(&quot;name&quot;).regex(&quot;c$&quot;));
List&lt;User&gt; users = mongoTemplate.find(query, User.class);
</code></pre>
<p>所以结果是：</p>
<pre><code>&#123;&quot;_id&quot; : ObjectId(&quot;55c0e5e5511f0a164a581907&quot;),&quot;_class&quot; : &quot;org.baeldung.model.User&quot;,&quot;name&quot; : &quot;Eric&quot;,&quot;age&quot; : 45
&#125;
</code></pre>
<h2 id="2-3-LT和GT"><a href="#2-3-LT和GT" class="headerlink" title="2.3 LT和GT"></a>2.3 LT和GT</h2><p>$ lt（小于）运算符和$ gt（大于）。</p>
<p>让我们快速看一个例子 - 我们正在寻找年龄在20岁到50岁之间的所有用户。</p>
<p>数据库是：</p>
<pre><code>[&#123;    &quot;_id&quot; : ObjectId(&quot;55c0e5e5511f0a164a581907&quot;),    &quot;_class&quot; : &quot;org.baeldung.model.User&quot;,    &quot;name&quot; : &quot;Eric&quot;,    &quot;age&quot; : 45&#125;,&#123;    &quot;_id&quot; : ObjectId(&quot;55c0e5e5511f0a164a581908&quot;),    &quot;_class&quot; : &quot;org.baeldung.model.User&quot;,    &quot;name&quot; : &quot;Antony&quot;,    &quot;age&quot; : 55&#125;
&#125;
</code></pre>
<p>构造查询：</p>
<pre><code>Query query = new Query();
query.addCriteria(Criteria.where(&quot;age&quot;).lt(50).gt(20));
List&lt;User&gt; users = mongoTemplate.find(query,User.class);
</code></pre>
<p>结果 - 年龄大于20且小于50的所有用户：</p>
<pre><code>&#123;&quot;_id&quot; : ObjectId(&quot;55c0e5e5511f0a164a581907&quot;),&quot;_class&quot; : &quot;org.baeldung.model.User&quot;,&quot;name&quot; : &quot;Eric&quot;,&quot;age&quot; : 45
&#125;
</code></pre>
<h2 id="2-4-结果排序"><a href="#2-4-结果排序" class="headerlink" title="2.4 结果排序"></a>2.4 结果排序</h2><p>Sort用于指定结果的排序顺序。</p>
<p>首先 - 这里是现有的数据：</p>
<pre><code>[&#123;    &quot;_id&quot; : ObjectId(&quot;55c0e5e5511f0a164a581907&quot;),    &quot;_class&quot; : &quot;org.baeldung.model.User&quot;,    &quot;name&quot; : &quot;Eric&quot;,    &quot;age&quot; : 45&#125;,&#123;    &quot;_id&quot; : ObjectId(&quot;55c0e5e5511f0a164a581908&quot;),    &quot;_class&quot; : &quot;org.baeldung.model.User&quot;,    &quot;name&quot; : &quot;Antony&quot;,    &quot;age&quot; : 33&#125;,&#123;    &quot;_id&quot; : ObjectId(&quot;55c0e5e5511f0a164a581909&quot;),    &quot;_class&quot; : &quot;org.baeldung.model.User&quot;,    &quot;name&quot; : &quot;Alice&quot;,    &quot;age&quot; : 35&#125;
]
</code></pre>
<p>执行排序后：</p>
<pre><code>Query query = new Query();
query.with(new Sort(Sort.Direction.ASC, &quot;age&quot;));
List&lt;User&gt; users = mongoTemplate.find(query,User.class);
</code></pre>
<p>这是查询的结果 - 很好地按年龄排序：</p>
<pre><code>[&#123;    &quot;_id&quot; : ObjectId(&quot;55c0e5e5511f0a164a581908&quot;),    &quot;_class&quot; : &quot;org.baeldung.model.User&quot;,    &quot;name&quot; : &quot;Antony&quot;,    &quot;age&quot; : 33&#125;,&#123;    &quot;_id&quot; : ObjectId(&quot;55c0e5e5511f0a164a581909&quot;),    &quot;_class&quot; : &quot;org.baeldung.model.User&quot;,    &quot;name&quot; : &quot;Alice&quot;,    &quot;age&quot; : 35&#125;,&#123;    &quot;_id&quot; : ObjectId(&quot;55c0e5e5511f0a164a581907&quot;),    &quot;_class&quot; : &quot;org.baeldung.model.User&quot;,    &quot;name&quot; : &quot;Eric&quot;,    &quot;age&quot; : 45&#125;
]
</code></pre>
<h2 id="2-5-分页"><a href="#2-5-分页" class="headerlink" title="2.5 分页"></a>2.5 分页</h2><p>我们来看一个使用分页的简单例子。</p>
<p>这是数据库的状态：</p>
<pre><code>[&#123;    &quot;_id&quot; : ObjectId(&quot;55c0e5e5511f0a164a581907&quot;),    &quot;_class&quot; : &quot;org.baeldung.model.User&quot;,    &quot;name&quot; : &quot;Eric&quot;,    &quot;age&quot; : 45&#125;,&#123;    &quot;_id&quot; : ObjectId(&quot;55c0e5e5511f0a164a581908&quot;),    &quot;_class&quot; : &quot;org.baeldung.model.User&quot;,    &quot;name&quot; : &quot;Antony&quot;,    &quot;age&quot; : 33&#125;,&#123;    &quot;_id&quot; : ObjectId(&quot;55c0e5e5511f0a164a581909&quot;),    &quot;_class&quot; : &quot;org.baeldung.model.User&quot;,    &quot;name&quot; : &quot;Alice&quot;,    &quot;age&quot; : 35&#125;
]
</code></pre>
<p>现在，查询逻辑，只需要一个大小为2的页面：</p>
<pre><code>final Pageable pageableRequest = new PageRequest(0, 2);
Query query = new Query();
query.with(pageableRequest);
</code></pre>
<p>结果 ：</p>
<pre><code>[&#123;    &quot;_id&quot; : ObjectId(&quot;55c0e5e5511f0a164a581907&quot;),    &quot;_class&quot; : &quot;org.baeldung.model.User&quot;,    &quot;name&quot; : &quot;Eric&quot;,    &quot;age&quot; : 45&#125;,&#123;    &quot;_id&quot; : ObjectId(&quot;55c0e5e5511f0a164a581908&quot;),    &quot;_class&quot; : &quot;org.baeldung.model.User&quot;,    &quot;name&quot; : &quot;Antony&quot;,    &quot;age&quot; : 33&#125;
]
</code></pre>
<p>为了探索这个API的全部细节，这里是Query和Criteria类的文档。</p>
<h2 id="3-生成的查询方法（Generated-Query-Methods）"><a href="#3-生成的查询方法（Generated-Query-Methods）" class="headerlink" title="3.生成的查询方法（Generated Query Methods）"></a>3.生成的查询方法（Generated Query Methods）</h2><p>生成查询方法是JPA的一个特性，在Spring Data Mongodb里也可以使用。</p>
<p>要做到2里功能，只需要在接口上声明方法即可，</p>
<pre><code>public interface UserRepository 
  extends MongoRepository&lt;User, String&gt;, QueryDslPredicateExecutor&lt;User&gt; &#123;...
&#125;
</code></pre>
<h2 id="3-1-FindByX"><a href="#3-1-FindByX" class="headerlink" title="3.1 FindByX"></a>3.1 FindByX</h2><p>我们将通过探索findBy类型的查询来简单地开始 - 在这种情况下，通过名称查找：</p>
<pre><code>List&lt;User&gt; findByName(String name);
</code></pre>
<p>与上一节相同 2.1 - 查询将具有相同的结果，查找具有给定名称的所有用户：</p>
<pre><code>List&lt;User&gt; users = userRepository.findByName(&quot;Eric&quot;);
</code></pre>
<h2 id="3-2-StartingWith-and-endingWith"><a href="#3-2-StartingWith-and-endingWith" class="headerlink" title="3.2  StartingWith and endingWith."></a>3.2  StartingWith and endingWith.</h2><p>下面是操作过程的一个简单例子：</p>
<pre><code>List&lt;User&gt; findByNameStartingWith(String regexp);

List&lt;User&gt; findByNameEndingWith(String regexp);
</code></pre>
<p>实际使用这个例子当然会非常简单：</p>
<pre><code>List&lt;User&gt; users = userRepository.findByNameStartingWith(&quot;A&quot;);
List&lt;User&gt; users = userRepository.findByNameEndingWith(&quot;c&quot;);
</code></pre>
<p>结果是完全一样的。</p>
<h2 id="3-3-Between"><a href="#3-3-Between" class="headerlink" title="3.3 Between"></a>3.3 Between</h2><p>类似于2.3，这将返回年龄在ageGT和ageLT之间的所有用户：</p>
<pre><code>List&lt;User&gt; findByAgeBetween(int ageGT, int ageLT);
List&lt;User&gt; users = userRepository.findByAgeBetween(20, 50);
</code></pre>
<h2 id="3-4-Like和OrderBy"><a href="#3-4-Like和OrderBy" class="headerlink" title="3.4 Like和OrderBy"></a>3.4 Like和OrderBy</h2><p>让我们来看看这个更高级的示例 - 为生成的查询组合两种类型的修饰符。</p>
<p>我们将要查找名称中包含字母A的所有用户，我们也将按年龄顺序排列结果：</p>
<pre><code>List&lt;User&gt; users = userRepository.findByNameLikeOrderByAgeAsc(&quot;A&quot;);
</code></pre>
<p>结果：</p>
<pre><code>[&#123;    &quot;_id&quot; : ObjectId(&quot;55c0e5e5511f0a164a581908&quot;),    &quot;_class&quot; : &quot;org.baeldung.model.User&quot;,    &quot;name&quot; : &quot;Antony&quot;,    &quot;age&quot; : 33&#125;,&#123;    &quot;_id&quot; : ObjectId(&quot;55c0e5e5511f0a164a581909&quot;),    &quot;_class&quot; : &quot;org.baeldung.model.User&quot;,    &quot;name&quot; : &quot;Alice&quot;,    &quot;age&quot; : 35&#125;
]
</code></pre>
<h1 id="4-JSON查询方法"><a href="#4-JSON查询方法" class="headerlink" title="4. JSON查询方法"></a>4. JSON查询方法</h1><p>如果我们无法用方法名称或条件来表示查询，那么我们可以做更低层次的事情 - 使用@Query注解。</p>
<p>通过这个注解，我们可以指定一个原始查询 - 作为一个Mongo JSON查询字符串。</p>
<h2 id="4-1-FindBy"><a href="#4-1-FindBy" class="headerlink" title="4.1 FindBy"></a>4.1 FindBy</h2><p>让我们先从简单的，看看我们是如何将是一个通过查找类型的方法第一：</p>
<pre><code>@Query(&quot;&#123; &#39;name&#39; : ?0 &#125;&quot;)
List&lt;User&gt; findUsersByName(String name);
</code></pre>
<p>这个方法应该按名称返回用户 - 占位符?0引用方法的第一个参数。</p>
<h2 id="4-2-regex"><a href="#4-2-regex" class="headerlink" title="4.2 $regex"></a>4.2 $regex</h2><p>让我们来看一个正则表达式驱动的查询 - 这当然会产生与2.2和3.2相同的结果：</p>
<pre><code>@Query(&quot;&#123; &#39;name&#39; : &#123; $regex: ?0 &#125; &#125;&quot;)
List&lt;User&gt; findUsersByRegexpName(String regexp);
</code></pre>
<p>用法也完全一样：</p>
<pre><code>List&lt;User&gt; users = userRepository.findUsersByRegexpName(&quot;^A&quot;);
List&lt;User&gt; users = userRepository.findUsersByRegexpName(&quot;c$&quot;);
</code></pre>
<h2 id="4-3-lt和-gt"><a href="#4-3-lt和-gt" class="headerlink" title="4.3. $ lt和$ gt"></a>4.3. $ lt和$ gt</h2><p>现在我们来实现lt和gt查询：</p>
<pre><code>@Query(&quot;&#123; &#39;age&#39; : &#123; $gt: ?0, $lt: ?1 &#125; &#125;&quot;)
List&lt;User&gt; findUsersByAgeBetween(int ageGT, int ageLT);
</code></pre>
<h1 id="5-结论"><a href="#5-结论" class="headerlink" title="5. 结论"></a>5. 结论</h1><p>在本文中，我们探讨了使用Spring Data MongoDB进行查询的常用方法。</p>
<p>本文示例可以从 <a target="_blank" rel="noopener" href="https://github.com/eugenp/tutorials/tree/master/spring-data-mongodb">spring-data-mongodb</a>这里下载。</p>
<p>本文参考<a target="_blank" rel="noopener" href="http://www.baeldung.com/queries-in-spring-data-mongodb">A Guide to Queries in Spring Data MongoDB</a></p>
<hr>
<blockquote>
<p>作者：Jadepeng<br> 出处：jqpeng的技术记事本–<a target="_blank" rel="noopener" href="http://www.cnblogs.com/xiaoqi">http://www.cnblogs.com/xiaoqi</a><br> 您的支持是对博主最大的鼓励，感谢您的认真阅读。<br> 本文版权归作者所有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文连接，否则保留追究法律责任的权利。</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/blog/page/7/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/blog/">1</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/blog/page/9/">9</a><a class="page-number" href="/blog/page/10/">10</a><a class="extend next" rel="next" href="/blog/page/9/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="JadePeng"
      src="/blog/images/avatar.gif">
  <p class="site-author-name" itemprop="name">JadePeng</p>
  <div class="site-description" itemprop="description">JadePeng的技术笔记本</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/blog/archives/">
        
          <span class="site-state-item-count">100</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/blog/categories/">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/blog/tags/">
          
        <span class="site-state-item-count">87</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">JadePeng</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">644k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">9:46</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/blog/lib/anime.min.js"></script>
  <script src="/blog/lib/velocity/velocity.min.js"></script>
  <script src="/blog/lib/velocity/velocity.ui.min.js"></script>

<script src="/blog/js/utils.js"></script>

<script src="/blog/js/motion.js"></script>


<script src="/blog/js/schemes/muse.js"></script>


<script src="/blog/js/next-boot.js"></script>




  




  
<script src="/blog/js/local-search.js"></script>









<script>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  let url = element.dataset.target;
  let pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  let pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  let fullURL = `/blog/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script>


<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  

</body>
</html>
