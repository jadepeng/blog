<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/jadepeng/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/jadepeng/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/jadepeng/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/jadepeng/images/logo.svg" color="#222">

<link rel="stylesheet" href="/jadepeng/css/main.css">


<link rel="stylesheet" href="/jadepeng/lib/font-awesome/css/all.min.css">
<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.iflyresearch.com","root":"/jadepeng/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="JadePeng的技术笔记本">
<meta property="og:type" content="website">
<meta property="og:title" content="JadePeng的技术笔记本">
<meta property="og:url" content="http://blog.iflyresearch.com/page/5/index.html">
<meta property="og:site_name" content="JadePeng的技术笔记本">
<meta property="og:description" content="JadePeng的技术笔记本">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="JadePeng">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://blog.iflyresearch.com/page/5/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>JadePeng的技术笔记本</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/jadepeng/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">JadePeng的技术笔记本</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">爱学习爱分享</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/jadepeng/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-博客">

    <a href="/jadepeng/categories/%E5%8D%9A%E5%AE%A2/" rel="section"><i class="fa fa-th fa-fw"></i>博客</a>

  </li>
        <li class="menu-item menu-item-分类">

    <a href="/jadepeng/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/jadepeng/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/jadepeng/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.iflyresearch.com/2019/09/12/jqpeng-%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E6%8E%A8%E7%90%86%E4%B8%8E%E5%AE%9E%E8%B7%B5(3)%20--%20jena%E8%87%AA%E5%AE%9A%E4%B9%89builtin/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/jadepeng/images/avatar.gif">
      <meta itemprop="name" content="JadePeng">
      <meta itemprop="description" content="JadePeng的技术笔记本">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JadePeng的技术笔记本">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/jadepeng/2019/09/12/jqpeng-%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E6%8E%A8%E7%90%86%E4%B8%8E%E5%AE%9E%E8%B7%B5(3)%20--%20jena%E8%87%AA%E5%AE%9A%E4%B9%89builtin/" class="post-title-link" itemprop="url">知识图谱推理与实践(3) -- jena自定义builtin</a>
        </h2>

        <div class="post-meta">

         
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-09-12 09:29:00" itemprop="dateCreated datePublished" datetime="2019-09-12T09:29:00+08:00">2019-09-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 18:09:47" itemprop="dateModified" datetime="2021-05-14T18:09:47+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/jadepeng/categories/%E5%8D%9A%E5%AE%A2/" itemprop="url" rel="index"><span itemprop="name">博客</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/jadepeng/categories/%E5%8D%9A%E5%AE%A2/jqpeng/" itemprop="url" rel="index"><span itemprop="name">jqpeng</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>12k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>11 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>文章作者:jqpeng<br>原文链接: <a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaoqi/p/kg-inference-3.html">知识图谱推理与实践(3) – jena自定义builtin</a></p>
<p>在<a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaoqi/p/kg-inference-2.html">第2篇</a>里，介绍了<code>jena</code>的<code>The general purpose rule engine</code>（通用规则引擎）及其使用，本篇继续探究，如何自定义builtin。</p>
<h2 id="builtin介绍"><a href="#builtin介绍" class="headerlink" title="builtin介绍"></a>builtin介绍</h2><p>先回顾builtin为何物，官方叫<code>Builtin primitives</code>,可以理解为内置函数、内置指令，可以返回true或者false用来检验rule是否匹配，官方包含如下的<code>primitives</code></p>
<table>
<thead>
<tr>
<th>Builtin</th>
<th>Operations</th>
</tr>
</thead>
<tbody><tr>
<td>isLiteral(?x) notLiteral(?x)             <br>isFunctor(?x) notFunctor(?x)             <br>isBNode(?x) notBNode(?x)</td>
<td>Test whether the single argument is or is not a literal, a functor-valued</td>
</tr>
</tbody></table>
<pre><code>      literal or a blank-node, respectively. |
</code></pre>
<p>| bound(?x…) unbound(?x..) | Test if all of the arguments are bound (not bound) variables |<br>| equal(?x,?y) notEqual(?x,?y) | Test if x=y (or x != y). The equality test is semantic equality so that,<br>          for example, the xsd:int 1 and the xsd:decimal 1 would test equal. |<br>| lessThan(?x, ?y), greaterThan(?x, ?y)             <br>le(?x, ?y), ge(?x, ?y) | Test if x is &lt;, &gt;, &lt;= or &gt;= y. Only passes if both x and y<br>          are numbers or time instants (can be integer or floating point or XSDDateTime). |<br>| sum(?a, ?b, ?c)             <br>addOne(?a, ?c)             <br>difference(?a, ?b, ?c)             <br>min(?a, ?b, ?c)             <br>max(?a, ?b, ?c)             <br>product(?a, ?b, ?c)             <br>quotient(?a, ?b, ?c) | Sets c to be (a+b), (a+1) (a-b), min(a,b), max(a,b), (a<br>          <em>b), (a/b). Note that these do not run backwards, if in<br>             <code>sum</code> a and c are bound and b is unbound then the test will<br>            fail rather than bind b to (c-a). This could be fixed.</em><br> |<br>| strConcat(?a1, .. ?an, ?t)             <br>uriConcat(?a1, .. ?an, ?t) | Concatenates the lexical form of all the arguments except the last, then<br>          binds the last argument to a plain literal (strConcat) or a URI node<br>          (uriConcat) with that lexical form. In both cases if an argument node<br>          is a URI node the URI will be used as the lexical form. |<br>| regex(?t, ?p)             <br>regex(?t, ?p, ?m1, .. ?mn) | Matches the lexical form of a literal (?t) against a regular expression<br>          pattern given by another literal (?p). If the match succeeds, and if<br>          there are any additional arguments then it will bind the first n capture<br>          groups to the arguments ?m1 to ?mn. The regular expression pattern syntax<br>          is that provided by java.util.regex. Note that the capture groups are<br>          numbered from 1 and the first capture group will be bound to ?m1, we<br>          ignore the implicit capture group 0 which corresponds to the entire matched<br>          string. So for example<br>          <br><br>    regexp(‘foo bar’, ‘(.) (.<br>                )’, ?m1, ?m2)<br>              <br><br><em>will bind<br>             <code>m1</code> to<br>             <code>&quot;foo&quot;</code> and<br>             <code>m2</code> to<br>             <code>&quot;bar&quot;</code>.</em><br> |<br>| now(?x) | Binds ?x to an xsd:dateTime value corresponding to the current time. |<br>| makeTemp(?x) | Binds ?x to a newly created blank node. |<br>| makeInstance(?x, ?p, ?v)<br>          <br>makeInstance(?x, ?p, ?t, ?v) | Binds ?v to be a blank node which is asserted as the value of the ?p property<br>          on resource ?x and optionally has type ?t. Multiple calls with the same<br>          arguments will return the same blank node each time - thus allowing this<br>          call to be used in backward rules. |<br>| makeSkolem(?x, ?v1, … ?vn) | Binds ?x to be a blank node. The blank node is generated based on the values<br>          of the remain ?vi arguments, so the same combination of arguments will<br>          generate the same bNode. |<br>| noValue(?x, ?p)<br>          <br>noValue(?x ?p ?v) | True if there is no known triple (x, p, ) or (x, p, v) in the model or<br>          the explicit forward deductions so far. |<br>| remove(n, …)<br>          <br>drop(n, …) | Remove the statement (triple) which caused the n’th body term of this (forward-only)<br>          rule to match. Remove will propagate the change to other consequent rules<br>          including the firing rule (which must thus be guarded by some other clauses).<br>          In particular, if the removed statement (triple) appears in the body<br>          of a rule that has already fired, the consequences of such rule are retracted<br>          from the deducted model. Drop will silently remove the triple(s) from<br>          the graph but not fire any rules as a consequence. These are clearly<br>          non-monotonic operations and, in particular, the behaviour of a rule<br>          set in which different rules both drop and create the same triple(s)<br>          is undefined. |<br>| isDType(?l, ?t) notDType(?l, ?t) | Tests if literal ?l is (or is not) an instance of the datatype defined<br>          by resource ?t. |<br>| print(?x, …) | Print (to standard out) a representation of each argument. This is useful<br>          for debugging rather than serious IO work. |<br>| listContains(?l, ?x)<br>           <br>listNotContains(?l, ?x) | Passes if ?l is a list which contains (does not contain) the element ?x,<br>          both arguments must be ground, can not be used as a generator. |<br>| listEntry(?list, ?index, ?val) | Binds ?val to the ?index’th entry in the RDF list ?list. If there is no<br>          such entry the variable will be unbound and the call will fail. Only<br>          usable in rule bodies. |<br>| listLength(?l, ?len) | Binds ?len to the length of the list ?l. |<br>| listEqual(?la, ?lb)<br>           <br>listNotEqual(?la, ?lb) | listEqual tests if the two arguments are both lists and contain the same<br>          elements. The equality test is semantic equality on literals (sameValueAs)<br>          but will not take into account owl:sameAs aliases. listNotEqual is the<br>          negation of this (passes if listEqual fails). |<br>| listMapAsObject(?s, ?p ?l)<br>           <br>listMapAsSubject(?l, ?p, ?o) | These can only be used as actions in the head of a rule. They deduce a<br>          set of triples derived from the list argument ?l : listMapAsObject asserts<br>          triples (?s ?p ?x) for each ?x in the list ?l, listMapAsSubject asserts<br>          triples (?x ?p ?o). |<br>| table(?p) tableAll() | Declare that all goals involving property ?p (or all goals) should be tabled<br>          by the backward engine. |<br>| hide(p) | Declares that statements involving the predicate p should be hidden. Queries<br>          to the model will not report such statements. This is useful to enable<br>          non-monotonic forward rules to define flag predicates which are only<br>          used for inference control and do not “pollute” the inference results. |</p>
<h2 id="builtin-自定义"><a href="#builtin-自定义" class="headerlink" title="builtin 自定义"></a>builtin 自定义</h2><p>自定义很简单，实现<code>Builtin</code>接口, 然后使用<code>BuiltinRegistry.theRegistry.register</code>注册即可。</p>
<p>Builtin接口定义如下：</p>
<pre><code>public interface Builtin &#123;

    /**
     * Return a convenient name for this builtin, normally this will be the name of the 
     * functor that will be used to invoke it and will often be the final component of the
     * URI.
     */
    public String getName();
    
    /**
     * Return the full URI which identifies this built in.
     */
    public String getURI();
    
    /**
     * Return the expected number of arguments for this functor or 0 if the number is flexible.
     */
    public int getArgLength();
    
    /**
     * This method is invoked when the builtin is called in a rule body.
     * @param args the array of argument values for the builtin, this is an array 
     * of Nodes, some of which may be Node_RuleVariables.
     * @param length the length of the argument list, may be less than the length of the args array
     * for some rule engines
     * @param context an execution context giving access to other relevant data
     * @return return true if the buildin predicate is deemed to have succeeded in
     * the current environment
     */
    public boolean bodyCall(Node[] args, int length, RuleContext context);
    
    /**
     * This method is invoked when the builtin is called in a rule head.
     * Such a use is only valid in a forward rule.
     * @param args the array of argument values for the builtin, this is an array 
     * of Nodes.
     * @param length the length of the argument list, may be less than the length of the args array
     * for some rule engines
     * @param context an execution context giving access to other relevant data
     */
    public void headAction(Node[] args, int length, RuleContext context);
    
    /**
     * Returns false if this builtin has side effects when run in a body clause,
     * other than the binding of environment variables.
     */
    public boolean isSafe();
    
    /**
     * Returns false if this builtin is non-monotonic. This includes non-monotonic checks like noValue
     * and non-monotonic actions like remove/drop. A non-monotonic call in a head is assumed to 
     * be an action and makes the overall rule and ruleset non-monotonic. 
     * Most JenaRules are monotonic deductive closure rules in which this should be false.
     */
    public boolean isMonotonic();
&#125;
</code></pre>
<p>一般我们不用直接实现该接口，可以继承默认的实现<code>BaseBuiltin</code>, 一般只需要Override 下<code>getName</code>提供指令名称，实现<code>bodyCall</code>,提供函数调用即可。</p>
<pre><code>    @Override
    public String getName() &#123;
        return &quot;semsim&quot;;
    &#125;
</code></pre>
<p>比如，我们来自定义一个指令，用来计算两两语义相似度：</p>
<pre><code>public class SemanticSimilarityBuiltin extends BaseBuiltin &#123;
    /**
     * Return a convenient name for this builtin, normally this will be the name of the
     * functor that will be used to invoke it and will often be the final component of the
     * URI.
     */
    @Override
    public String getName() &#123;
        return &quot;semsim&quot;;
    &#125;

    @Override
    public int getArgLength() &#123;
        return 3;
    &#125;


    /**
     * This method is invoked when the builtin is called in a rule body.
     *
     * @param args    the array of argument values for the builtin, this is an array
     *                of Nodes, some of which may be Node_RuleVariables.
     * @param context an execution context giving access to other relevant data
     * @return return true if the buildin predicate is deemed to have succeeded in
     * the current environment
     */
    @Override
    public boolean bodyCall(Node[] args, int length, RuleContext context) &#123;
        checkArgs(length, context);
        Node n1 = getArg(0, args, context);
        Node n2 = getArg(1, args, context);
        Node score = getArg(2,args,context);

        if(!score.isLiteral()  || score.getLiteral().getValue()==null)&#123;
         return false;
        &#125;
        String value;
        Double hold = Double.parseDouble(score.getLiteralValue().toString());

        //  n.isLiteral() &amp;&amp; n.getLiteralValue() instanceof Number

        if (n1.isLiteral() &amp;&amp; n2.isLiteral()) &#123;
            String v1 = n1.getLiteralValue().toString();
            String v2 = n2.getLiteralValue().toString();

            // 调用服务计算相似度
            String requestUrl = &quot;http://API-URL:5101/similarity/cosine?s1=&quot;+v1+&quot;&amp;s2=&quot;+v2;
            String result = HttpClientUtil.doGet(requestUrl);
            JSONObject json = JSON.parseObject(result);
            if(json.getDouble(&quot;similarity&quot;) &gt;= hold)&#123;
                return true;
            &#125;

            return true;
        &#125;
        return false;
    &#125;
&#125;
</code></pre>
<ul>
<li>这里有个getArgLength和checkArgs(length, context)，可以用来限制参数长度，检验必须符合该长度。</li>
<li>可以通过getArg(idx, args, context)来获取待计算的参数</li>
<li>上面的计算相似度，主要是调用外度的服务来计算两两的语义向量的cosine得分，如果满足阈值，我们就认为规则匹配</li>
</ul>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>我们来测试上面的定义的计算语义相似度的指令<code>semsim</code>，还是用第2篇里的例子：</p>
<p>我们新增加两个属性<code>主要业务</code>和<code>竞争对手</code>，我们定义，如果两个公司的主要业务语义上相似，我们就认为两家公司是竞争对手。</p>
<pre><code>        Property 主要业务 = myMod.createProperty(finance + &quot;主要业务&quot;);
        Property 竞争对手 = myMod.createProperty(finance + &quot;竞争对手&quot;);

        // 加入三元组
      
        myMod.add(万达集团, 主要业务, &quot;房地产，文娱&quot;);
        myMod.add(融创中国, 主要业务, &quot;房地产&quot;);
      
</code></pre>
<p>然后定义规则：</p>
<pre><code>[ruleCompetitor: (?c1 :主要业务 ?b1) (?c2 :主要业务 ?b2) notEqual(?c1,?c2) semsim(?b1,?b2,0.6)  -&gt; (?c1 :竞争对手 ?c2)] 
</code></pre>
<p>规则意思是，公司C1 主要业务是 b1,c2 主要业务是b2,并且c1和c2不是同一家公司，如果b1，b2的相似度大于0.6，那么C1和c2是竞争对手。</p>
<p>完整测试代码：</p>
<pre><code>       // 注册自定义builtin
        BuiltinRegistry.theRegistry.register(new SemanticSimilarityBuiltin());

        Model myMod = ModelFactory.createDefaultModel();
        String finance = &quot;http://www.example.org/kse/finance#&quot;;
        Resource 孙宏斌 = myMod.createResource(finance + &quot;孙宏斌&quot;);
        Resource 融创中国 = myMod.createResource(finance + &quot;融创中国&quot;);
        Resource 乐视网 = myMod.createResource(finance + &quot;乐视网&quot;);
        Property 执掌 = myMod.createProperty(finance + &quot;执掌&quot;);
        Resource 贾跃亭 = myMod.createResource(finance + &quot;贾跃亭&quot;);
        Resource 地产公司 = myMod.createResource(finance + &quot;地产公司&quot;);
        Resource 公司 = myMod.createResource(finance + &quot;公司&quot;);
        Resource 法人实体 = myMod.createResource(finance + &quot;法人实体&quot;);
        Resource 人 = myMod.createResource(finance + &quot;人&quot;);
        Property 主要收入 = myMod.createProperty(finance + &quot;主要收入&quot;);
        Resource 地产事业 = myMod.createResource(finance + &quot;地产事业&quot;);
        Resource 王健林 = myMod.createResource(finance + &quot;王健林&quot;);
        Resource 万达集团 = myMod.createResource(finance + &quot;万达集团&quot;);
        Property 主要资产 = myMod.createProperty(finance + &quot;主要资产&quot;);


        Property 股东 = myMod.createProperty(finance + &quot;股东&quot;);
        Property 关联交易 = myMod.createProperty(finance + &quot;关联交易&quot;);
        Property 收购 = myMod.createProperty(finance + &quot;收购&quot;);

        Property 主要业务 = myMod.createProperty(finance + &quot;主要业务&quot;);
        Property 竞争对手 = myMod.createProperty(finance + &quot;竞争对手&quot;);

        // 加入三元组
        myMod.add(孙宏斌, 执掌, 融创中国);
        myMod.add(贾跃亭, 执掌, 乐视网);
        myMod.add(王健林, 执掌, 万达集团);
        myMod.add(乐视网, RDF.type, 公司);
        myMod.add(万达集团, RDF.type, 公司);
        myMod.add(融创中国, RDF.type, 地产公司);
        myMod.add(地产公司, RDFS.subClassOf, 公司);
        myMod.add(公司, RDFS.subClassOf, 法人实体);
        myMod.add(孙宏斌, RDF.type, 人);
        myMod.add(贾跃亭, RDF.type, 人);
        myMod.add(王健林, RDF.type, 人);
        myMod.add(万达集团, 主要资产, 地产事业);
        myMod.add(万达集团, 主要业务, &quot;房地产，文娱&quot;);
        myMod.add(融创中国, 主要收入, 地产事业);
        myMod.add(融创中国, 主要业务, &quot;房地产&quot;);
        myMod.add(孙宏斌, 股东, 乐视网);
        myMod.add(孙宏斌, 收购, 万达集团);

        PrintUtil.registerPrefix(&quot;&quot;, finance);

        // 输出当前模型
        StmtIterator i = myMod.listStatements(null, null, (RDFNode) null);
        while (i.hasNext()) &#123;
            System.out.println(&quot; - &quot; + PrintUtil.print(i.nextStatement()));
        &#125;


        GenericRuleReasoner reasoner = (GenericRuleReasoner) GenericRuleReasonerFactory.theInstance().create(null);
        reasoner.setRules(Rule.parseRules(
            &quot;[ruleHoldShare: (?p :执掌 ?c) -&gt; (?p :股东 ?c)] \n&quot;
                + &quot;[ruleConnTrans: (?p :收购 ?c) -&gt; (?p :股东 ?c)] \n&quot;
                + &quot;[ruleConnTrans: (?p :股东 ?c) (?p :股东 ?c2) -&gt; (?c :关联交易 ?c2)] \n&quot;
                + &quot;[ruleCompetitor:: (?c1 :主要业务 ?b1) (?c2 :主要业务 ?b2) notEqual(?c1,?c2) semsim(?b1,?b2,0.6)  -&gt; (?c1 :竞争对手 ?c2)] \n&quot;
                + &quot;-&gt; tableAll().&quot;));
        reasoner.setMode(GenericRuleReasoner.HYBRID);

        InfGraph infgraph = reasoner.bind(myMod.getGraph());
        infgraph.setDerivationLogging(true);

        System.out.println(&quot;推理后...\n&quot;);

        Iterator&lt;Triple&gt; tripleIterator = infgraph.find(null, null, null);
        while (tripleIterator.hasNext()) &#123;
            System.out.println(&quot; - &quot; + PrintUtil.print(tripleIterator.next()));
        &#125;
</code></pre>
<p>运行结果：</p>
<pre><code> - (:万达集团 :关联交易 :乐视网)
 - (:万达集团 :关联交易 :融创中国)
 - (:万达集团 :竞争对手 :融创中国)
 - (:万达集团 :关联交易 :万达集团)
 - (:孙宏斌 :股东 :万达集团)
 - (:孙宏斌 :股东 :融创中国)
 - (:融创中国 :关联交易 :万达集团)
 - (:融创中国 :竞争对手 :万达集团)
 - (:融创中国 :关联交易 :乐视网)
 - (:融创中国 :关联交易 :融创中国)
 - (:乐视网 :关联交易 :万达集团)
 - (:乐视网 :关联交易 :融创中国)
 - (:乐视网 :关联交易 :乐视网)
 - (:贾跃亭 :股东 :乐视网)
 - (:王健林 :股东 :万达集团)
 - (:公司 rdfs:subClassOf :法人实体)
 - (:万达集团 :主要业务 &#39;房地产，文娱&#39;)
 - (:万达集团 :主要资产 :地产事业)
 - (:万达集团 rdf:type :公司)
 - (:地产公司 rdfs:subClassOf :公司)
 - (:融创中国 :主要业务 &#39;房地产&#39;)
 - (:融创中国 :主要收入 :地产事业)
 - (:融创中国 rdf:type :地产公司)
 - (:孙宏斌 :收购 :万达集团)
 - (:孙宏斌 :股东 :乐视网)
 - (:孙宏斌 rdf:type :人)
 - (:孙宏斌 :执掌 :融创中国)
 - (:乐视网 rdf:type :公司)
 - (:贾跃亭 rdf:type :人)
 - (:贾跃亭 :执掌 :乐视网)
 - (:王健林 rdf:type :人)
 - (:王健林 :执掌 :万达集团)
</code></pre>
<p>可以根据需要，扩展更多的builtin，比如运行js，比如http请求。。。</p>
<hr>
<blockquote>
<p>作者：Jadepeng<br> 出处：jqpeng的技术记事本–<a target="_blank" rel="noopener" href="http://www.cnblogs.com/xiaoqi">http://www.cnblogs.com/xiaoqi</a><br> 您的支持是对博主最大的鼓励，感谢您的认真阅读。<br> 本文版权归作者所有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文连接，否则保留追究法律责任的权利。</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.iflyresearch.com/2019/09/10/jqpeng-conda%20docker%E9%95%9C%E5%83%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/jadepeng/images/avatar.gif">
      <meta itemprop="name" content="JadePeng">
      <meta itemprop="description" content="JadePeng的技术笔记本">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JadePeng的技术笔记本">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/jadepeng/2019/09/10/jqpeng-conda%20docker%E9%95%9C%E5%83%8F/" class="post-title-link" itemprop="url">conda docker镜像</a>
        </h2>

        <div class="post-meta">

         
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-09-10 16:36:00" itemprop="dateCreated datePublished" datetime="2019-09-10T16:36:00+08:00">2019-09-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 18:09:47" itemprop="dateModified" datetime="2021-05-14T18:09:47+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/jadepeng/categories/%E5%8D%9A%E5%AE%A2/" itemprop="url" rel="index"><span itemprop="name">博客</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/jadepeng/categories/%E5%8D%9A%E5%AE%A2/jqpeng/" itemprop="url" rel="index"><span itemprop="name">jqpeng</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.7k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>文章作者:jqpeng<br>原文链接: <a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaoqi/p/conda-docker.html">conda docker镜像</a></p>
<p>之前的python环境，使用ubuntu安装pip来安装python依赖，但是遇到缺少某些库的版本，比如一个项目需要用到faiss，pip只有最新的1.5.3版本，但是这个版本使用了较新的CPU指令，在老服务器上运行报错：</p>
<p>Illegal instruction (core dumped) - in new version of FAISS #885</p>
<p>github上提示安装旧版本：</p>
<blockquote>
<p>If anyone else is struggling and wanna go back to previous working version, use: conda install faiss-cpu=1.5.1 -c pytorch -y</p>
</blockquote>
<p>遗憾的是，下面的命令不成功，没有1.5.1版本：</p>
<pre><code>pip install faiss-cpu==1.5.1
</code></pre>
<p>转而投向conda。</p>
<p>首先，下载最新的conda安装命令：</p>
<pre><code>wget https://repo.anaconda.com/archive/Anaconda3-2019.07-Linux-x86_64.sh
</code></pre>
<p>然后构建conda的基础镜像，还是以ubuntu:16.04为底包，Dockerfile如下：</p>
<pre><code>from ubuntu:16.04
RUN apt-get update &amp;&amp; apt-get install -y --no-install-recommends \
      bzip2 \
      g++ \
      git \
      graphviz \
      libgl1-mesa-glx \
      libhdf5-dev \
      openmpi-bin \
      wget &amp;&amp; \
    rm -rf /var/lib/apt/lists/*

RUN sed -i &#39;s/archive.ubuntu.com/mirrors.ustc.edu.cn/g&#39; /etc/apt/sources.list
RUN apt-get update

ADD ./Anaconda3-2019.07-Linux-x86_64.sh ./anaconda.sh

ENV LANG=C.UTF-8 LC_ALL=C.UTF-8
ENV PATH /opt/conda/bin:$PATH
RUN  /bin/bash ./anaconda.sh -b -p /opt/conda  &amp;&amp; rm ./anaconda.sh &amp;&amp; ln -s /opt/conda/etc/profile.d/conda.sh /etc/profile.d/conda.sh  &amp;&amp; echo &quot;. /opt/conda/etc/profile.d/conda.sh&quot; &gt;&gt; ~/.bashrc &amp;&amp; echo &quot;conda activate base&quot; &gt;&gt; ~/.bashrc &amp;&amp; find /opt/conda/ -follow -type f -name &#39;*.a&#39; -delete &amp;&amp; find /opt/conda/ -follow -type f -name &#39;*.js.map&#39; -delete &amp;&amp;  /opt/conda/bin/conda clean -afy


CMD [ &quot;/bin/bash&quot; ]
</code></pre>
<p>构建：</p>
<pre><code>docker build -t conda3:1.0 .
</code></pre>
<p>后面，就可以以<code>conda3:1.0 .</code>为基础镜像构建需要的镜像，比如我们需要安装faiss-cpu 1.5.1版本</p>
<pre><code>from conda3:1.0

RUN conda install pytorch -y
RUN conda install faiss-cpu=1.5.1 -c pytorch -y


CMD [ &quot;/bin/bash&quot; ]
</code></pre>
<p>构建：</p>
<pre><code>docker build -t conda-faiss:1.0 .
</code></pre>
<hr>
<blockquote>
<p>作者：Jadepeng<br> 出处：jqpeng的技术记事本–<a target="_blank" rel="noopener" href="http://www.cnblogs.com/xiaoqi">http://www.cnblogs.com/xiaoqi</a><br> 您的支持是对博主最大的鼓励，感谢您的认真阅读。<br> 本文版权归作者所有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文连接，否则保留追究法律责任的权利。</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.iflyresearch.com/2019/09/06/jqpeng-%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E6%8E%A8%E7%90%86%E4%B8%8E%E5%AE%9E%E8%B7%B5%20(2)%20%20--%20%E5%9F%BA%E4%BA%8Ejena%E5%AE%9E%E7%8E%B0%E8%A7%84%E5%88%99%E6%8E%A8%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/jadepeng/images/avatar.gif">
      <meta itemprop="name" content="JadePeng">
      <meta itemprop="description" content="JadePeng的技术笔记本">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JadePeng的技术笔记本">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/jadepeng/2019/09/06/jqpeng-%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E6%8E%A8%E7%90%86%E4%B8%8E%E5%AE%9E%E8%B7%B5%20(2)%20%20--%20%E5%9F%BA%E4%BA%8Ejena%E5%AE%9E%E7%8E%B0%E8%A7%84%E5%88%99%E6%8E%A8%E7%90%86/" class="post-title-link" itemprop="url">知识图谱推理与实践 (2)  -- 基于jena实现规则推理</a>
        </h2>

        <div class="post-meta">

         
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-09-06 17:18:00" itemprop="dateCreated datePublished" datetime="2019-09-06T17:18:00+08:00">2019-09-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 18:09:47" itemprop="dateModified" datetime="2021-05-14T18:09:47+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/jadepeng/categories/%E5%8D%9A%E5%AE%A2/" itemprop="url" rel="index"><span itemprop="name">博客</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/jadepeng/categories/%E5%8D%9A%E5%AE%A2/jqpeng/" itemprop="url" rel="index"><span itemprop="name">jqpeng</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>7.7k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>7 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>文章作者:jqpeng<br>原文链接: <a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaoqi/p/kg-inference-2.html">知识图谱推理与实践 (2)  – 基于jena实现规则推理</a></p>
<p>本章，介绍 基于<code>jena</code>的规则引擎实现推理，并通过两个例子介绍如何coding实现。</p>
<h2 id="规则引擎概述"><a href="#规则引擎概述" class="headerlink" title="规则引擎概述"></a>规则引擎概述</h2><p>jena包含了一个通用的规则推理机，可以在RDFS和OWL推理机使用，也可以单独使用。</p>
<p>推理机支持在RDF图上推理，提供前向链、后向链和二者混合执行模式。包含RETE engine 和 one tabled datalog engine。可以通过<a target="_blank" rel="noopener" href="https://jena.apache.org/documentation/javadoc/jena/org/apache/jena/reasoner/rulesys/GenericRuleReasoner.html">GenericRuleReasoner</a>来进行配置参数，使用各种推理引擎。要使用 <code>GenericRuleReasoner</code>，需要一个规则集来定义其行为.</p>
<h3 id="Rule的语法与结构"><a href="#Rule的语法与结构" class="headerlink" title="Rule的语法与结构"></a>Rule的语法与结构</h3><p>规则通过 <a target="_blank" rel="noopener" href="https://jena.apache.org/documentation/javadoc/jena/org/apache/jena/reasoner/rulesys/Rule.html">Rule</a>对象来进行定义，包含 body terms列表 (premises),head terms列表 (conclusions) 和可选的 name 和可选的direction。</p>
<p>An informal description of the simplified text rule syntax is:</p>
<pre><code>_Rule_      :=   _bare-rule_ .
          or   [ _bare-rule_ ]
       or   [ ruleName : _bare-rule_ ]

_bare-rule_ :=   _term_, ... _term_ -&gt; _hterm_, ... _hterm_    // forward rule
          or   _bhterm_ &lt;- _term_, ... _term   _ // backward rule

_hterm     :=   term
_ or   [ _bare-rule_ ]

_term_      :=   (_node_, _node_, _node_)           // triple pattern
          or   (_node_, _node_, _functor_)        // extended triple pattern
          or   builtin(_node_, ... _node_)      // invoke procedural primitive

_bhterm_      :=   (_node_, _node_, _node_)           // triple pattern

_functor_   :=   functorName(_node_, ... _node_)  // structured literal

_node_      :=   _uri-ref_                   // e.g. http://foo.com/eg
          or   prefix:localname          // e.g. rdf:type
          or   &lt;_uri-ref_&gt;          // e.g. &lt;myscheme:myuri&gt;
          or   ?_varname_ // variable
          or   &#39;a literal&#39;                 // a plain string literal
          or   &#39;lex&#39;^^typeURI              // a typed literal, xsd:* type names supported
          or   number                      // e.g. 42 or 25.5
</code></pre>
<p>逗号 “,” 分隔符是可选的.</p>
<p>前向和后向规则语法之间的区别仅与混合执行策略相关，请参见下文。</p>
<p><code>_functor_</code> 是一个扩展的三元组，用于创建和访问文本值。functorName可以是任何简单的标识符。</p>
<p>为保障rules的可读性URI引用支持qname语法。可以使用在 <a target="_blank" rel="noopener" href="https://jena.apache.org/documentation/javadoc/jena/org/apache/jena/util/PrintUtil.html">PrintUtil</a>对象中注册的前缀。</p>
<p>下面是一些规则示例：</p>
<pre><code>[allID: (?C rdf:type owl:Restriction), (?C owl:onProperty ?P),
     (?C owl:allValuesFrom ?D)  -&gt; (?C owl:equivalentClass all(?P, ?D)) ]

[all2: (?C rdfs:subClassOf all(?P, ?D)) -&gt; print(&#39;Rule for &#39;, ?C)
    [all1b: (?Y rdf:type ?D) &lt;- (?X ?P ?Y), (?X rdf:type ?C) ] ]

[max1: (?A rdf:type max(?P, 1)), (?A ?P ?B), (?A ?P ?C)
      -&gt; (?B owl:sameAs ?C) ]
</code></pre>
<ul>
<li>Rule <code>allID</code>说明了functor用于将OWL限制的组件收集到单个数据结构中，然后可以触发进一步的规则</li>
<li>Rule <code>all2</code> 表示一个前向规则，它创建了一个新的后向规则，并且还调用了print.</li>
<li>Rule <code>max1</code> 说明了如何使用数字</li>
</ul>
<p>可以使用以下方法加载和解析规则文件：</p>
<pre><code>List rules = Rule.rulesFromURL(&quot;file:myfile.rules&quot;);
</code></pre>
<p>或者</p>
<pre><code>BufferedReader br = / _open reader_ / ;
List rules = Rule.parseRules( Rule.rulesParserFromReader(br) );
</code></pre>
<p>或者</p>
<pre><code>String ruleSrc = / _list of rules in line_ /
List rules = Rule.parseRules( rulesSrc );
</code></pre>
<p>在前两种情况下（从URL或BufferedReader读取），规则文件由一个简单的处理器预处理，该处理器剥离注释并支持一些额外的宏命令：</p>
<dl><dt><code># ...</code></dt>
<dd>注释.</dd>
<dt><code>// ...</code></dt>
<dd>注释</dd>
<dt><code>@prefix pre: &lt;http://domain/url#&gt;.</code></dt>
<dd>定义了一个前缀<code>pre</code>&nbsp;，可以用在规则文件中.</dd>
<dt><code>@include &lt;urlToRuleFile&gt;.</code></dt>
<dd>包含指定规则,允许规则文件包含RDFS和OWL的预定义规则</dd></dl>
完整实例：


<pre><code> @prefix pre: &lt;http://jena.hpl.hp.com/prefix#&gt;. 
 @include &lt;RDFS&gt;. 
 [rule1: (?f pre:father ?a) (?u pre:brother ?f) -&gt; (?u pre:uncle ?a)]
 
</code></pre>
<h2 id="规则推理demo1–喜剧演员"><a href="#规则推理demo1–喜剧演员" class="headerlink" title="规则推理demo1–喜剧演员"></a>规则推理demo1–喜剧演员</h2><p>例如，在一个电影知识图谱里，如果一个演员参演的电影的类型是喜剧片，我们可以认为这个演员是喜剧电影</p>
<p>推理规则：</p>
<pre><code>[ruleComedian: (?p :hasActedIn ?m) (?m :hasGenre ?g) (?g :genreName &#39;喜剧&#39;) -&gt; (?p rdf:type :Comedian)] 
</code></pre>
<p>我们用代码来实现：</p>
<pre><code>         String prefix = &quot;http://www.test.com/kg/#&quot;;
        Graph data = Factory.createGraphMem();

        // 定义节点
        Node movie = NodeFactory.createURI(prefix + &quot;movie&quot;);
        Node hasActedIn = NodeFactory.createURI(prefix + &quot;hasActedIn&quot;);
        Node hasGenre = NodeFactory.createURI(prefix + &quot;hasGenre&quot;);
        Node genreName = NodeFactory.createURI(prefix + &quot;genreName&quot;);
        Node genre = NodeFactory.createURI(prefix + &quot;genre&quot;);
        Node person = NodeFactory.createURI(prefix + &quot;person&quot;);
        Node Comedian = NodeFactory.createURI(prefix + &quot;Comedian&quot;);

        // 添加三元组
        data.add(new Triple(genre, genreName, NodeFactory.createLiteral(&quot;喜剧&quot;)));
        data.add(new Triple(movie, hasGenre, genre));
        data.add(new Triple(person, hasActedIn, movie));        // 创建推理机
        GenericRuleReasoner reasoner = (GenericRuleReasoner) GenericRuleReasonerFactory.theInstance().create(null);
        PrintUtil.registerPrefix(&quot;&quot;, prefix);    // 设置规则
        reasoner.setRules(Rule.parseRules(
                &quot;[ruleComedian: (?p :hasActedIn ?m) (?m :hasGenre ?g) (?g :genreName &#39;喜剧&#39;) -&gt; (?p rdf:type :Comedian)] \n&quot;
                        + &quot;-&gt; tableAll().&quot;));
        reasoner.setMode(GenericRuleReasoner.HYBRID); // HYBRID混合推理

        InfGraph infgraph = reasoner.bind(data);
        infgraph.setDerivationLogging(true);        // 执行推理
        Iterator&lt;Triple&gt; tripleIterator = infgraph.find(person, null, null);

        while (tripleIterator.hasNext()) &#123;
            System.out.println(PrintUtil.print(tripleIterator.next()));
        &#125;
</code></pre>
<p>输出结果：</p>
<pre><code>(:person rdf:type :Comedian)
(:person :hasActedIn :movie)
</code></pre>
<p>可以看到，已经给person加上了Comedian。</p>
<h2 id="规则推理demo2-–-关联交易"><a href="#规则推理demo2-–-关联交易" class="headerlink" title="规则推理demo2 – 关联交易"></a>规则推理demo2 – 关联交易</h2><p>我们再来看上一篇文章中提到的那个金融图谱：</p>
<p><img src="https://gitee.com/jadepeng/pic/raw/master/pic/2019/9/6/1567758605345.png" alt="金融图谱"></p>
<p>陈华钧老师PPT里，有一个推理任务：</p>
<ol>
<li>执掌一家公司就一定是这家公司的股东；</li>
<li>某人同时是两家公司的股东，那么这两家公司一定有关联交易；</li>
</ol>
<p>PPT里是使用Drools来实现的，具体可以参见PPT。我们这里使用jena来实现，可以达到同样的效果。</p>
<p>首先，构造好图谱，为了方便理解，我们用中文变量：</p>
<pre><code>Model myMod = ModelFactory.createDefaultModel();
        String finance = &quot;http://www.example.org/kse/finance#&quot;;
        Resource 孙宏斌 = myMod.createResource(finance + &quot;孙宏斌&quot;);
        Resource 融创中国 = myMod.createResource(finance + &quot;融创中国&quot;);
        Resource 乐视网 = myMod.createResource(finance + &quot;乐视网&quot;);
        Property 执掌 = myMod.createProperty(finance + &quot;执掌&quot;);
        Resource 贾跃亭 = myMod.createResource(finance + &quot;贾跃亭&quot;);
        Resource 地产公司 = myMod.createResource(finance + &quot;地产公司&quot;);
        Resource 公司 = myMod.createResource(finance + &quot;公司&quot;);
        Resource 法人实体 = myMod.createResource(finance + &quot;法人实体&quot;);
        Resource 人 = myMod.createResource(finance + &quot;人&quot;);
        Property 主要收入 = myMod.createProperty(finance + &quot;主要收入&quot;);
        Resource 地产事业 = myMod.createResource(finance + &quot;地产事业&quot;);
        Resource 王健林 = myMod.createResource(finance + &quot;王健林&quot;);
        Resource 万达集团 = myMod.createResource(finance + &quot;万达集团&quot;);
        Property 主要资产 = myMod.createProperty(finance + &quot;主要资产&quot;);


        Property 股东 = myMod.createProperty(finance + &quot;股东&quot;);
        Property 关联交易 = myMod.createProperty(finance + &quot;关联交易&quot;);
        Property 收购 = myMod.createProperty(finance + &quot;收购&quot;);

        // 加入三元组
        myMod.add(孙宏斌, 执掌, 融创中国);
        myMod.add(贾跃亭, 执掌, 乐视网);
        myMod.add(王健林, 执掌, 万达集团);
        myMod.add(乐视网, RDF.type, 公司);
        myMod.add(万达集团, RDF.type, 公司);
        myMod.add(融创中国, RDF.type, 地产公司);
        myMod.add(地产公司, RDFS.subClassOf, 公司);
        myMod.add(公司, RDFS.subClassOf, 法人实体);
        myMod.add(孙宏斌, RDF.type, 人);
        myMod.add(贾跃亭, RDF.type, 人);
        myMod.add(王健林, RDF.type, 人);
        myMod.add(万达集团,主要资产,地产事业);
        myMod.add(融创中国,主要收入,地产事业);
        myMod.add(孙宏斌, 股东, 乐视网);
        myMod.add(孙宏斌, 收购, 万达集团);

        PrintUtil.registerPrefix(&quot;&quot;, finance);

        // 输出当前模型
        StmtIterator i = myMod.listStatements(null,null,(RDFNode)null);
        while (i.hasNext()) &#123;
            System.out.println(&quot; - &quot; + PrintUtil.print(i.nextStatement()));
        &#125;
</code></pre>
<p>上图所示的图谱，包含如下的三元组：</p>
<pre><code> - (:公司 rdfs:subClassOf :法人实体)
 - (:万达集团 :主要资产 :地产事业)
 - (:万达集团 rdf:type :公司)
 - (:地产公司 rdfs:subClassOf :公司)
 - (:融创中国 :主要收入 :地产事业)
 - (:融创中国 rdf:type :地产公司)
 - (:孙宏斌 :股东 :乐视网)
 - (:孙宏斌 rdf:type :人)
 - (:孙宏斌 :执掌 :融创中国)
 - (:乐视网 rdf:type :公司)
 - (:贾跃亭 rdf:type :人)
 - (:贾跃亭 :执掌 :乐视网)
 - (:王健林 rdf:type :人)
 - (:王健林 :执掌 :万达集团)
</code></pre>
<p>我们来定义推理规则：</p>
<ol>
<li>执掌一家公司就一定是这家公司的股东；</li>
<li>收购一家公司，就是这家公司的股东</li>
<li>某人同时是两家公司的股东，那么这两家公司一定有关联交易；</li>
</ol>
<p>用jena规则来表示：</p>
<pre><code>[ruleHoldShare: (?p :执掌 ?c) -&gt; (?p :股东 ?c)] 
[[ruleHoldShare2: (?p :收购 ?c) -&gt; (?p :股东 ?c)] 
[ruleConnTrans: (?p :股东 ?c) (?p :股东 ?c2) -&gt; (?c :关联交易 ?c2)] 
</code></pre>
<p>执行推理：</p>
<pre><code>         GenericRuleReasoner reasoner = (GenericRuleReasoner) GenericRuleReasonerFactory.theInstance().create(null);
        reasoner.setRules(Rule.parseRules(
                &quot;[ruleHoldShare: (?p :执掌 ?c) -&gt; (?p :股东 ?c)] \n&quot;
                        + &quot;[ruleConnTrans: (?p :收购 ?c) -&gt; (?p :股东 ?c)] \n&quot;
                        + &quot;[ruleConnTrans: (?p :股东 ?c) (?p :股东 ?c2) -&gt; (?c :关联交易 ?c2)] \n&quot;
                        + &quot;-&gt; tableAll().&quot;));
        reasoner.setMode(GenericRuleReasoner.HYBRID);

        InfGraph infgraph = reasoner.bind(myMod.getGraph());
        infgraph.setDerivationLogging(true);

        System.out.println(&quot;推理后...\n&quot;);

        Iterator&lt;Triple&gt; tripleIterator = infgraph.find(null, null, null);
        while (tripleIterator.hasNext()) &#123;
            System.out.println(&quot; - &quot; + PrintUtil.print(tripleIterator.next()));
        &#125;
</code></pre>
<p>输出结果：</p>
<pre><code>推理后...

 - (:万达集团 :关联交易 :乐视网)
 - (:万达集团 :关联交易 :融创中国)
 - (:万达集团 :关联交易 :万达集团)
 - (:孙宏斌 :股东 :万达集团)
 - (:孙宏斌 :股东 :融创中国)
 - (:融创中国 :关联交易 :万达集团)
 - (:融创中国 :关联交易 :乐视网)
 - (:融创中国 :关联交易 :融创中国)
 - (:乐视网 :关联交易 :万达集团)
 - (:乐视网 :关联交易 :融创中国)
 - (:乐视网 :关联交易 :乐视网)
 - (:贾跃亭 :股东 :乐视网)
 - (:王健林 :股东 :万达集团)
 - (:公司 rdfs:subClassOf :法人实体)
 - (:万达集团 :主要资产 :地产事业)
 - (:万达集团 rdf:type :公司)
 - (:地产公司 rdfs:subClassOf :公司)
 - (:融创中国 :主要收入 :地产事业)
 - (:融创中国 rdf:type :地产公司)
 - (:孙宏斌 :收购 :万达集团)
 - (:孙宏斌 :股东 :乐视网)
 - (:孙宏斌 rdf:type :人)
 - (:孙宏斌 :执掌 :融创中国)
 - (:乐视网 rdf:type :公司)
 - (:贾跃亭 rdf:type :人)
 - (:贾跃亭 :执掌 :乐视网)
 - (:王健林 rdf:type :人)
 - (:王健林 :执掌 :万达集团)
</code></pre>
<p>我们看到，推理后孙宏斌是三家公司的股东，三家公司都有关联交易。</p>
<hr>
<blockquote>
<p>作者：Jadepeng<br> 出处：jqpeng的技术记事本–<a target="_blank" rel="noopener" href="http://www.cnblogs.com/xiaoqi">http://www.cnblogs.com/xiaoqi</a><br> 您的支持是对博主最大的鼓励，感谢您的认真阅读。<br> 本文版权归作者所有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文连接，否则保留追究法律责任的权利。</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.iflyresearch.com/2019/09/05/jqpeng-%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E6%8E%A8%E7%90%86%E4%B8%8E%E5%AE%9E%E8%B7%B5%EF%BC%881%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/jadepeng/images/avatar.gif">
      <meta itemprop="name" content="JadePeng">
      <meta itemprop="description" content="JadePeng的技术笔记本">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JadePeng的技术笔记本">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/jadepeng/2019/09/05/jqpeng-%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E6%8E%A8%E7%90%86%E4%B8%8E%E5%AE%9E%E8%B7%B5%EF%BC%881%EF%BC%89/" class="post-title-link" itemprop="url">知识图谱推理与实践（1）</a>
        </h2>

        <div class="post-meta">

         
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-09-05 15:59:00" itemprop="dateCreated datePublished" datetime="2019-09-05T15:59:00+08:00">2019-09-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 18:09:47" itemprop="dateModified" datetime="2021-05-14T18:09:47+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/jadepeng/categories/%E5%8D%9A%E5%AE%A2/" itemprop="url" rel="index"><span itemprop="name">博客</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/jadepeng/categories/%E5%8D%9A%E5%AE%A2/jqpeng/" itemprop="url" rel="index"><span itemprop="name">jqpeng</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>5.5k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>5 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>文章作者:jqpeng<br>原文链接: <a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaoqi/p/kg-inference-1.html">知识图谱推理与实践（1）</a></p>
<p>由于工作原因，需要在系统里建立图谱推理功能，因此简单学习了浙江大学 陈华钧教授 知识图谱导论课程课件，这里记录下学习笔记。</p>
<h2 id="知识图谱推理的主要方法"><a href="#知识图谱推理的主要方法" class="headerlink" title="知识图谱推理的主要方法"></a>知识图谱推理的主要方法</h2><p>•  基于描述逻辑的推理（如DL-based）<br> •  基于图结构和统计规则挖掘的推理（如： PRA、 AMIE）<br> •  基于知识图谱表⽰学习的推理（如： TransE）<br> •  基于概率逻辑的⽅法（如： Statistical Relational Learning）</p>
<p><strong>基于符号逻辑的推理——本体推理</strong></p>
<ul>
<li>传统的符号逻辑推理中主要与知识图谱有关的推理手段是基于描述逻辑的本体推理。</li>
<li>描述逻辑主要被⽤来对事物的本体进⾏建模和推理，⽤来描述和推断概念分类及其概念之间的关系。</li>
<li>主要方法：<ul>
<li>基于表运算（Tableaux）及改进的⽅法： FaCT++、 Racer、 Pellet    Hermit等</li>
<li>基于Datalog转换的⽅法如KAON、 RDFox等</li>
<li>基于产⽣式规则的算法（如rete）： Jena 、 Sesame、 OWLIM等</li>
</ul>
</li>
</ul>
<p><img src="https://gitee.com/jadepeng/pic/raw/master/pic/2019/9/5/1567654565558.png" alt="本体推理"></p>
<p><strong>基于图结构和统计规则挖掘的推理</strong></p>
<p>主要方法：<br> • 基于路径排序学习⽅法(PRA， Path    ranking    Algorithm)<br> • 基于关联规则挖掘⽅法(AMIE)</p>
<p><img src="https://gitee.com/jadepeng/pic/raw/master/pic/2019/9/5/1567654649499.png" alt="基于图结构和统计规则挖掘的推理"></p>
<p><strong>基于知识图谱表示学习的关系推理</strong></p>
<ul>
<li>将实体和关系都表示为向量</li>
<li>通过向量之间的计算代替图的遍历和搜索来预测三元组的存在，由于向量的表示已经包含了实体原有的语义信息，计算含有⼀定的推理能⼒。</li>
<li>可应⽤于链接预测，基于路径的多度查询等</li>
</ul>
<p><img src="https://gitee.com/jadepeng/pic/raw/master/pic/2019/9/5/1567654752888.png" alt="表示学习推理"></p>
<p><strong>基于概率逻辑的⽅法——Statistical Relational Learning</strong></p>
<p>概率逻辑学习有时也叫Relational Machine Learning (RML)，关注关系的不确定性和复杂性。<br> 通常使用Bayesian networks or Markov networks</p>
<p><img src="https://gitee.com/jadepeng/pic/raw/master/pic/2019/9/5/1567655004326.png" alt="PSL"></p>
<h2 id="基于符号逻辑的推理"><a href="#基于符号逻辑的推理" class="headerlink" title="基于符号逻辑的推理"></a>基于符号逻辑的推理</h2><h3 id="本体概念推理"><a href="#本体概念推理" class="headerlink" title="本体概念推理"></a>本体概念推理</h3><p>图谱中基于RDF来作为资源描述语言，RDF是<strong>R</strong>esource <strong>D</strong>escription <strong>F</strong>ramework的简称。</p>
<p><img src="https://gitee.com/jadepeng/pic/raw/master/pic/2019/9/5/1567655169157.png" alt="RDF"></p>
<p>但是RDF表示关系层次受限，因此有了RDFS,在RDF的基础上，新增了<code>Class, subClassOf, type, Property, subPropertyOf, Domain, Range</code> 词汇，可以更好的表述相关关系。</p>
<p><img src="https://gitee.com/jadepeng/pic/raw/master/pic/2019/9/5/1567655092663.png" alt="RDFS"></p>
<p>基于RDFS，可以做一些简单的推理</p>
<p><img src="https://gitee.com/jadepeng/pic/raw/master/pic/2019/9/5/1567655311654.png" alt="RDFS推理"></p>
<p>OWL在RDFS的基础上，进一步扩展了一些复杂类型、约束：</p>
<p><img src="https://gitee.com/jadepeng/pic/raw/master/pic/2019/9/5/1567655366415.png" alt="OWL"></p>
<p>因此，我们也叫OWL为本体语言：</p>
<ul>
<li>OWL是知识图谱语言中最规范， 最严谨， 表达能力最强的语言</li>
<li>基于RDF语法，使表示出来的文档具有语义理解的结构基础</li>
<li>促进了统一词汇表的使用，定义了丰富的语义词汇</li>
<li>允许逻辑推理</li>
</ul>
<p>OWL的描述逻辑系统：</p>
<ul>
<li>一个描述逻辑系统包括四个基本的组成部分<ul>
<li>1）最基本的元素： <strong>概念</strong>、<strong>关系</strong>和<strong>个体</strong>（实例），</li>
<li><ol>
<li><strong>TBox</strong>术语集 (概念术语的公理集合) - 泛化的知识</li>
</ol>
</li>
</ul>
</li>
</ul>
<pre><code>    - 描述概念和关系的知识，被称之为公理 (Axiom)
- 1. **ABox断言集** (个体的断言集合)  --具体个体的信息


    - ABox包含外延知识 (又称断言 (Assertion))，描述论域中  
</code></pre>
<p>的特定个体<br>    - 1. <strong>TBox</strong>和<strong>ABox</strong>上的推理机制</p>
<ul>
<li>不同的描述逻辑系统的表示能力与推理机制由于对这四个组成部分的不同选择而不同</li>
</ul>
<p><img src="https://gitee.com/jadepeng/pic/raw/master/pic/2019/9/5/1567661842222.png" alt="描述逻辑的语义"></p>
<p>描述逻辑与OWL的对应：</p>
<p><img src="https://gitee.com/jadepeng/pic/raw/master/pic/2019/9/5/1567661923597.png" alt="OWL"></p>
<p>推理就是通过各种方法获取新的知识或者结论，这些知识和结论满足语义。</p>
<p>OWL本体推理</p>
<ul>
<li>可满足性<ul>
<li>本体可满足性： 检查一个本体是否可满足，即检查该本体是否有模型。</li>
<li>概念可满足性，检查某一概念的可满足性，即检查是否有模型，使得对该概念的解释不是空集。</li>
</ul>
</li>
</ul>
<p><img src="https://gitee.com/jadepeng/pic/raw/master/pic/2019/9/5/1567662582451.png" alt="可满足性"></p>
<ul>
<li>分类(classification)，针对Tbox的推理，计算新的概念的包含关系</li>
</ul>
<p><img src="https://gitee.com/jadepeng/pic/raw/master/pic/2019/9/5/1567662678216.png" alt="分类"></p>
<p><img src="https://gitee.com/jadepeng/pic/raw/master/pic/2019/9/5/1567662764038.png" alt="分类"></p>
<ul>
<li>实例化（materialization）,即计算属于某个概念或关系的所有实例的集合。</li>
</ul>
<p><img src="https://gitee.com/jadepeng/pic/raw/master/pic/2019/9/5/1567662840156.png" alt="实例化"></p>
<p>例子：</p>
<p><img src="https://gitee.com/jadepeng/pic/raw/master/pic/2019/9/5/1567662888484.png" alt="实例化选股"></p>
<p>典型的推理算法： Tableaux，适用于检查某一本体概念的可满足性，以及实例检测，基本思想是通过一系列规则构建Abox，以检测可满足性，或者检测某一实例是否存在于某概念，基本思想类似于一阶逻辑的归结反驳。</p>
<p><img src="https://gitee.com/jadepeng/pic/raw/master/pic/2019/9/5/1567663199419.png" alt="Tableaux"></p>
<h3 id="基于逻辑编程改写的方法"><a href="#基于逻辑编程改写的方法" class="headerlink" title="基于逻辑编程改写的方法"></a>基于逻辑编程改写的方法</h3><p>本体推理的局限:</p>
<ul>
<li>(1) 仅支持预定义的本体公理上的推理 (无法针对自定义的词汇支持灵活推理)</li>
<li>(2) 用户无法定义自己的推理过程</li>
</ul>
<p>因此，引入规则推理</p>
<ul>
<li>(1) 可以根据特定的场景定制规则，以实现用户自定义的推理过程</li>
<li>(2) Datalog语言可以结合本体推理和规则推理</li>
</ul>
<p>Datalog的语法：</p>
<ul>
<li>原子（atom）<ul>
<li>p(t1,t2,…,tn)</li>
<li>p是谓词，n是目数，ti是项</li>
<li>例如has_child(x,y)</li>
</ul>
</li>
<li>规则（rule）<ul>
<li>H:-B1,B2,…,Bm</li>
<li>has_child(X, Y) :−has_son(X, Y)</li>
</ul>
</li>
<li>事实(Fact)<ul>
<li>F(c1,c2,…cn):-</li>
<li>没有体部且没有变量的规则</li>
<li>例如：has_child(Alice,Bob):-</li>
</ul>
</li>
</ul>
<p>Datalog程序是规则的集合：</p>
<pre><code>has_child(X, Y) : −has_son(X, Y).
has_child(Alice, Bob) : −
</code></pre>
<p>Datalog 推理举例：</p>
<p><img src="https://gitee.com/jadepeng/pic/raw/master/pic/2019/9/5/1567663914942.png" alt="Datalog推理举例"></p>
<p>相关工具：</p>
<p><img src="https://gitee.com/jadepeng/pic/raw/master/pic/2019/9/5/1567663998133.png" alt="datalog工具"></p>
<h3 id="基于产生式规则的方法"><a href="#基于产生式规则的方法" class="headerlink" title="基于产生式规则的方法"></a>基于产生式规则的方法</h3><p>产生式系统，一种前向推理系统，可以按照一定机制执行规则从而达到某些目标，与一阶逻辑类似，也有区别，可以应用来做自动规划和专家系统。</p>
<p>产生式系统的组成：</p>
<ul>
<li>事实集合 (Working Memory)</li>
<li>产生式/规则集合 (Production Memory, PM)</li>
<li>推理引擎</li>
</ul>
<p><strong>产生式表示：</strong></p>
<p><strong>IF</strong> <em>conditions</em> <strong>THEN</strong> <em>actions</em></p>
<ul>
<li>conditions是由条件组成的集合，又称为LHS（Left Hand Side）</li>
<li>actions是由动作组成的序列，又称为RHS（Right Hand Side)</li>
</ul>
<p>LHS，是条件的集合，各条件是<strong>且</strong>（AND）的关系，当所有条件均被满足，则该规则触发。<br> 条件形如(type attr1: spec1 attr2:spec2)条件的形式：</p>
<ul>
<li>原子 (person name:alice)</li>
<li>变量（person name:x)</li>
<li>表达式 (person age:[n+4]</li>
<li>布尔  (person age:{&gt;10})</li>
<li>约束的与、或、非</li>
</ul>
<p>RHS，是执行动作（action）的序列，执行时依次运行。动作的种类有ADD pattern，Remove i，Modify i，可以理解为对WME（Working Memory）的CUD；</p>
<p>产生式举例：</p>
<pre><code>IF (Student name: x)
Then ADD (Person name: x)
</code></pre>
<p>也可以写作：</p>
<pre><code>(Student name: x) ⇒ ADD (Person name: x)
</code></pre>
<p><strong>推理引擎</strong></p>
<p>➤ 控制系统的执行：</p>
<ul>
<li>模式匹配，用规则的条件部分匹配事实集中的事实，整个LHS都被满足的规，则被触发，并被加入议程(agenda)</li>
<li>解决冲突，按一定的策略从被触发的多条规则中选择一条</li>
<li>执行动作，执行被选择出来的规则的RHS，从而对WM进行一定的操作</li>
</ul>
<blockquote>
<p>产生式系统=事实集+产生式集合+推理引擎</p>
</blockquote>
<p>产生式系统执行流程</p>
<p><img src="https://gitee.com/jadepeng/pic/raw/master/pic/2019/9/5/1567664825865.png" alt="产生式系统执行流程"></p>
<p><img src="https://gitee.com/jadepeng/pic/raw/master/pic/2019/9/5/1567664993490.png" alt="匹配举例"></p>
<p>模式匹配——RETE算法</p>
<ul>
<li>将产生式的LHS组织成判别网络形式</li>
<li>用空间换时间</li>
</ul>
<p><img src="https://gitee.com/jadepeng/pic/raw/master/pic/2019/9/5/1567665661458.png" alt="RETE算法"></p>
<p>相关工具介绍</p>
<ul>
<li>Drools</li>
<li>Jena  提供了处理RDF、 RDFS、 OWL数据的接口，还提供了一个规则引擎</li>
</ul>
<pre><code>Model m = ModelFactory.createDefaultModel(); 
Reasoner reasoner = new
GenericRuleReasoner(Rule.rulesFromURL(&quot;file:rule.txt&quot;));
InfModel inf = ModelFactory.createInfModel(reasoner, m)
</code></pre>
<p><img src="https://gitee.com/jadepeng/pic/raw/master/pic/2019/9/5/1567666453041.png" alt="相关工具"></p>
<h2 id="Inductive-Reasoning-–-基于图的方法"><a href="#Inductive-Reasoning-–-基于图的方法" class="headerlink" title="Inductive Reasoning – 基于图的方法"></a>Inductive Reasoning – 基于图的方法</h2><h3 id="PRA"><a href="#PRA" class="headerlink" title="PRA"></a>PRA</h3><p>➤ 将连接两个实体的路径作为特征来预测其间可能存在的关系</p>
<p><img src="https://gitee.com/jadepeng/pic/raw/master/pic/2019/9/5/1567666584899.png" alt="Inductive Reasoning"></p>
<p>• 通用关系学习框架 (generic relational learning framework)</p>
<p><img src="https://gitee.com/jadepeng/pic/raw/master/pic/2019/9/5/1567666662380.png" alt="PRA"></p>
<p>路径排序算法 – Path Ranking Algorithm (PRA)</p>
<p><img src="https://gitee.com/jadepeng/pic/raw/master/pic/2019/9/5/1567666738103.png" alt="PRA2"></p>
<p><img src="https://gitee.com/jadepeng/pic/raw/master/pic/2019/9/5/1567667132068.png" alt="enter description here"></p>
<h3 id="TransE"><a href="#TransE" class="headerlink" title="TransE"></a>TransE</h3><p>知识图谱嵌⼊模型： TransE</p>
<p>TransE(Translating Embeddings for Modeling Multi-relational Data. NIPS 3013)</p>
<p><img src="https://gitee.com/jadepeng/pic/raw/master/pic/2019/9/5/1567667166879.png" alt="TransE"></p>
<p><img src="https://gitee.com/jadepeng/pic/raw/master/pic/2019/9/5/1567667213371.png"></p>
<p>⽬标函数：</p>
<p><img src="https://gitee.com/jadepeng/pic/raw/master/pic/2019/9/5/1567667274835.png" alt="TransE"></p>
<p>损失函数：</p>
<p><img src="https://gitee.com/jadepeng/pic/raw/master/pic/2019/9/5/1567667306669.png" alt="TransE 损失函数"></p>
<p>知识图谱嵌⼊模型： 预测问题</p>
<ul>
<li>测试三元组( h, r, t )</li>
<li>尾实体预测( h, r, ? )</li>
<li>头实体预测( ?, r, t )</li>
</ul>
<p><img src="https://gitee.com/jadepeng/pic/raw/master/pic/2019/9/5/1567667416512.png" alt="图嵌入预测"></p>
<h3 id="PRA-vs-TransE"><a href="#PRA-vs-TransE" class="headerlink" title="PRA vs. TransE"></a>PRA vs. TransE</h3><p><img src="https://gitee.com/jadepeng/pic/raw/master/pic/2019/9/5/1567667540090.png" alt="PRA"></p>
<h2 id="基于Jena实现演绎推理"><a href="#基于Jena实现演绎推理" class="headerlink" title="基于Jena实现演绎推理"></a>基于Jena实现演绎推理</h2><p><img src="https://gitee.com/jadepeng/pic/raw/master/pic/2019/9/5/1567667584143.png" alt="实践图谱"></p>
<h3 id="构建model"><a href="#构建model" class="headerlink" title="构建model"></a>构建model</h3><p>NO BB, show code：</p>
<pre><code>Model myMod = ModelFactory.createDefaultModel();
String finance = “http://www.example.org/kse/finance#”;

// 实体
Resource shb = myMod.createResource(finance + &quot;孙宏斌&quot;);
Resource rczg = myMod.createResource(finance + &quot;融创中国&quot;);


// 关系

Property control = myMod.createProperty(finance + &quot;执掌&quot;);

// 加入三元组
myMod.add(shb, control, rczg);
</code></pre>
<p>上图所示的图谱，包含如下的三元组：</p>
<pre><code>finance :孙宏斌 finance :control finance :融创中国
finance :贾跃亭 finance :control finance :乐视网
finance :融创中国 rdf:type finance :地产公司
finance :地产公司 rdfs:subclassOf finance:公司
finance:公司 rdfs:subclassOf finance:法人实体
finance:孙宏斌 rdf:type finance:公司
finance:孙宏斌 rdf:type finance:人
finance :人 owl:disjointWith finance:公司
</code></pre>
<p>我们可以依次加入，代码略。</p>
<h3 id="添加推理机"><a href="#添加推理机" class="headerlink" title="添加推理机"></a>添加推理机</h3><p>jena推理使用的是InfModel，可以基于Model构造，实际上在原来的Model之上加了个RDFS推理机</p>
<pre><code>InfModel inf_rdfs = ModelFactory.createRDFSModel(myMod);
</code></pre>
<p>• 上下位推理</p>
<p>通过listStatements来获取是否有满足条件的三元组，从而实现判断，subClassOf是RDFS里的vob，因此使用RDFS.subClassOf。</p>
<pre><code>public static void subClassOf(Model m, Resource s, Resource o) &#123;
for (StmtIterator i = m.listStatements(s, RDFS.subClassOf, o); i.hasNext(); ) &#123;
Statement stmt = i.nextStatement();
System.out.println(&quot; yes! &quot; );
break;
&#125;
&#125;

subClassOf(inf_rdfs, myMod.getResource(finance+&quot;地产公司&quot;),myMod.getResource(finance+”法人实体&quot;));
</code></pre>
<p><img src="https://gitee.com/jadepeng/pic/raw/master/pic/2019/9/5/1567667888587.png" alt="enter description here"></p>
<p>• 针对类别的推理，OWL推理机可以针对个体类别做出完备推理，即补充完整该个体的所有类别；在查询的时候，可以直接打印出所有类别！</p>
<p>首先构建owl推理机：</p>
<pre><code>Reasoner reasoner = ReasonerRegistry.getOWLReasoner();
InfModel inf_owl = ModelFactory.createInfModel(reasoner, myMod);
</code></pre>
<p>然后执行类别推理</p>
<pre><code>public static void printStatements(Model m, Resource s, Property p, Resource o) &#123;
for (StmtIterator i = m.listStatements(s,p,o); i.hasNext(); ) &#123;
Statement stmt = i.nextStatement();
System.out.println(&quot; - &quot; + PrintUtil.print(stmt));
&#125;
&#125;
printStatements(inf_owl, rczg, RDF.type, null);
</code></pre>
<p><img src="https://gitee.com/jadepeng/pic/raw/master/pic/2019/9/5/1567668055162.png" alt="enter description here"></p>
<p>• 不一致检测, jena的另一个常用推理就是检验data的不一致。</p>
<pre><code>Model data = FileManager.get().loadModel(fname);
Reasoner reasoner = ReasonerRegistry.getOWLReasoner();
InfModel inf_owl = ModelFactory.createInfModel(reasoner, myMod);
ValidityReport validity = inf_owl.validate();
if (validity.isValid()) &#123;
System.out.println(“没有不一致&quot;);
&#125; else &#123;
System.out.println(“存在不一致，如下： &quot;);
for (Iterator i = validity.getReports(); i.hasNext(); ) &#123;
System.out.println(&quot; - &quot; + i.next());
&#125;
&#125;
</code></pre>
<p><img src="https://gitee.com/jadepeng/pic/raw/master/pic/2019/9/5/1567668144683.png" alt="enter description here"></p>
<hr>
<blockquote>
<p>作者：Jadepeng<br> 出处：jqpeng的技术记事本–<a target="_blank" rel="noopener" href="http://www.cnblogs.com/xiaoqi">http://www.cnblogs.com/xiaoqi</a><br> 您的支持是对博主最大的鼓励，感谢您的认真阅读。<br> 本文版权归作者所有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文连接，否则保留追究法律责任的权利。</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.iflyresearch.com/2019/09/03/jqpeng-Docker%20swarm%20%E8%8E%B7%E5%8F%96service%E7%9A%84container%E4%BF%A1%E6%81%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/jadepeng/images/avatar.gif">
      <meta itemprop="name" content="JadePeng">
      <meta itemprop="description" content="JadePeng的技术笔记本">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JadePeng的技术笔记本">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/jadepeng/2019/09/03/jqpeng-Docker%20swarm%20%E8%8E%B7%E5%8F%96service%E7%9A%84container%E4%BF%A1%E6%81%AF/" class="post-title-link" itemprop="url">Docker swarm 获取service的container信息</a>
        </h2>

        <div class="post-meta">

         
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-09-03 08:48:00" itemprop="dateCreated datePublished" datetime="2019-09-03T08:48:00+08:00">2019-09-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 18:09:47" itemprop="dateModified" datetime="2021-05-14T18:09:47+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/jadepeng/categories/%E5%8D%9A%E5%AE%A2/" itemprop="url" rel="index"><span itemprop="name">博客</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/jadepeng/categories/%E5%8D%9A%E5%AE%A2/jqpeng/" itemprop="url" rel="index"><span itemprop="name">jqpeng</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>22k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>20 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>文章作者:jqpeng<br>原文链接: <a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaoqi/p/docker-service-container.html">Docker swarm 获取service的container信息</a></p>
<p>我们可以通过<code>docker service create</code>创建服务，例如：</p>
<pre><code>docker service create --name mysql mysql:latest
</code></pre>
<p>服务创建好后，如何来获取该service包含的容器信息呢？比如获取刚才创建的mysql服务的容器。我们可以通过docker service ps命令来获取，</p>
<h2 id="命令行方式"><a href="#命令行方式" class="headerlink" title="命令行方式"></a>命令行方式</h2><pre><code>~# docker service ps mysql
ID                  NAME                IMAGE               NODE                DESIRED STATE       CURRENT STATE        ERROR               PORTS
lvskmv1lkhz6        mysql.1             mysql:latest        docker86-9          Running             Running 3 days ago 
</code></pre>
<p>遗憾的是返回的数据不包含containerId，只有serviceId, 可以通过<code>docker inspect来获取service详情</code></p>
<pre><code>~# docker inspect lvskmv1lkhz6
[
    &#123;
        &quot;ID&quot;: &quot;lvskmv1lkhz6bvynfuxa0jqgn&quot;,
        &quot;Version&quot;: &#123;
            &quot;Index&quot;: 21
        &#125;,
        &quot;CreatedAt&quot;: &quot;2019-08-30T08:04:18.382831966Z&quot;,
        &quot;UpdatedAt&quot;: &quot;2019-08-30T08:09:43.613636037Z&quot;,
        &quot;Labels&quot;: &#123;&#125;,
        &quot;Spec&quot;: &#123;
            &quot;ContainerSpec&quot;: &#123;
                &quot;Image&quot;: &quot;mysql:latest@sha256:01cf53f2538aa805bda591d83f107c394adca8d31f98eacd3654e282dada3193&quot;,
                &quot;Env&quot;: [
                    &quot;MYSQL_ROOT_PASSWORD=aimind@mysql2019\&quot;&quot;
                ],
                &quot;Isolation&quot;: &quot;default&quot;
            &#125;,
            &quot;Resources&quot;: &#123;
                &quot;Limits&quot;: &#123;&#125;,
                &quot;Reservations&quot;: &#123;&#125;
            &#125;,
            &quot;RestartPolicy&quot;: &#123;
                &quot;Condition&quot;: &quot;any&quot;,
                &quot;Delay&quot;: 5000000000,
                &quot;MaxAttempts&quot;: 0,
                &quot;Window&quot;: 0
            &#125;,
            &quot;Placement&quot;: &#123;&#125;,
            &quot;ForceUpdate&quot;: 0
        &#125;,
        &quot;ServiceID&quot;: &quot;uporil7xf4rwffa0rhg1j5htw&quot;,
        &quot;Slot&quot;: 1,
        &quot;NodeID&quot;: &quot;sixp62dhqe702b69pm6v8m9rh&quot;,
        &quot;Status&quot;: &#123;
            &quot;Timestamp&quot;: &quot;2019-08-30T08:09:43.554514932Z&quot;,
            &quot;State&quot;: &quot;running&quot;,
            &quot;Message&quot;: &quot;started&quot;,
            &quot;ContainerStatus&quot;: &#123;
                &quot;ContainerID&quot;: &quot;2cf128f77797f08419f50a057973388f15753efb16134ed05370ded495d0ac08&quot;,
                &quot;PID&quot;: 14884,
                &quot;ExitCode&quot;: 0
            &#125;,
            &quot;PortStatus&quot;: &#123;&#125;
        &#125;,
        &quot;DesiredState&quot;: &quot;running&quot;,
        &quot;NetworksAttachments&quot;: [
            &#123;
                &quot;Network&quot;: &#123;
                    &quot;ID&quot;: &quot;emypqxzjggws7uicersyz6uag&quot;,
                    &quot;Version&quot;: &#123;
                        &quot;Index&quot;: 12
                    &#125;,
                    &quot;CreatedAt&quot;: &quot;2019-08-30T08:02:57.254494392Z&quot;,
                    &quot;UpdatedAt&quot;: &quot;2019-08-30T08:02:57.271216394Z&quot;,
                    &quot;Spec&quot;: &#123;
                        &quot;Name&quot;: &quot;aimind-overlay&quot;,
                        &quot;Labels&quot;: &#123;&#125;,
                        &quot;DriverConfiguration&quot;: &#123;
                            &quot;Name&quot;: &quot;overlay&quot;
                        &#125;,
                        &quot;IPAMOptions&quot;: &#123;
                            &quot;Driver&quot;: &#123;
                                &quot;Name&quot;: &quot;default&quot;
                            &#125;
                        &#125;,
                        &quot;Scope&quot;: &quot;swarm&quot;
                    &#125;,
                    &quot;DriverState&quot;: &#123;
                        &quot;Name&quot;: &quot;overlay&quot;,
                        &quot;Options&quot;: &#123;
                            &quot;com.docker.network.driver.overlay.vxlanid_list&quot;: &quot;4097&quot;
                        &#125;
                    &#125;,
                    &quot;IPAMOptions&quot;: &#123;
                        &quot;Driver&quot;: &#123;
                            &quot;Name&quot;: &quot;default&quot;
                        &#125;,
                        &quot;Configs&quot;: [
                            &#123;
                                &quot;Subnet&quot;: &quot;10.0.0.0/24&quot;,
                                &quot;Gateway&quot;: &quot;10.0.0.1&quot;
                            &#125;
                        ]
                    &#125;
                &#125;,
                &quot;Addresses&quot;: [
                    &quot;10.0.0.4/24&quot;
                ]
            &#125;
        ]
    &#125;
]
</code></pre>
<p>返回的json中，<code>NodeID</code>是所在节点ID，<code>Status.ContainerStatus</code> 是容器的状态信息，<code>.Status.ContainerStatus.ContainerID</code> 是容器ID，比如这里的是<code>2cf128f77797f08419f50a057973388f15753efb16134ed05370ded495d0ac08</code>。</p>
<p>拿到容器ID就能获取容器详情了，也可以获取container的统计信息：</p>
<pre><code>docker inspect 2cf128f77797f08419f50a057973388f15753efb16134ed05370ded495d0ac08
[
    &#123;
        &quot;Id&quot;: &quot;2cf128f77797f08419f50a057973388f15753efb16134ed05370ded495d0ac08&quot;,
        &quot;Created&quot;: &quot;2019-08-30T08:09:41.827551223Z&quot;,
        &quot;Path&quot;: &quot;docker-entrypoint.sh&quot;,
        &quot;Args&quot;: [
            &quot;mysqld&quot;
        ],
        &quot;State&quot;: &#123;
            &quot;Status&quot;: &quot;running&quot;,
            &quot;Running&quot;: true,
            &quot;Paused&quot;: false,
            &quot;Restarting&quot;: false,
            &quot;OOMKilled&quot;: false,
            &quot;Dead&quot;: false,
            &quot;Pid&quot;: 14884,
            &quot;ExitCode&quot;: 0,
            &quot;Error&quot;: &quot;&quot;,
            &quot;StartedAt&quot;: &quot;2019-08-30T08:09:43.402630785Z&quot;,
            &quot;FinishedAt&quot;: &quot;0001-01-01T00:00:00Z&quot;
        &#125;,
        &quot;Image&quot;: &quot;sha256:62a9f311b99c24c0fde0a772abc6030bc48e5acc7d7416b8eeb72d3da1b4eb6c&quot;,
        &quot;ResolvConfPath&quot;: &quot;/data/docker/containers/2cf128f77797f08419f50a057973388f15753efb16134ed05370ded495d0ac08/resolv.conf&quot;,
        &quot;HostnamePath&quot;: &quot;/data/docker/containers/2cf128f77797f08419f50a057973388f15753efb16134ed05370ded495d0ac08/hostname&quot;,
        &quot;HostsPath&quot;: &quot;/data/docker/containers/2cf128f77797f08419f50a057973388f15753efb16134ed05370ded495d0ac08/hosts&quot;,
        &quot;LogPath&quot;: &quot;/data/docker/containers/2cf128f77797f08419f50a057973388f15753efb16134ed05370ded495d0ac08/2cf128f77797f08419f50a057973388f15753efb16134ed05370ded495d0ac08-json.log&quot;,
        &quot;Name&quot;: &quot;/mysql.1.lvskmv1lkhz6bvynfuxa0jqgn&quot;,
        &quot;RestartCount&quot;: 0,
        &quot;Driver&quot;: &quot;overlay2&quot;,
        &quot;Platform&quot;: &quot;linux&quot;,
        &quot;MountLabel&quot;: &quot;&quot;,
        &quot;ProcessLabel&quot;: &quot;&quot;,
        &quot;AppArmorProfile&quot;: &quot;docker-default&quot;,
        &quot;ExecIDs&quot;: null,
        &quot;HostConfig&quot;: &#123;
            &quot;Binds&quot;: null,
            &quot;ContainerIDFile&quot;: &quot;&quot;,
            &quot;LogConfig&quot;: &#123;
                &quot;Type&quot;: &quot;json-file&quot;,
                &quot;Config&quot;: &#123;
                    &quot;max-file&quot;: &quot;3&quot;,
                    &quot;max-size&quot;: &quot;10m&quot;
                &#125;
            &#125;,
            &quot;NetworkMode&quot;: &quot;default&quot;,
            &quot;PortBindings&quot;: &#123;&#125;,
            &quot;RestartPolicy&quot;: &#123;
                &quot;Name&quot;: &quot;&quot;,
                &quot;MaximumRetryCount&quot;: 0
            &#125;,
            &quot;AutoRemove&quot;: false,
            &quot;VolumeDriver&quot;: &quot;&quot;,
            &quot;VolumesFrom&quot;: null,
            &quot;CapAdd&quot;: null,
            &quot;CapDrop&quot;: null,
            &quot;Dns&quot;: null,
            &quot;DnsOptions&quot;: null,
            &quot;DnsSearch&quot;: null,
            &quot;ExtraHosts&quot;: null,
            &quot;GroupAdd&quot;: null,
            &quot;IpcMode&quot;: &quot;shareable&quot;,
            &quot;Cgroup&quot;: &quot;&quot;,
            &quot;Links&quot;: null,
            &quot;OomScoreAdj&quot;: 0,
            &quot;PidMode&quot;: &quot;&quot;,
            &quot;Privileged&quot;: false,
            &quot;PublishAllPorts&quot;: false,
            &quot;ReadonlyRootfs&quot;: false,
            &quot;SecurityOpt&quot;: null,
            &quot;UTSMode&quot;: &quot;&quot;,
            &quot;UsernsMode&quot;: &quot;&quot;,
            &quot;ShmSize&quot;: 67108864,
            &quot;Runtime&quot;: &quot;runc&quot;,
            &quot;ConsoleSize&quot;: [
                0,
                0
            ],
            &quot;Isolation&quot;: &quot;default&quot;,
            &quot;CpuShares&quot;: 0,
            &quot;Memory&quot;: 0,
            &quot;NanoCpus&quot;: 0,
            &quot;CgroupParent&quot;: &quot;&quot;,
            &quot;BlkioWeight&quot;: 0,
            &quot;BlkioWeightDevice&quot;: null,
            &quot;BlkioDeviceReadBps&quot;: null,
            &quot;BlkioDeviceWriteBps&quot;: null,
            &quot;BlkioDeviceReadIOps&quot;: null,
            &quot;BlkioDeviceWriteIOps&quot;: null,
            &quot;CpuPeriod&quot;: 0,
            &quot;CpuQuota&quot;: 0,
            &quot;CpuRealtimePeriod&quot;: 0,
            &quot;CpuRealtimeRuntime&quot;: 0,
            &quot;CpusetCpus&quot;: &quot;&quot;,
            &quot;CpusetMems&quot;: &quot;&quot;,
            &quot;Devices&quot;: null,
            &quot;DeviceCgroupRules&quot;: null,
            &quot;DiskQuota&quot;: 0,
            &quot;KernelMemory&quot;: 0,
            &quot;MemoryReservation&quot;: 0,
            &quot;MemorySwap&quot;: 0,
            &quot;MemorySwappiness&quot;: null,
            &quot;OomKillDisable&quot;: false,
            &quot;PidsLimit&quot;: 0,
            &quot;Ulimits&quot;: null,
            &quot;CpuCount&quot;: 0,
            &quot;CpuPercent&quot;: 0,
            &quot;IOMaximumIOps&quot;: 0,
            &quot;IOMaximumBandwidth&quot;: 0,
            &quot;MaskedPaths&quot;: [
                &quot;/proc/acpi&quot;,
                &quot;/proc/kcore&quot;,
                &quot;/proc/keys&quot;,
                &quot;/proc/latency_stats&quot;,
                &quot;/proc/timer_list&quot;,
                &quot;/proc/timer_stats&quot;,
                &quot;/proc/sched_debug&quot;,
                &quot;/proc/scsi&quot;,
                &quot;/sys/firmware&quot;
            ],
            &quot;ReadonlyPaths&quot;: [
                &quot;/proc/asound&quot;,
                &quot;/proc/bus&quot;,
                &quot;/proc/fs&quot;,
                &quot;/proc/irq&quot;,
                &quot;/proc/sys&quot;,
                &quot;/proc/sysrq-trigger&quot;
            ]
        &#125;,
        &quot;GraphDriver&quot;: &#123;
            &quot;Data&quot;: &#123;
                &quot;LowerDir&quot;: &quot;/data/docker/overlay2/f0184a2c979eef7a135726a49f5651e16b568ecfd47606e20e504e28ea311f25-init/diff:/data/docker/overlay2/644c4c905af78d3320559b9f388631151dcf5c19ab8f2c91999d4d59c8409784/diff:/data/docker/overlay2/7ed834798bd5eeef1b75d012a27bb01cd8a0a5e71048db72a8743980481bb74b/diff:/data/docker/overlay2/56e3eac1c86a9ae29b3251025824f93b78e43151a36eb973407feb1075d8db1c/diff:/data/docker/overlay2/40161cfa334a118eaa09c04dc7d864d00e3544f77e6979584298478f68566bc5/diff:/data/docker/overlay2/e884a3df3e827368a468a4afc8850de4fa6336a78ca9a922406237e3ab75a97e/diff:/data/docker/overlay2/a04e8776674f902eaa0e15467ad0678f03baf2a1b8a568b034ad4b4c1ddb1a23/diff:/data/docker/overlay2/7745739e901232d6b702b599844157583d02a34fa4aca10c888e0e9c44075433/diff:/data/docker/overlay2/f423b8f55475ec902cea1ea5c54897ed6a24da3cc0acd64a79e022e887d83e77/diff:/data/docker/overlay2/231e63e7fbb5084facc93c89ed23d366d915f9a2edd4f85735df5d45bc87cafa/diff:/data/docker/overlay2/c11047327e6f47e49d1abee4df8acbaba51ac6b92e59801ac613331c5bad3bc1/diff:/data/docker/overlay2/f893602043c1b5ad9d2839ec0ab8f17da7e0eaf073788f6c3d35138dfe6c06b8/diff:/data/docker/overlay2/3443517fc9e882df67d9730a9aa7530dc3c541b6872aaf05290c5e7ec588e0fb/diff&quot;,
                &quot;MergedDir&quot;: &quot;/data/docker/overlay2/f0184a2c979eef7a135726a49f5651e16b568ecfd47606e20e504e28ea311f25/merged&quot;,
                &quot;UpperDir&quot;: &quot;/data/docker/overlay2/f0184a2c979eef7a135726a49f5651e16b568ecfd47606e20e504e28ea311f25/diff&quot;,
                &quot;WorkDir&quot;: &quot;/data/docker/overlay2/f0184a2c979eef7a135726a49f5651e16b568ecfd47606e20e504e28ea311f25/work&quot;
            &#125;,
            &quot;Name&quot;: &quot;overlay2&quot;
        &#125;,
        &quot;Mounts&quot;: [
            &#123;
                &quot;Type&quot;: &quot;volume&quot;,
                &quot;Name&quot;: &quot;c2128d05001b8fec1712807f381e2c72d42ce8a83ae97f6b038f51c0d48446f1&quot;,
                &quot;Source&quot;: &quot;/data/docker/volumes/c2128d05001b8fec1712807f381e2c72d42ce8a83ae97f6b038f51c0d48446f1/_data&quot;,
                &quot;Destination&quot;: &quot;/var/lib/mysql&quot;,
                &quot;Driver&quot;: &quot;local&quot;,
                &quot;Mode&quot;: &quot;&quot;,
                &quot;RW&quot;: true,
                &quot;Propagation&quot;: &quot;&quot;
            &#125;
        ],
        &quot;Config&quot;: &#123;
            &quot;Hostname&quot;: &quot;2cf128f77797&quot;,
            &quot;Domainname&quot;: &quot;&quot;,
            &quot;User&quot;: &quot;&quot;,
            &quot;AttachStdin&quot;: false,
            &quot;AttachStdout&quot;: false,
            &quot;AttachStderr&quot;: false,
            &quot;ExposedPorts&quot;: &#123;
                &quot;3306/tcp&quot;: &#123;&#125;,
                &quot;33060/tcp&quot;: &#123;&#125;
            &#125;,
            &quot;Tty&quot;: false,
            &quot;OpenStdin&quot;: false,
            &quot;StdinOnce&quot;: false,
            &quot;Env&quot;: [
                &quot;MYSQL_ROOT_PASSWORD=aimind@mysql2019\&quot;&quot;,
                &quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;,
                &quot;GOSU_VERSION=1.7&quot;,
                &quot;MYSQL_MAJOR=8.0&quot;,
                &quot;MYSQL_VERSION=8.0.17-1debian9&quot;
            ],
            &quot;Cmd&quot;: [
                &quot;mysqld&quot;
            ],
            &quot;ArgsEscaped&quot;: true,
            &quot;Image&quot;: &quot;mysql:latest@sha256:01cf53f2538aa805bda591d83f107c394adca8d31f98eacd3654e282dada3193&quot;,
            &quot;Volumes&quot;: &#123;
                &quot;/var/lib/mysql&quot;: &#123;&#125;
            &#125;,
            &quot;WorkingDir&quot;: &quot;&quot;,
            &quot;Entrypoint&quot;: [
                &quot;docker-entrypoint.sh&quot;
            ],
            &quot;OnBuild&quot;: null,
            &quot;Labels&quot;: &#123;
                &quot;com.docker.swarm.node.id&quot;: &quot;sixp62dhqe702b69pm6v8m9rh&quot;,
                &quot;com.docker.swarm.service.id&quot;: &quot;uporil7xf4rwffa0rhg1j5htw&quot;,
                &quot;com.docker.swarm.service.name&quot;: &quot;mysql&quot;,
                &quot;com.docker.swarm.task&quot;: &quot;&quot;,
                &quot;com.docker.swarm.task.id&quot;: &quot;lvskmv1lkhz6bvynfuxa0jqgn&quot;,
                &quot;com.docker.swarm.task.name&quot;: &quot;mysql.1.lvskmv1lkhz6bvynfuxa0jqgn&quot;
            &#125;
        &#125;,
        &quot;NetworkSettings&quot;: &#123;
            &quot;Bridge&quot;: &quot;&quot;,
            &quot;SandboxID&quot;: &quot;459ab4b83580513da251182d08dc217d0079613d10952df00ffcca6e2537958b&quot;,
            &quot;HairpinMode&quot;: false,
            &quot;LinkLocalIPv6Address&quot;: &quot;&quot;,
            &quot;LinkLocalIPv6PrefixLen&quot;: 0,
            &quot;Ports&quot;: &#123;
                &quot;3306/tcp&quot;: null,
                &quot;33060/tcp&quot;: null
            &#125;,
            &quot;SandboxKey&quot;: &quot;/var/run/docker/netns/459ab4b83580&quot;,
            &quot;SecondaryIPAddresses&quot;: null,
            &quot;SecondaryIPv6Addresses&quot;: null,
            &quot;EndpointID&quot;: &quot;&quot;,
            &quot;Gateway&quot;: &quot;&quot;,
            &quot;GlobalIPv6Address&quot;: &quot;&quot;,
            &quot;GlobalIPv6PrefixLen&quot;: 0,
            &quot;IPAddress&quot;: &quot;&quot;,
            &quot;IPPrefixLen&quot;: 0,
            &quot;IPv6Gateway&quot;: &quot;&quot;,
            &quot;MacAddress&quot;: &quot;&quot;,
            &quot;Networks&quot;: &#123;
                &quot;aimind-overlay&quot;: &#123;
                    &quot;IPAMConfig&quot;: &#123;
                        &quot;IPv4Address&quot;: &quot;10.0.0.4&quot;
                    &#125;,
                    &quot;Links&quot;: null,
                    &quot;Aliases&quot;: [
                        &quot;2cf128f77797&quot;
                    ],
                    &quot;NetworkID&quot;: &quot;emypqxzjggws7uicersyz6uag&quot;,
                    &quot;EndpointID&quot;: &quot;56a78b2527a6dcf83fd3dc2794c514aaa325457d9c8a21bd236d3ea3c22c8fa9&quot;,
                    &quot;Gateway&quot;: &quot;&quot;,
                    &quot;IPAddress&quot;: &quot;10.0.0.4&quot;,
                    &quot;IPPrefixLen&quot;: 24,
                    &quot;IPv6Gateway&quot;: &quot;&quot;,
                    &quot;GlobalIPv6Address&quot;: &quot;&quot;,
                    &quot;GlobalIPv6PrefixLen&quot;: 0,
                    &quot;MacAddress&quot;: &quot;02:42:0a:00:00:04&quot;,
                    &quot;DriverOpts&quot;: null
                &#125;
            &#125;
        &#125;
    &#125;
]
</code></pre>
<p>然后就可以通过stats来获取资源占用情况：</p>
<pre><code>~#docker stats 2cf128f77797f08419f50a057973388f15753efb16134ed05370ded495d0ac08 --all --no-stream 
CONTAINER ID        NAME                                CPU %               MEM USAGE / LIMIT     MEM %               NET I/O             BLOCK I/O           PIDS
2cf128f77797        mysql.1.lvskmv1lkhz6bvynfuxa0jqgn   0.33%               374.4MiB / 188.8GiB   0.19%               230kB / 0B          8.19kB / 1.26GB     38
</code></pre>
<h2 id="coding方式"><a href="#coding方式" class="headerlink" title="coding方式"></a>coding方式</h2><p>除了命令行，我们还可以通过docker api来获取，可以参见 <a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaoqi/p/docker-java.html">docker-java Docker的java API</a></p>
<h3 id="获取containerID"><a href="#获取containerID" class="headerlink" title="获取containerID"></a>获取containerID</h3><pre><code>System.out.println(client.listTasksCmd().withNameFilter(&quot;mysql&quot;).exec());
</code></pre>
<p>结果：</p>
<pre><code>[class Task &#123;
    ID: lvskmv1lkhz6bvynfuxa0jqgn
    version: 21
    createdAt: 2019-08-30T08:04:18.382831966Z
    updatedAt: 2019-08-30T08:09:43.613636037Z
    name: null
    labels: &#123;&#125;
    spec: TaskSpec[containerSpec=ContainerSpec[image=mysql:latest@sha256:01cf53f2538aa805bda591d83f107c394adca8d31f98eacd3654e282dada3193,labels=&lt;null&gt;,command=&lt;null&gt;,args=&lt;null&gt;,env=[MYSQL_ROOT_PASSWORD=aimind@mysql2019&quot;],dir=&lt;null&gt;,user=&lt;null&gt;,groups=&lt;null&gt;,tty=&lt;null&gt;,mounts=&lt;null&gt;,duration=&lt;null&gt;,stopGracePeriod=&lt;null&gt;,dnsConfig=&lt;null&gt;,openStdin=&lt;null&gt;,readOnly=&lt;null&gt;,hosts=&lt;null&gt;,hostname=&lt;null&gt;,secrets=&lt;null&gt;,healthCheck=&lt;null&gt;,stopSignal=&lt;null&gt;,privileges=&lt;null&gt;,configs=&lt;null&gt;],resources=ResourceRequirements[limits=ResourceSpecs[memoryBytes=&lt;null&gt;,nanoCPUs=&lt;null&gt;],reservations=ResourceSpecs[memoryBytes=&lt;null&gt;,nanoCPUs=&lt;null&gt;]],restartPolicy=ServiceRestartPolicy[condition=ANY,delay=5000000000,maxAttempts=0,window=0],placement=ServicePlacement[constraints=&lt;null&gt;,platforms=&lt;null&gt;],logDriver=&lt;null&gt;,forceUpdate=0,networks=&lt;null&gt;,runtime=&lt;null&gt;]
    serviceId: uporil7xf4rwffa0rhg1j5htw
    slot: 1
    nodeId: sixp62dhqe702b69pm6v8m9rh
    assignedGenericResources: null
    status: TaskStatus[timestamp=2019-08-30T08:09:43.554514932Z,state=running,message=started,err=&lt;null&gt;,containerStatus=TaskStatusContainerStatus[containerID=2cf128f77797f08419f50a057973388f15753efb16134ed05370ded495d0ac08,pid=14884,exitCode=0]]
    desiredState: running
&#125;]
</code></pre>
<p>可以看到containerID：<code>2cf128f77797f08419f50a057973388f15753efb16134ed05370ded495d0ac08</code> 和命令行一直。</p>
<p>然后获取容器详情：</p>
<pre><code> System.out.println(client.inspectContainerCmd(&quot;2cf128f77797f08419f50a057973388f15753efb16134ed05370ded495d0ac08&quot;).exec());
</code></pre>
<p>获取容器统计信息：</p>
<pre><code>        System.out.println(client.statsCmd(&quot;2cf128f77797f08419f50a057973388f15753efb16134ed05370ded495d0ac08&quot;).exec(new InvocationBuilder.AsyncResultCallback&lt;&gt;()).awaitResult());
</code></pre>
<p>对应的结果：</p>
<pre><code>InspectContainerResponse[args=&#123;mysqld&#125;,config=com.github.dockerjava.api.model.ContainerConfig@3e15bb06[attachStderr=false,attachStdin=false,attachStdout=false,cmd=&#123;mysqld&#125;,domainName=,entrypoint=&#123;docker-entrypoint.sh&#125;,env=&#123;MYSQL_ROOT_PASSWORD=aimind@mysql2019&quot;,PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin,GOSU_VERSION=1.7,MYSQL_MAJOR=8.0,MYSQL_VERSION=8.0.17-1debian9&#125;,exposedPorts=com.github.dockerjava.api.model.ExposedPorts@6778aea6,hostName=2cf128f77797,image=mysql:latest@sha256:01cf53f2538aa805bda591d83f107c394adca8d31f98eacd3654e282dada3193,labels=&#123;com.docker.swarm.node.id=sixp62dhqe702b69pm6v8m9rh, com.docker.swarm.service.id=uporil7xf4rwffa0rhg1j5htw, com.docker.swarm.service.name=mysql, com.docker.swarm.task=, com.docker.swarm.task.id=lvskmv1lkhz6bvynfuxa0jqgn, com.docker.swarm.task.name=mysql.1.lvskmv1lkhz6bvynfuxa0jqgn&#125;,macAddress=&lt;null&gt;,networkDisabled=&lt;null&gt;,onBuild=&lt;null&gt;,stdinOpen=false,portSpecs=&lt;null&gt;,stdInOnce=false,tty=false,user=,volumes=&#123;/var/lib/mysql=&#123;&#125;&#125;,workingDir=,healthCheck=&lt;null&gt;],created=2019-08-30T08:09:41.827551223Z,driver=overlay2,execDriver=&lt;null&gt;,hostConfig=com.github.dockerjava.api.model.HostConfig@5853495b[binds=&lt;null&gt;,blkioWeight=0,blkioWeightDevice=&lt;null&gt;,blkioDeviceReadBps=&lt;null&gt;,blkioDeviceWriteBps=&lt;null&gt;,blkioDeviceReadIOps=&lt;null&gt;,blkioDeviceWriteIOps=&lt;null&gt;,memorySwappiness=&lt;null&gt;,nanoCPUs=&lt;null&gt;,capAdd=&lt;null&gt;,capDrop=&lt;null&gt;,containerIDFile=,cpuPeriod=0,cpuRealtimePeriod=0,cpuRealtimeRuntime=0,cpuShares=0,cpuQuota=0,cpusetCpus=,cpusetMems=,devices=&lt;null&gt;,deviceCgroupRules=&lt;null&gt;,diskQuota=0,dns=&lt;null&gt;,dnsOptions=&lt;null&gt;,dnsSearch=&lt;null&gt;,extraHosts=&lt;null&gt;,groupAdd=&lt;null&gt;,ipcMode=shareable,cgroup=,links=&lt;null&gt;,logConfig=com.github.dockerjava.api.model.LogConfig@524a2ffb,lxcConf=&lt;null&gt;,memory=0,memorySwap=0,memoryReservation=0,kernelMemory=0,networkMode=default,oomKillDisable=false,init=&lt;null&gt;,autoRemove=false,oomScoreAdj=0,portBindings=&#123;&#125;,privileged=false,publishAllPorts=false,readonlyRootfs=false,restartPolicy=no,ulimits=&lt;null&gt;,cpuCount=0,cpuPercent=0,ioMaximumIOps=0,ioMaximumBandwidth=0,volumesFrom=&lt;null&gt;,mounts=&lt;null&gt;,pidMode=,isolation=default,securityOpts=&lt;null&gt;,storageOpt=&lt;null&gt;,cgroupParent=,volumeDriver=,shmSize=67108864,pidsLimit=0,runtime=runc,tmpFs=&lt;null&gt;,utSMode=,usernsMode=,sysctls=&lt;null&gt;,consoleSize=[0, 0]],hostnamePath=/data/docker/containers/2cf128f77797f08419f50a057973388f15753efb16134ed05370ded495d0ac08/hostname,hostsPath=/data/docker/containers/2cf128f77797f08419f50a057973388f15753efb16134ed05370ded495d0ac08/hosts,logPath=/data/docker/containers/2cf128f77797f08419f50a057973388f15753efb16134ed05370ded495d0ac08/2cf128f77797f08419f50a057973388f15753efb16134ed05370ded495d0ac08-json.log,id=2cf128f77797f08419f50a057973388f15753efb16134ed05370ded495d0ac08,sizeRootFs=&lt;null&gt;,imageId=sha256:62a9f311b99c24c0fde0a772abc6030bc48e5acc7d7416b8eeb72d3da1b4eb6c,mountLabel=,name=/mysql.1.lvskmv1lkhz6bvynfuxa0jqgn,restartCount=0,networkSettings=com.github.dockerjava.api.model.NetworkSettings@7173ae5b[bridge=,sandboxId=459ab4b83580513da251182d08dc217d0079613d10952df00ffcca6e2537958b,hairpinMode=false,linkLocalIPv6Address=,linkLocalIPv6PrefixLen=0,ports=&#123;3306/tcp=null, 33060/tcp=null&#125;,sandboxKey=/var/run/docker/netns/459ab4b83580,secondaryIPAddresses=&lt;null&gt;,secondaryIPv6Addresses=&lt;null&gt;,endpointID=,gateway=,portMapping=&lt;null&gt;,globalIPv6Address=,globalIPv6PrefixLen=0,ipAddress=,ipPrefixLen=0,ipV6Gateway=,macAddress=,networks=&#123;aimind-overlay=com.github.dockerjava.api.model.ContainerNetwork@53a9fcfd[ipamConfig=com.github.dockerjava.api.model.ContainerNetwork$Ipam@21f459fc,links=&lt;null&gt;,aliases=[2cf128f77797],networkID=emypqxzjggws7uicersyz6uag,endpointId=56a78b2527a6dcf83fd3dc2794c514aaa325457d9c8a21bd236d3ea3c22c8fa9,gateway=,ipAddress=10.0.0.4,ipPrefixLen=24,ipV6Gateway=,globalIPv6Address=,globalIPv6PrefixLen=0,macAddress=02:42:0a:00:00:04]&#125;],path=docker-entrypoint.sh,processLabel=,resolvConfPath=/data/docker/containers/2cf128f77797f08419f50a057973388f15753efb16134ed05370ded495d0ac08/resolv.conf,execIds=&lt;null&gt;,state=com.github.dockerjava.api.command.InspectContainerResponse$ContainerState@4d192aef[status=running,running=true,paused=false,restarting=false,oomKilled=false,dead=false,pid=14884,exitCode=0,error=,startedAt=2019-08-30T08:09:43.402630785Z,finishedAt=0001-01-01T00:00:00Z,health=&lt;null&gt;],volumes=&lt;null&gt;,volumesRW=&lt;null&gt;,node=&lt;null&gt;,mounts=[com.github.dockerjava.api.command.InspectContainerResponse$Mount@1416cf9f[name=c2128d05001b8fec1712807f381e2c72d42ce8a83ae97f6b038f51c0d48446f1,source=/data/docker/volumes/c2128d05001b8fec1712807f381e2c72d42ce8a83ae97f6b038f51c0d48446f1/_data,destination=/var/lib/mysql,driver=local,mode=,rw=true]],graphDriver=com.github.dockerjava.api.command.GraphDriver@84487f4[name=overlay2,data=com.github.dockerjava.api.command.GraphData@bfc14b9[rootDir=&lt;null&gt;,deviceId=&lt;null&gt;,deviceName=&lt;null&gt;,deviceSize=&lt;null&gt;,dir=&lt;null&gt;]],platform=linux]
Disconnected from the target VM, address: &#39;127.0.0.1:60730&#39;, transport: &#39;socket&#39;
com.github.dockerjava.api.model.Statistics@55a88417[read=2019-09-02T12:20:14.534216408Z,networks=&#123;eth0=com.github.dockerjava.api.model.StatisticNetworksConfig@18acfe88[rxBytes=0,rxDropped=0,rxErrors=0,rxPackets=0,txBytes=0,txDropped=0,txErrors=0,txPackets=0], eth1=com.github.dockerjava.api.model.StatisticNetworksConfig@8a2a6a[rxBytes=197752,rxDropped=0,rxErrors=0,rxPackets=836,txBytes=0,txDropped=0,txErrors=0,txPackets=0]&#125;,network=&lt;null&gt;,memoryStats=com.github.dockerjava.api.model.MemoryStatsConfig@772861aa,blkioStats=BlkioStatsConfig[ioServiceBytesRecursive=[BlkioStatEntry[major=8,minor=0,op=Read,value=8192], BlkioStatEntry[major=8,minor=0,op=Write,value=1259921408], BlkioStatEntry[major=8,minor=0,op=Sync,value=1258987520], BlkioStatEntry[major=8,minor=0,op=Async,value=942080], BlkioStatEntry[major=8,minor=0,op=Total,value=1259929600]],ioServicedRecursive=[BlkioStatEntry[major=8,minor=0,op=Read,value=2], BlkioStatEntry[major=8,minor=0,op=Write,value=4066], BlkioStatEntry[major=8,minor=0,op=Sync,value=4009], BlkioStatEntry[major=8,minor=0,op=Async,value=59], BlkioStatEntry[major=8,minor=0,op=Total,value=4068]],ioQueueRecursive=[],ioServiceTimeRecursive=[],ioWaitTimeRecursive=[],ioMergedRecursive=[],ioTimeRecursive=[],sectorsRecursive=[]],cpuStats=com.github.dockerjava.api.model.CpuStatsConfig@4cb40e3b,preCpuStats=com.github.dockerjava.api.model.CpuStatsConfig@41b1f51e,pidsStats=com.github.dockerjava.api.model.PidsStatsConfig@3a543f31]
</code></pre>
<hr>
<blockquote>
<p>作者：Jadepeng<br> 出处：jqpeng的技术记事本–<a target="_blank" rel="noopener" href="http://www.cnblogs.com/xiaoqi">http://www.cnblogs.com/xiaoqi</a><br> 您的支持是对博主最大的鼓励，感谢您的认真阅读。<br> 本文版权归作者所有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文连接，否则保留追究法律责任的权利。</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.iflyresearch.com/2019/08/26/jqpeng-XNginx%E5%8D%87%E7%BA%A7%E8%AE%B0%E5%BD%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/jadepeng/images/avatar.gif">
      <meta itemprop="name" content="JadePeng">
      <meta itemprop="description" content="JadePeng的技术笔记本">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JadePeng的技术笔记本">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/jadepeng/2019/08/26/jqpeng-XNginx%E5%8D%87%E7%BA%A7%E8%AE%B0%E5%BD%95/" class="post-title-link" itemprop="url">XNginx升级记录</a>
        </h2>

        <div class="post-meta">

         
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-08-26 19:30:00" itemprop="dateCreated datePublished" datetime="2019-08-26T19:30:00+08:00">2019-08-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 18:09:47" itemprop="dateModified" datetime="2021-05-14T18:09:47+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/jadepeng/categories/%E5%8D%9A%E5%AE%A2/" itemprop="url" rel="index"><span itemprop="name">博客</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/jadepeng/categories/%E5%8D%9A%E5%AE%A2/jqpeng/" itemprop="url" rel="index"><span itemprop="name">jqpeng</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>4.7k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>文章作者:jqpeng<br>原文链接: <a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaoqi/p/xnginx-v-1-1.html">XNginx升级记录</a></p>
<p>之前的博文提到过，<a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaoqi/p/xnginx.html">XNginx - nginx 集群可视化管理工具</a>, 开发完成后一直稳定运行，直到前面因为一个站点的proxy站点配置问题，导致需要修改nginx 配置文件模板，因此借此机会对系统做了升级。</p>
<h2 id="前端升级到最新版的ng-alain"><a href="#前端升级到最新版的ng-alain" class="headerlink" title="前端升级到最新版的ng-alain"></a>前端升级到最新版的ng-alain</h2><p>事实证明，升级是痛苦的，前端项目真是一言难尽，能不动最好不动！</p>
<p>主要的变更是：  </p>
<ul>
<li>之前的simple-table变成了st  </li>
<li>desc也没了，成了sv，  </li>
<li>page-header等的action也需要显示的指定</li>
</ul>
<p>查查文档，前后花了一个多小时，前端的升级真是太快了。。。</p>
<h2 id="vhost增加default"><a href="#vhost增加default" class="headerlink" title="vhost增加default"></a>vhost增加default</h2><p>通常会有类似下面的配置存在，通过default来标示是默认的配置：</p>
<pre><code>  server &#123;
        listen 80 default;
        client_max_body_size 10240M;
      
        location / &#123;
        
        proxy_pass http://proxy234648622.k8s_server;
            proxy_set_header HOST $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                            
      &#125;          
   &#125;
</code></pre>
<p>因此，这次给vhost增加了default选项，这样生成配置文件就可以加上default。</p>
<p><img src="https://gitee.com/jadepeng/pic/raw/master/pic/2019/8/26/1566817603353.png" alt="default"></p>
<p>生成的配置文件：</p>
<p><img src="https://gitee.com/jadepeng/pic/raw/master/pic/2019/8/26/1566817664946.png" alt="配置文件"></p>
<h2 id="SSL配置增加导入证书"><a href="#SSL配置增加导入证书" class="headerlink" title="SSL配置增加导入证书"></a>SSL配置增加导入证书</h2><p>之前SSL配置需要手动打开证书文件，拷贝文件内容到文本框，这次前端升级，增加了导入按钮，用户选择后直接读取证书文件.</p>
<p>实现很简单，使用<code>nz-upload</code>上传文件，通过<code>nzBeforeUpload</code>进行拦截，读取文件。</p>
<pre><code> &lt;div nz-col [nzSpan]=&quot;2&quot; *ngIf=&quot;dto.enableSSL&quot;&gt;
        &lt;nz-upload nzShowUploadList=&quot;false&quot; [nzBeforeUpload]=&quot;readCertificate&quot;&gt;&lt;button nz-icon=&quot;upload&quot; nz-button
            nzType=&quot;nz-button.default&quot; nzSize=&quot;small&quot;&gt;导入&lt;/button&gt; &lt;/nz-upload&gt;
      &lt;/div&gt;  
</code></pre>
<p>读取可以使用FileReader，记得return false。</p>
<pre><code>  readCertificate = (file: File) =&gt; &#123;
    const reader = new FileReader();
    reader.readAsText(file);
    this.dto.sslCertificate.commonName = file.name;
    reader.onload = () =&gt; &#123;
      this.dto.sslCertificate.content = reader.result.toString();
    &#125;
    return false;
  &#125;
</code></pre>
<h2 id="导入已有配置文件"><a href="#导入已有配置文件" class="headerlink" title="导入已有配置文件"></a>导入已有配置文件</h2><p>本次升级，在vhosts管理地方，增加了一个导入按钮，可以导入配置信息。</p>
<p><img src="https://gitee.com/jadepeng/pic/raw/master/pic/2019/8/26/1566818042877.png" alt="导入"></p>
<p>支持的方式是要求将配置文件及其相关资源，打包为zip，上传到系统后台进行解析, 接口代码：</p>
<pre><code>@PostMapping(&quot;/importConfig/&#123;groupId&#125;&quot;)
    @Timed
    public String uploadConfFile(@RequestParam(&quot;file&quot;) MultipartFile file, @PathVariable String groupId) &#123;
        if (file.isEmpty()) &#123;
            return &quot;Please select a file to upload&quot;;
        &#125;

        if (!file.getContentType().equalsIgnoreCase(&quot;application/x-zip-compressed&quot;)) &#123;
            return &quot;only support.zip&quot;;
        &#125;

        File upFile = new File(new File(TEMP_FILE_PATH),  System.currentTimeMillis() + file.getOriginalFilename());
        try &#123;
            if(upFile.exists())&#123;
                upFile.delete();
            &#125;
            file.transferTo(upFile);
        &#125; catch (IllegalStateException | IOException ex) &#123;
            return &quot;upload error！&quot;;
        &#125;

        try &#123;
            nginxConfigService.parseFromZipFile(upFile, groupId);
        &#125; catch (IOException e) &#123;
            return &quot;upload error！&quot;;
        &#125;
        return &quot;success&quot;;
    &#125;
</code></pre>
<p>解析代码比较简单，先解压zip，然后找到nginx.conf，再调用上文提到的解析代码解析指令。</p>
<pre><code> public void parseConfig(String confidDir, String groupId) &#123;

        // 查找nginx.conf
        String nginxFile = searchForFile(new File(confidDir), &quot;nginx.conf&quot;);
        if (nginxFile.length() == 0) &#123;
            throw new RuntimeException(&quot;can&#39;t find nginx.conf,please make sure nginx.conf exist !&quot;);
        &#125;

        List&lt;Directive&gt; directives = NginxConfParser.newBuilder().withConfigurationFile(nginxFile).parse();
        directives.stream().forEach(directive -&gt; &#123;
            if (directive instanceof ProxyDirective) &#123;
                saveUpStream((ProxyDirective) directive);
            &#125; else if (directive instanceof VirtualHostDirective) &#123;
                saveVHost((VirtualHostDirective) directive, groupId);
            &#125;
        &#125;);

    &#125;

    public void parseFromZipFile(File file, String groupId) throws IOException &#123;
        String tempDir = Paths.get(file.getPath()).getParent().toString() + File.separator + file.getName() + &quot;.extract&quot;;
        UnZipFile.unZipFiles(file, tempDir);
        parseConfig(tempDir, groupId);
    &#125;
</code></pre>
<h2 id="前后端项目合并到一起"><a href="#前后端项目合并到一起" class="headerlink" title="前后端项目合并到一起"></a>前后端项目合并到一起</h2><p>之前前后端独立部署，如果项目足够大尚可，但是这个xnginx相对比较简单，独立部署费时费力，因此本次将前后端合并到一起</p>
<p>合并方法：</p>
<ul>
<li>在backend新建一个webapp目录，将web代码放入</li>
<li>将web的相关配置文件拷贝到上层目录</li>
</ul>
<p><img src="https://gitee.com/jadepeng/pic/raw/master/pic/2019/8/26/1566818538910.png" alt="目录结构"></p>
<p>然后修改<code>angular.json</code>、<code>tsconfig.json</code> 等包含路径的地址进行修改</p>
<pre><code> &quot;xnginx&quot;: &#123;
      &quot;projectType&quot;: &quot;application&quot;,
      &quot;root&quot;: &quot;&quot;,
      &quot;sourceRoot&quot;: &quot;webapp/src&quot;,
      &quot;prefix&quot;: &quot;app&quot;,
      &quot;schematics&quot;: &#123;
        &quot;@schematics/angular:component&quot;: &#123;
          &quot;styleext&quot;: &quot;less&quot;
        &#125;
      &#125;,
</code></pre>
<p>最后，修改angular.json的build配置，将构建结果保存到’target/classes/static’,这样java项目打包时就能将前端资源带入：</p>
<pre><code>  &quot;build&quot;: &#123;
          &quot;builder&quot;: &quot;@angular-devkit/build-angular:browser&quot;,
          &quot;options&quot;: &#123;
            &quot;outputPath&quot;: &quot;target/classes/static&quot;,
            &quot;index&quot;: &quot;webapp/src/index.html&quot;,
            &quot;main&quot;: &quot;webapp/src/main.ts&quot;,
            &quot;tsConfig&quot;: &quot;tsconfig.app.json&quot;,
            &quot;polyfills&quot;: &quot;webapp/src/polyfills.ts&quot;,
            &quot;assets&quot;: [
              &quot;webapp/src/assets&quot;,
              &quot;webapp/src/favicon.ico&quot;
            ],
            &quot;styles&quot;: [
              &quot;webapp/src/styles.less&quot;
            ],
            &quot;scripts&quot;: [
              &quot;node_modules/@antv/g2/build/g2.js&quot;,
              &quot;node_modules/@antv/data-set/dist/data-set.min.js&quot;,
              &quot;node_modules/@antv/g2-plugin-slider/dist/g2-plugin-slider.min.js&quot;,
              &quot;node_modules/ajv/dist/ajv.bundle.js&quot;,
              &quot;node_modules/qrious/dist/qrious.min.js&quot;
            ]
          &#125;,
</code></pre>
<p>注意事项：</p>
<ul>
<li>先构建前端，<code>npm run build</code></li>
<li>再构建后端 <code>mvn package -DskipTests</code></li>
</ul>
<hr>
<blockquote>
<p>作者：Jadepeng<br> 出处：jqpeng的技术记事本–<a target="_blank" rel="noopener" href="http://www.cnblogs.com/xiaoqi">http://www.cnblogs.com/xiaoqi</a><br> 您的支持是对博主最大的鼓励，感谢您的认真阅读。<br> 本文版权归作者所有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文连接，否则保留追究法律责任的权利。</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.iflyresearch.com/2019/08/23/jqpeng-sparql%20%20%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/jadepeng/images/avatar.gif">
      <meta itemprop="name" content="JadePeng">
      <meta itemprop="description" content="JadePeng的技术笔记本">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JadePeng的技术笔记本">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/jadepeng/2019/08/23/jqpeng-sparql%20%20%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/" class="post-title-link" itemprop="url">sparql  查询语句快速入门</a>
        </h2>

        <div class="post-meta">

         
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-08-23 15:00:00" itemprop="dateCreated datePublished" datetime="2019-08-23T15:00:00+08:00">2019-08-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 18:09:47" itemprop="dateModified" datetime="2021-05-14T18:09:47+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/jadepeng/categories/%E5%8D%9A%E5%AE%A2/" itemprop="url" rel="index"><span itemprop="name">博客</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/jadepeng/categories/%E5%8D%9A%E5%AE%A2/jqpeng/" itemprop="url" rel="index"><span itemprop="name">jqpeng</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>4.5k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>文章作者:jqpeng<br>原文链接: <a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaoqi/p/sparql.html">sparql  查询语句快速入门</a></p>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><blockquote>
<p>RDF is a directed, labeled graph data format for representing information in the Web. RDF is often used to represent, among other things, personal information, social networks, metadata about digital artifacts, as well as to provide a means of integration over disparate sources of information. This specification defines the syntax and semantics of the SPARQL query language for RDF.<br> The SPARQL query language for RDF is designed to meet the use cases and requirements identified by the RDF Data Access Working Group in RDF Data Access Use Cases and Requirements [UCNR].</p>
</blockquote>
<p>SPARQL即SPARQL Protocol and RDF Query Language的递归缩写，被专门设计用来访问和操作RDF数据，是语义网的核心技术之一。W3C的RDF数据存取小组（RDF Data Access Working Group, RDAWG）对其进行了标准化。2008年1月15日，SPARQL正式成为一项W3C推荐标准。</p>
<p>我们可以将抽取的RDF三元组导入Apache Jena Fuseki，通过SPARQL进行查询：</p>
<p><img src="https://gitee.com/jadepeng/pic/raw/master/pic/2019/8/23/1566543446161.png" alt="SParql demo"></p>
<h2 id="简单查询"><a href="#简单查询" class="headerlink" title="简单查询"></a>简单查询</h2><table>
<thead>
<tr>
<th>SQL</th>
<th>sparql</th>
</tr>
</thead>
<tbody><tr>
<td>SELECT title from book where id=’book1’</td>
<td>SELECT ?title    <br>WHERE   <br>{ &lt;<a target="_blank" rel="noopener" href="http://example.org/book/book1">http://example.org/book/book1</a>&gt; &lt;<a target="_blank" rel="noopener" href="http://purl.org/dc/elements/1.1/title">http://purl.org/dc/elements/1.1/title</a>&gt; ?title .   <br> }</td>
</tr>
</tbody></table>
<p>Query Result:</p>
<table>
<thead>
<tr>
<th>title</th>
</tr>
</thead>
<tbody><tr>
<td>“SPARQL Tutorial”</td>
</tr>
</tbody></table>
<h2 id="多字段匹配"><a href="#多字段匹配" class="headerlink" title="多字段匹配"></a>多字段匹配</h2><p>RDF 数据</p>
<pre><code>@prefix foaf:  &lt;http://xmlns.com/foaf/0.1/&gt; .

_:a  foaf:name   &quot;Johnny Lee Outlaw&quot; .
_:a  foaf:mbox   &lt;mailto:jlow@example.com&gt; .
_:b  foaf:name   &quot;Peter Goodguy&quot; .
_:b  foaf:mbox   &lt;mailto:peter@example.org&gt; .
_:c  foaf:mbox   &lt;mailto:carol@example.org&gt; .
</code></pre>
<p>sparql:</p>
<pre><code>PREFIX foaf:   &lt;http://xmlns.com/foaf/0.1/&gt;
SELECT ?name ?mbox
WHERE
  &#123; ?x foaf:name ?name .
    ?x foaf:mbox ?mbox &#125;
</code></pre>
<p>SQL:</p>
<pre><code>SELECT ?name ?mbox
from foaf
</code></pre>
<p>查询结果:</p>
<table>
<thead>
<tr>
<th>name</th>
<th>mbox</th>
</tr>
</thead>
<tbody><tr>
<td>“Johnny Lee Outlaw”</td>
<td><a href="mailto:jlow@example.com">mailto:jlow@example.com</a></td>
</tr>
<tr>
<td>“Peter Goodguy”</td>
<td><a href="mailto:peter@example.org">mailto:peter@example.org</a></td>
</tr>
</tbody></table>
<h2 id="数据属性匹配"><a href="#数据属性匹配" class="headerlink" title="数据属性匹配"></a>数据属性匹配</h2><p>对于string类型，需要用双引号包裹起来。</p>
<p>sparql:</p>
<pre><code>SELECT ?v WHERE &#123; ?v ?p &quot;cat&quot; &#125;
</code></pre>
<p>SQL:</p>
<pre><code>SELECT *
from ns
where p=&#39;cat&#39;
</code></pre>
<p>对于数字类型：</p>
<p>sparql:</p>
<pre><code>SELECT ?v WHERE &#123; ?v ?p 42 &#125;
</code></pre>
<p>SQL:</p>
<pre><code>SELECT * from ns where p= 42
</code></pre>
<p>另外，在spaql里可以指定匹配的类型：</p>
<pre><code>SELECT ?v WHERE &#123; ?v ?p &quot;abc&quot;^^&lt;http://example.org/datatype#specialDatatype&gt; &#125;
</code></pre>
<h2 id="条件过滤"><a href="#条件过滤" class="headerlink" title="条件过滤"></a>条件过滤</h2><h3 id="模糊匹配"><a href="#模糊匹配" class="headerlink" title="模糊匹配"></a>模糊匹配</h3><p>通过<code>regex</code>函数可以进行字符串正则匹配，通过<code>FILTER</code>进行过滤</p>
<pre><code>PREFIX  dc:  &lt;http://purl.org/dc/elements/1.1/&gt;
SELECT  ?title
WHERE   &#123; ?x dc:title ?title
          FILTER regex(?title, &quot;web&quot;, &quot;i&quot; ) 
        &#125;
</code></pre>
<p>SQL:</p>
<pre><code>SELECT * from table where title like &#39;%web%&#39;
</code></pre>
<h3 id="数字比较"><a href="#数字比较" class="headerlink" title="数字比较"></a>数字比较</h3><pre><code>PREFIX  dc:  &lt;http://purl.org/dc/elements/1.1/&gt;
PREFIX  ns:  &lt;http://example.org/ns#&gt;
SELECT  ?title ?price
WHERE   &#123; ?x ns:price ?price .
          FILTER (?price &lt; 30.5)
          ?x dc:title ?title . &#125;
</code></pre>
<p>SQL:</p>
<pre><code>SELECT title,price from table where price &lt;30.5
</code></pre>
<h2 id="OPTIONAL（可选值）"><a href="#OPTIONAL（可选值）" class="headerlink" title="OPTIONAL（可选值）"></a>OPTIONAL（可选值）</h2><p>RDF 数据，用户Bob没有mbox，而用户Alice有两个mbox</p>
<pre><code>@prefix foaf:       &lt;http://xmlns.com/foaf/0.1/&gt; .
@prefix rdf:        &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#&gt; .

_:a  rdf:type        foaf:Person .
_:a  foaf:name       &quot;Alice&quot; .
_:a  foaf:mbox       &lt;mailto:alice@example.com&gt; .
_:a  foaf:mbox       &lt;mailto:alice@work.example&gt; .

_:b  rdf:type        foaf:Person .
_:b  foaf:name       &quot;Bob&quot; .
</code></pre>
<p>正常查询，因为Bob没有mbox，所以查询不出来，可以通过<code>OPTIONAL</code>标记mbox为可选，这样Bob就可以查询出来。</p>
<p>sparql:</p>
<pre><code>PREFIX foaf: &lt;http://xmlns.com/foaf/0.1/&gt;
SELECT ?name ?mbox
WHERE  &#123; ?x foaf:name  ?name .
         OPTIONAL &#123; ?x  foaf:mbox  ?mbox &#125;
       &#125;
</code></pre>
<p>查询结果</p>
<table>
<thead>
<tr>
<th>name</th>
<th>mbox</th>
</tr>
</thead>
<tbody><tr>
<td>“Alice”</td>
<td><a href="mailto:alice@example.com">mailto:alice@example.com</a></td>
</tr>
<tr>
<td>“Alice”</td>
<td><a href="mailto:alice@work.example">mailto:alice@work.example</a></td>
</tr>
<tr>
<td>“Bob”</td>
<td></td>
</tr>
</tbody></table>
<p>可以看到， <code>&quot;Bob&quot;</code>的 <code>mbox</code>是空值。</p>
<p>对于关系型数据库，可以假设两个表</p>
<p>User { id,name}<br> Mbox {id,uid,name} (uid为外键）</p>
<p>对应的sql：</p>
<pre><code>SELECT user.name AS name,mbox.name AS mboxName
FROM User user
LEFT OUTER JOIN Mbox mbox ON mbox.uid=user.id
</code></pre>
<h2 id="OPTIONAL-FILTER"><a href="#OPTIONAL-FILTER" class="headerlink" title="OPTIONAL + FILTER"></a>OPTIONAL + FILTER</h2><p>OPTIONAL 可以和FILTER 组合使用</p>
<pre><code>PREFIX  dc:  &lt;http://purl.org/dc/elements/1.1/&gt;
PREFIX  ns:  &lt;http://example.org/ns#&gt;
SELECT  ?title ?price
WHERE   &#123; ?x dc:title ?title .
          OPTIONAL &#123; ?x ns:price ?price . FILTER (?price &lt; 30) &#125;
        &#125;        
</code></pre>
<h2 id="UNION"><a href="#UNION" class="headerlink" title="UNION"></a>UNION</h2><p>Data:</p>
<pre><code>@prefix dc10:  &lt;http://purl.org/dc/elements/1.0/&gt; .
@prefix dc11:  &lt;http://purl.org/dc/elements/1.1/&gt; .

_:a  dc10:title     &quot;SPARQL Query Language Tutorial&quot; .
_:a  dc10:creator   &quot;Alice&quot; .

_:b  dc11:title     &quot;SPARQL Protocol Tutorial&quot; .
_:b  dc11:creator   &quot;Bob&quot; .

_:c  dc10:title     &quot;SPARQL&quot; .
_:c  dc11:title     &quot;SPARQL (updated)&quot; 
</code></pre>
<p>查询:</p>
<pre><code>PREFIX dc10:  &lt;http://purl.org/dc/elements/1.0/&gt;
PREFIX dc11:  &lt;http://purl.org/dc/elements/1.1/&gt;

SELECT ?title
WHERE  &#123; &#123; ?book dc10:title  ?title &#125; UNION &#123; ?book dc11:title  ?title &#125; &#125;
</code></pre>
<p>Query result:</p>
<pre><code>title
&quot;SPARQL Protocol Tutorial&quot;
&quot;SPARQL&quot;
&quot;SPARQL (updated)&quot;
&quot;SPARQL Query Language Tutorial&quot;
</code></pre>
<h2 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h2><p>和sql一样，使用ORDER BY 排序，示例如下：</p>
<pre><code>PREFIX foaf:    &lt;http://xmlns.com/foaf/0.1/&gt;

SELECT ?name
WHERE &#123; ?x foaf:name ?name ; :empId ?emp &#125;
ORDER BY ?name DESC(?emp)
</code></pre>
<h2 id="去重"><a href="#去重" class="headerlink" title="去重"></a>去重</h2><p>和sql一样，使用DISTINCT来去重，示例如下：</p>
<pre><code>PREFIX foaf:    &lt;http://xmlns.com/foaf/0.1/&gt;
SELECT DISTINCT ?name WHERE &#123; ?x foaf:name ?name &#125;
</code></pre>
<h2 id="判断是否存在"><a href="#判断是否存在" class="headerlink" title="判断是否存在"></a>判断是否存在</h2><p>使用ask来判断是否有解决方案</p>
<pre><code>PREFIX foaf:    &lt;http://xmlns.com/foaf/0.1/&gt;
ASK  &#123; ?x foaf:name  &quot;Alice&quot; ;
          foaf:mbox  &lt;mailto:alice@work.example&gt; &#125;
</code></pre>
<hr>
<blockquote>
<p>作者：Jadepeng<br> 出处：jqpeng的技术记事本–<a target="_blank" rel="noopener" href="http://www.cnblogs.com/xiaoqi">http://www.cnblogs.com/xiaoqi</a><br> 您的支持是对博主最大的鼓励，感谢您的认真阅读。<br> 本文版权归作者所有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文连接，否则保留追究法律责任的权利。</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.iflyresearch.com/2019/08/08/jqpeng-Docker%E5%90%AF%E7%94%A8TLS%E8%BF%9B%E8%A1%8C%E5%AE%89%E5%85%A8%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/jadepeng/images/avatar.gif">
      <meta itemprop="name" content="JadePeng">
      <meta itemprop="description" content="JadePeng的技术笔记本">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JadePeng的技术笔记本">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/jadepeng/2019/08/08/jqpeng-Docker%E5%90%AF%E7%94%A8TLS%E8%BF%9B%E8%A1%8C%E5%AE%89%E5%85%A8%E9%85%8D%E7%BD%AE/" class="post-title-link" itemprop="url">Docker启用TLS进行安全配置</a>
        </h2>

        <div class="post-meta">

         
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-08-08 20:08:00" itemprop="dateCreated datePublished" datetime="2019-08-08T20:08:00+08:00">2019-08-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 18:09:47" itemprop="dateModified" datetime="2021-05-14T18:09:47+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/jadepeng/categories/%E5%8D%9A%E5%AE%A2/" itemprop="url" rel="index"><span itemprop="name">博客</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/jadepeng/categories/%E5%8D%9A%E5%AE%A2/jqpeng/" itemprop="url" rel="index"><span itemprop="name">jqpeng</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>4.2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>文章作者:jqpeng<br>原文链接: <a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaoqi/p/docker-tls.html">Docker启用TLS进行安全配置</a></p>
<p>之前开启了docker的2375 Remote API，接到公司安全部门的要求，需要启用授权，翻了下官方文档</p>
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/security/https/">Protect the Docker daemon socket</a></p>
<h2 id="启用TLS"><a href="#启用TLS" class="headerlink" title="启用TLS"></a>启用TLS</h2><p>在docker服务器，生成CA私有和公共密钥</p>
<pre><code>$ openssl genrsa -aes256 -out ca-key.pem 4096
Generating RSA private key, 4096 bit long modulus
............................................................................................................................................................................................++
........++
e is 65537 (0x10001)
Enter pass phrase for ca-key.pem:
Verifying - Enter pass phrase for ca-key.pem:

$ openssl req -new -x509 -days 365 -key ca-key.pem -sha256 -out ca.pem
Enter pass phrase for ca-key.pem:
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter &#39;.&#39;, the field will be left blank.
-----
Country Name (2 letter code) [AU]:
State or Province Name (full name) [Some-State]:Queensland
Locality Name (eg, city) []:Brisbane
Organization Name (eg, company) [Internet Widgits Pty Ltd]:Docker Inc
Organizational Unit Name (eg, section) []:Sales
Common Name (e.g. server FQDN or YOUR name) []:$HOST
Email Address []:Sven@home.org.au
</code></pre>
<p>有了CA后，可以创建一个服务器密钥和证书签名请求(CSR)</p>
<blockquote>
<p>$HOST 是你的服务器ip</p>
</blockquote>
<pre><code>$ openssl genrsa -out server-key.pem 4096
Generating RSA private key, 4096 bit long modulus
.....................................................................++
.................................................................................................++
e is 65537 (0x10001)

$ openssl req -subj &quot;/CN=$HOST&quot; -sha256 -new -key server-key.pem -out server.csr
</code></pre>
<p>接着，用CA来签署公共密钥:</p>
<pre><code>$ echo subjectAltName = DNS:$HOST,IP:$HOST:127.0.0.1 &gt;&gt; extfile.cnf

 $ echo extendedKeyUsage = serverAuth &gt;&gt; extfile.cnf
 
</code></pre>
<p>生成key：</p>
<pre><code>$ openssl x509 -req -days 365 -sha256 -in server.csr -CA ca.pem -CAkey ca-key.pem \
  -CAcreateserial -out server-cert.pem -extfile extfile.cnf
Signature ok
subject=/CN=your.host.com
Getting CA Private Key
Enter pass phrase for ca-key.pem:
</code></pre>
<p>创建客户端密钥和证书签名请求:</p>
<pre><code>$ openssl genrsa -out key.pem 4096
Generating RSA private key, 4096 bit long modulus
.........................................................++
................++
e is 65537 (0x10001)

$ openssl req -subj &#39;/CN=client&#39; -new -key key.pem -out client.csr
</code></pre>
<p>修改<code>extfile.cnf</code>：</p>
<pre><code>echo extendedKeyUsage = clientAuth &gt; extfile-client.cnf
</code></pre>
<p>生成签名私钥：</p>
<pre><code>$ openssl x509 -req -days 365 -sha256 -in client.csr -CA ca.pem -CAkey ca-key.pem \
  -CAcreateserial -out cert.pem -extfile extfile-client.cnf
Signature ok
subject=/CN=client
Getting CA Private Key
Enter pass phrase for ca-key.pem:
</code></pre>
<p>将Docker服务停止，然后修改docker服务文件</p>
<pre><code>[Unit]
Description=Docker Application Container Engine
Documentation=http://docs.docker.io

[Service]
Environment=&quot;PATH=/opt/kube/bin:/bin:/sbin:/usr/bin:/usr/sbin&quot;
ExecStart=/opt/kube/bin/dockerd  --tlsverify --tlscacert=/root/docker/ca.pem --tlscert=/root/docker/server-cert.pem --tlskey=/root/docker/server-key.pem -H unix:///var/run/docker.sock -H tcp://0.0.0.0:2375
ExecStartPost=/sbin/iptables -I FORWARD -s 0.0.0.0/0 -j ACCEPT
ExecReload=/bin/kill -s HUP $MAINPID
Restart=on-failure
RestartSec=5
LimitNOFILE=infinity
LimitNPROC=infinity
LimitCORE=infinity
Delegate=yes
KillMode=process

[Install]
WantedBy=multi-user.target
</code></pre>
<p>然后重启服务</p>
<pre><code>systemctl daemon-reload
systemctl restart docker.service 



重启后查看服务状态：

systemctl status docker.service
● docker.service - Docker Application Container Engine
   Loaded: loaded (/etc/systemd/system/docker.service; enabled; vendor preset: enabled)
   Active: active (running) since Thu 2019-08-08 19:22:26 CST; 1 min ago
</code></pre>
<p>已经生效。</p>
<p>使用证书连接：</p>
<p>复制<code>ca.pem</code>,<code>cert.pem</code>,<code>key.pem</code>三个文件到客户端</p>
<p><code>docker --tlsverify --tlscacert=ca.pem --tlscert=cert.pem --tlskey=key.pem -H=$HOST:2375 version</code>连接即可</p>
<h2 id="docker-java-启用TLS"><a href="#docker-java-启用TLS" class="headerlink" title="docker-java 启用TLS"></a>docker-java 启用TLS</h2><p>项目里使用docker的java客户端<code>docker-java</code>调用docker，为了支持TLS，在创建客户端时，需要增加TLS设置。</p>
<p>首先将<code>ca.pem cert.pem key.pem </code>这三个文件拷贝到本地，例如<code>E:\\docker\\&quot;</code>,</p>
<p>然后<code>DefaultDockerClientConfig</code>里<code>withDockerTlsVerify</code>设为true，并设置<code>certpath</code>为刚拷贝的目录。</p>
<pre><code>DefaultDockerClientConfig.Builder builder =
                DefaultDockerClientConfig.createDefaultConfigBuilder()
                    .withDockerHost(&quot;tcp://&quot; + server + &quot;:2375&quot;)
                    .withApiVersion(&quot;1.30&quot;);
            if (containerConfiguration.getDockerTlsVerify()) &#123;
                builder = builder.withDockerTlsVerify(true)
                    .withDockerCertPath(&quot;E:\\docker\\&quot;);
            &#125;return  DockerClientBuilder.getInstance(builder.build()).build()        
</code></pre>
<p>大工搞定。</p>
<hr>
<blockquote>
<p>作者：Jadepeng<br> 出处：jqpeng的技术记事本–<a target="_blank" rel="noopener" href="http://www.cnblogs.com/xiaoqi">http://www.cnblogs.com/xiaoqi</a><br> 您的支持是对博主最大的鼓励，感谢您的认真阅读。<br> 本文版权归作者所有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文连接，否则保留追究法律责任的权利。</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.iflyresearch.com/2019/05/28/jqpeng-mongodb%E6%B5%B7%E9%87%8F%E6%95%B0%E6%8D%AECRUD%E4%BC%98%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/jadepeng/images/avatar.gif">
      <meta itemprop="name" content="JadePeng">
      <meta itemprop="description" content="JadePeng的技术笔记本">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JadePeng的技术笔记本">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/jadepeng/2019/05/28/jqpeng-mongodb%E6%B5%B7%E9%87%8F%E6%95%B0%E6%8D%AECRUD%E4%BC%98%E5%8C%96/" class="post-title-link" itemprop="url">mongodb海量数据CRUD优化</a>
        </h2>

        <div class="post-meta">

         
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-05-28 19:47:00" itemprop="dateCreated datePublished" datetime="2019-05-28T19:47:00+08:00">2019-05-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 18:09:47" itemprop="dateModified" datetime="2021-05-14T18:09:47+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/jadepeng/categories/%E5%8D%9A%E5%AE%A2/" itemprop="url" rel="index"><span itemprop="name">博客</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/jadepeng/categories/%E5%8D%9A%E5%AE%A2/jqpeng/" itemprop="url" rel="index"><span itemprop="name">jqpeng</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.5k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>文章作者:jqpeng<br>原文链接: <a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaoqi/p/java-mongo-crud.html">mongodb海量数据CRUD优化</a></p>
<h2 id="1-批量保存优化"><a href="#1-批量保存优化" class="headerlink" title="1. 批量保存优化"></a>1. 批量保存优化</h2><p>避免一条一条查询，采用<code>bulkWrite</code>, 基于<code>ReplaceOneModel</code>，启用<code>upsert</code>:</p>
<pre><code> public void batchSave(List&lt;?&gt; spoTriples, KgInstance kgInstance) &#123;
        MongoConverter converter = mongoTemplate.getConverter();
        List&lt;ReplaceOneModel&lt;Document&gt;&gt; bulkOperationList = spoTriples.stream()
                .map(thing -&gt; &#123;
                    org.bson.Document dbDoc = new org.bson.Document();
                    converter.write(thing, dbDoc);
                    ReplaceOneModel&lt;org.bson.Document&gt; replaceOneModel = new ReplaceOneModel(
                            Filters.eq(UNDERSCORE_ID, dbDoc.get(UNDERSCORE_ID)), 
                            dbDoc,
                            new UpdateOptions().upsert(true));
                    return replaceOneModel;
                &#125;)
                .collect(Collectors.toList());
        mongoTemplate.getCollection(getCollection(kgInstance)).bulkWrite(bulkOperationList);
    &#125;
</code></pre>
<h2 id="2-分页优化"><a href="#2-分页优化" class="headerlink" title="2. 分页优化"></a>2. 分页优化</h2><p>经常用于查询的字段，需要确保建立了索引。</p>
<p>对于包含多个键的查询，可以创建符合索引。</p>
<h3 id="2-1-避免不必要的count"><a href="#2-1-避免不必要的count" class="headerlink" title="2.1 避免不必要的count"></a>2.1 避免不必要的count</h3><p>查询时，走索引，速度并不慢，但是如果返回分页<code>Page&lt;?&gt;</code>，需要查询<code>totalcount</code>，当单表数据过大时，count会比较耗时，但是设想意向，你真的需要准确的数字吗？</p>
<p>在google、百度等搜索引擎搜索关键词时，只会给你有限的几个结果，因此，我们也不必给出准确的数字，设定一个阈值，比如1万，当我们发现总量大于1万时，返回1万，前端显示大于1万条即可。</p>
<p>原理也很鉴定啊，我们skip掉<code>MAX_PAGE_COUNT</code>，看是否还有数据，如果有就说明总量大于<code>MAX_PAGE_COUNT</code>，返回<code>MAX_PAGE_COUNT</code>即可，否则，计算真正的count。</p>
<pre><code>int MAX_PAGE_COUNT = 10000;


/**
     * 当总数大于阈值时，不再计算总数
     *
     * @param mongoTemplate
     * @param query
     * @param collectionName
     * @return
     */
    private long count(MongoTemplate mongoTemplate, Query query, String collectionName) &#123;
        query = query.with(PageRequest.of(MAX_PAGE_COUNT, 1));
        if (mongoTemplate.find(query, Thing.class, collectionName).size() &gt; 0) &#123;
            return MAX_PAGE_COUNT;
        &#125;
        return mongoTemplate.count(query, collectionName);
    &#125;
</code></pre>
<p>前端显示：</p>
<p><img src="https://www.github.com/jadepeng/blogpic/raw/master/images/2019/5-28/1559041614698.png" alt="大于10000"></p>
<h3 id="2-2-避免过多的skip"><a href="#2-2-避免过多的skip" class="headerlink" title="2.2 避免过多的skip"></a>2.2 避免过多的skip</h3><p>分页不过避免需要先跳过一些数据，这个过程是需要消耗时间的，可以通过一个小技巧避免跳过。</p>
<p>比如，显示列表时，排序为按最后修改时间倒序，每页显示100条，现在要显示第100页。<br> 按照正常的做法，需要跳过<code>99*100</code>条数据，非常大的代价。换一个角度思考，因为数据是有序的，因此第100页的数据的最后修改时间是小于第99页最小的修改时间，查询时加上这个条件，就可以直接取符合条件的前100条即可。</p>
<h2 id="3-全量导出优化"><a href="#3-全量导出优化" class="headerlink" title="3. 全量导出优化"></a>3. 全量导出优化</h2><h3 id="3-1-去掉不需要的字段"><a href="#3-1-去掉不需要的字段" class="headerlink" title="3.1 去掉不需要的字段"></a>3.1 去掉不需要的字段</h3><p>查询时，指定真正有用的字段，这样可以有效减少数据传输量，加快查询效率。<br> 例如：</p>
<pre><code>         Query query = new Query();
        query.fields().include(&quot;_id&quot;).include(&quot;name&quot;).include(&quot;hot&quot;).include(&quot;alias&quot;);
</code></pre>
<h3 id="3-2-避免使用findAll或者分页查询，改用stream"><a href="#3-2-避免使用findAll或者分页查询，改用stream" class="headerlink" title="3.2 避免使用findAll或者分页查询，改用stream"></a>3.2 避免使用findAll或者分页查询，改用stream</h3><p>全量导出有两个误区，一是直接<code>findAll</code>,当数据量过大时，很容易导致服务器<code>OutofMermory</code>，就算没有OOM，也会对服务器造成极大的负载，影响兄弟服务。另外，FindAll一次性加载数据到内存，整个速度也会比较慢，需要等待所有数据进入内存后才能开始处理。</p>
<p>另外一个误区是，分页查询，依次处理。分页查询可以有效减少服务器负担，不失为一种可行的方法。但是就和上面分页说的那样，分页到后面的时候，需要skip掉前面的数据，存在无用功。稍微好一点的做法就是按照之前说的，将skip转换为condtion，这种方式效率OK，但不推荐，存在代码冗余。</p>
<pre><code>            Page&lt;Thing&gt; dataList = entityDao.findAllByPage(kgDataStoreService.getKgCollectionByKgInstance(kg), page);
            Map&lt;String, Individual&gt; thingId2Resource = new ConcurrentHashMap&lt;&gt;();

            appendThingsToModel(model, concept2OntClass, hot, alias, dataList, thingId2Resource);

            while (dataList.hasNext()) &#123;
                page = PageRequest.of(page.getPageNumber() + 1, page.getPageSize());
                dataList = entityDao.findAllByPage(kgDataStoreService.getKgCollectionByKgInstance(kg), page);
                appendThingsToModel(model, concept2OntClass, hot, alias, dataList, thingId2Resource);
            &#125;
</code></pre>
<p>更推荐的做法是，采用mongoTemplate的steam方法,返回<code>CloseableIterator</code>迭代器，读一条数据处理一条数据，实现高效处理：</p>
<pre><code>@Overridepublic &lt;T&gt; CloseableIterator&lt;T&gt; stream(final Query query, final Class&lt;T&gt; entityType, final String collectionName) &#123;    return doStream(query, entityType, collectionName, entityType);&#125;
</code></pre>
<p>改用方法后，代码可以更简化高效：</p>
<pre><code>  CloseableIterator&lt;Thing&gt; dataList = kgDataStoreService.getSimpleInfoIterator(kg);

            // 实体导入
            // Page&lt;Thing&gt; dataList = entityDao.findAllByPage(kgDataStoreService.getKgCollectionByKgInstance(kg), page);
            Map&lt;String, Individual&gt; thingId2Resource = new ConcurrentHashMap&lt;&gt;();

            appendThingsToModel(model, concept2OntClass, hot, alias, dataList, thingId2Resource);
</code></pre>
<p>待续。。。</p>
<hr>
<blockquote>
<p>作者：Jadepeng<br> 出处：jqpeng的技术记事本–<a target="_blank" rel="noopener" href="http://www.cnblogs.com/xiaoqi">http://www.cnblogs.com/xiaoqi</a><br> 您的支持是对博主最大的鼓励，感谢您的认真阅读。<br> 本文版权归作者所有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文连接，否则保留追究法律责任的权利。</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.iflyresearch.com/2019/05/24/jqpeng-%E5%A4%9A%E8%AF%AD%E8%A8%80%E4%B8%9A%E5%8A%A1%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E7%9B%91%E6%8E%A7%E5%B7%A5%E5%85%B7Sentry%20%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/jadepeng/images/avatar.gif">
      <meta itemprop="name" content="JadePeng">
      <meta itemprop="description" content="JadePeng的技术笔记本">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JadePeng的技术笔记本">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/jadepeng/2019/05/24/jqpeng-%E5%A4%9A%E8%AF%AD%E8%A8%80%E4%B8%9A%E5%8A%A1%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E7%9B%91%E6%8E%A7%E5%B7%A5%E5%85%B7Sentry%20%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">多语言业务错误日志收集监控工具Sentry 安装与使用</a>
        </h2>

        <div class="post-meta">

         
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-05-24 16:04:00" itemprop="dateCreated datePublished" datetime="2019-05-24T16:04:00+08:00">2019-05-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 18:09:47" itemprop="dateModified" datetime="2021-05-14T18:09:47+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/jadepeng/categories/%E5%8D%9A%E5%AE%A2/" itemprop="url" rel="index"><span itemprop="name">博客</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/jadepeng/categories/%E5%8D%9A%E5%AE%A2/jqpeng/" itemprop="url" rel="index"><span itemprop="name">jqpeng</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>4.6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>文章作者:jqpeng<br>原文链接: <a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaoqi/p/sentry.html">多语言业务错误日志收集监控工具Sentry 安装与使用</a></p>
<p>Sentry 是一个实时事件日志记录和汇集的平台。其专注于错误监控以及提取一切事后处理所需信息而不依赖于麻烦的用户反馈。</p>
<p>Sentry是一个日志平台, 它分为客户端和服务端，客户端(目前客户端有Python, PHP,C#, Ruby等多种语言)就嵌入在你的应用程序中间，程序出现异常就向服务端发送消息，服务端将消息记录到数据库中并提供一个web节目方便查看。Sentry由python编写，源码开放，性能卓越，易于扩展，目前著名的用户有Disqus, Path, mozilla, Pinterest等。</p>
<h2 id="通过docker安装"><a href="#通过docker安装" class="headerlink" title="通过docker安装"></a>通过docker安装</h2><p>官方提供了 On-Premise 安装方式</p>
<pre><code>git clone https://github.com/getsentry/onpremise
cd onpremise
</code></pre>
<p>然后创建volume，持久化存储</p>
<pre><code>docker volume create --name=sentry-data &amp;&amp; docker volume create --name=sentry-postgres
</code></pre>
<p>创建环境变量配置文件：</p>
<pre><code>cp -n .env.example .env - create env config file
</code></pre>
<p>docker-compose build镜像，这一步会拉取官方镜像和redis等依赖，耐心等待    ：</p>
<pre><code>docker-compose build - Build and tag the Docker services
</code></pre>
<p>创建secret-key，执行后得到一个key，添加到.env中的SENTRY_SECRET_KEY</p>
<pre><code>docker-compose run --rm web config generate-secret-key 
</code></pre>
<p>创建DB和初始化用户,等待创建数据库和</p>
<pre><code>docker-compose run --rm web upgrade
Created internal Sentry project (slug=internal, id=1)

Would you like to create a user account now? [Y/n]: y
Email: 
Password: 
Repeat for confirmation: 
Should this user be a superuser? [y/N]: y
Added to organization: sentry
Running migrations for sentry.nodestore:
 - Migrating forwards to 0001_initial.
</code></pre>
<p>最后-d启动，启动成功后可以访问<a target="_blank" rel="noopener" href="http://server-ip:9000/">http://server-ip:9000</a></p>
<pre><code>docker-compose up -d 
</code></pre>
<p>访问：</p>
<p><img src="https://www.github.com/jadepeng/blogpic/raw/master/images/2019/5-24/1558680516195.png" alt="sentry"></p>
<h2 id="创建项目并集成"><a href="#创建项目并集成" class="headerlink" title="创建项目并集成"></a>创建项目并集成</h2><p>先创建一个project，支持多种语言，我们创建一个java的</p>
<p><img src="https://www.github.com/jadepeng/blogpic/raw/master/images/2019/5-24/1558680561117.png" alt="create project"></p>
<h3 id="DSN（Client-Keys）"><a href="#DSN（Client-Keys）" class="headerlink" title="DSN（Client Keys）"></a>DSN（Client Keys）</h3><p>DSN格式为：</p>
<p>DSN=”<a href="https://public:private@host:port/project\_id&quot;">https://public:private@host:port/project\_id&quot;</a></p>
<p>可以在项目的setting-Client Keys（DSN）里查看。</p>
<p><img src="https://www.github.com/jadepeng/blogpic/raw/master/images/2019/5-24/1558684229783.png" alt="DSK"></p>
<p>然后根据格式拼成DSN即可。</p>
<h3 id="java项目集成"><a href="#java项目集成" class="headerlink" title="java项目集成"></a>java项目集成</h3><p>有多种集成方式：</p>
<h4 id="基本集成方式"><a href="#基本集成方式" class="headerlink" title="基本集成方式"></a>基本集成方式</h4><p>添加maven引用：</p>
<pre><code>    &lt;dependency&gt;    &lt;groupId&gt;io.sentry&lt;/groupId&gt;    &lt;artifactId&gt;sentry&lt;/artifactId&gt;    &lt;version&gt;1.7.16&lt;/version&gt;&lt;/dependency&gt;
</code></pre>
<p>然后在全局异常处理里集成：</p>
<pre><code> String dsn = &quot;http://&lt;SENTRY_PUBLIC_KEY&gt;:&lt;SENTRY_PRIVATE_KEY&gt;@host:port/&lt;PROJECT_ID&gt;&quot;;
 Sentry.init(dsn);
</code></pre>
<p>在有异常的地方：</p>
<pre><code>      try &#123;
            unsafeMethod();
        &#125; catch (Exception e) &#123;
            // This sends an exception event to Sentry using the statically stored instance
            // that was created in the ``main`` method.
            Sentry.capture(e);
        &#125;
</code></pre>
<h4 id="logback集成"><a href="#logback集成" class="headerlink" title="logback集成"></a>logback集成</h4><p>logback配置：</p>
<pre><code>&lt;configuration&gt;

  &lt;appender name=&quot;Console&quot; class=&quot;ch.qos.logback.core.ConsoleAppender&quot;&gt;
    &lt;encoder&gt;
      &lt;pattern&gt;%d&#123;HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;36&#125; - %msg%n&lt;/pattern&gt;
    &lt;/encoder&gt;
  &lt;/appender&gt;

  &lt;appender name=&quot;Sentry&quot; class=&quot;io.sentry.logback.SentryAppender&quot;&gt;
    &lt;filter class=&quot;ch.qos.logback.classic.filter.ThresholdFilter&quot;&gt;
      &lt;level&gt;WARN&lt;/level&gt;
    &lt;/filter&gt;
  &lt;/appender&gt;

  &lt;root level=&quot;DEBUG&quot;&gt;
    &lt;appender-ref ref=&quot;Console&quot; /&gt;
    &lt;appender-ref ref=&quot;Sentry&quot;/&gt;
  &lt;/root&gt;

&lt;/configuration&gt;
</code></pre>
<h4 id="spring-boot集成"><a href="#spring-boot集成" class="headerlink" title="spring-boot集成"></a>spring-boot集成</h4><p>先添加引用：</p>
<pre><code>        &lt;dependency&gt;        &lt;groupId&gt;io.sentry&lt;/groupId&gt;        &lt;artifactId&gt;sentry-spring&lt;/artifactId&gt;        &lt;version&gt;1.7.16&lt;/version&gt;    &lt;/dependency&gt;
</code></pre>
<p>在Application里集成：</p>
<pre><code>import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.EnableAutoConfiguration;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.web.servlet.ServletContextInitializer;
import org.springframework.context.annotation.Bean;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.servlet.HandlerExceptionResolver;

@Controller
@EnableAutoConfiguration
@SpringBootApplication
public class Application &#123;
    /*
    Register a HandlerExceptionResolver that sends all exceptions to Sentry
    and then defers all handling to the other HandlerExceptionResolvers.
    You should only register this is you are not using a logging integration,
    otherwise you may double report exceptions.
     */
    @Bean
    public HandlerExceptionResolver sentryExceptionResolver() &#123;
        return new io.sentry.spring.SentryExceptionResolver();
    &#125;

    /*
    Register a ServletContextInitializer that installs the SentryServletRequestListener
    so that Sentry events contain HTTP request information.
    This should only be necessary in Spring Boot applications. &quot;Classic&quot; Spring
    should automatically load the `io.sentry.servlet.SentryServletContainerInitializer`.
     */
    @Bean
    public ServletContextInitializer sentryServletContextInitializer() &#123;
        return new io.sentry.spring.SentryServletContextInitializer();
    &#125;

    @RequestMapping(&quot;/&quot;)
    @ResponseBody
    String home() &#123;
        int x = 1 / 0;

        return &quot;Hello World!&quot;;
    &#125;

    public static void main(String[] args) &#123;
        SpringApplication.run(Application.class, args);
    &#125;
&#125;
</code></pre>
<h3 id="前端项目集成"><a href="#前端项目集成" class="headerlink" title="前端项目集成"></a>前端项目集成</h3><p>前端集成更简单，引用sentry的js，然后init即可</p>
<pre><code>&lt;script src=&quot;https://browser.sentry-cdn.com/5.1.0/bundle.min.js&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;
Sentry.init(&#123; dsn: &#39;dsn&#39; &#125;);
</code></pre>
<hr>
<blockquote>
<p>作者：Jadepeng 出处：jqpeng的技术记事本–<a target="_blank" rel="noopener" href="http://www.cnblogs.com/xiaoqi">http://www.cnblogs.com/xiaoqi</a> 您的支持是对博主最大的鼓励，感谢您的认真阅读。 本文版权归作者所有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文连接，否则保留追究法律责任的权利。</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/jadepeng/page/4/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/jadepeng/">1</a><span class="space">&hellip;</span><a class="page-number" href="/jadepeng/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/jadepeng/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/jadepeng/page/10/">10</a><a class="extend next" rel="next" href="/jadepeng/page/6/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="JadePeng"
      src="/jadepeng/images/avatar.gif">
  <p class="site-author-name" itemprop="name">JadePeng</p>
  <div class="site-description" itemprop="description">JadePeng的技术笔记本</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/jadepeng/archives/">
        
          <span class="site-state-item-count">97</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/jadepeng/categories/">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/jadepeng/tags/">
          
        <span class="site-state-item-count">83</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">JadePeng</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">642k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">9:44</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/jadepeng/lib/anime.min.js"></script>
  <script src="/jadepeng/lib/velocity/velocity.min.js"></script>
  <script src="/jadepeng/lib/velocity/velocity.ui.min.js"></script>

<script src="/jadepeng/js/utils.js"></script>

<script src="/jadepeng/js/motion.js"></script>


<script src="/jadepeng/js/schemes/muse.js"></script>


<script src="/jadepeng/js/next-boot.js"></script>




  




  
<script src="/jadepeng/js/local-search.js"></script>









<script>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  let url = element.dataset.target;
  let pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  let pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  let fullURL = `/jadepeng/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script>


<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  

</body>
</html>
